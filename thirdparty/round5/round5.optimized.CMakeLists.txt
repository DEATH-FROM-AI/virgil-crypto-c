#   Copyright (C) 2015-2019 Virgil Security, Inc.
#
#   All rights reserved.
#
#   Redistribution and use in source and binary forms, with or without
#   modification, are permitted provided that the following conditions are
#   met:
#
#       (1) Redistributions of source code must retain the above copyright
#       notice, this list of conditions and the following disclaimer.
#
#       (2) Redistributions in binary form must reproduce the above copyright
#       notice, this list of conditions and the following disclaimer in
#       the documentation and/or other materials provided with the
#       distribution.
#
#       (3) Neither the name of the copyright holder nor the names of its
#       contributors may be used to endorse or promote products derived from
#       this software without specific prior written permission.
#
#   THIS SOFTWARE IS PROVIDED BY THE AUTHOR ''AS IS'' AND ANY EXPRESS OR
#   IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
#   WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
#   DISCLAIMED. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,
#   INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
#   (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
#   SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
#   HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
#   STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING
#   IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
#   POSSIBILITY OF SUCH DAMAGE.

cmake_minimum_required(VERSION 3.12 FATAL_ERROR)

project(round5-optimized VERSION 0.0.1 LANGUAGES C)

# ---------------------------------------------------------------------------
#   Options.
# ---------------------------------------------------------------------------
option(CM_CACHE "On/Off timing and cache attack countermeasures" YES)
option(SHIFT_LEFT64_CONSTANT_TIME
        "Indicate that the 64-bit shift left operator with a variable amount can be considered constant-time" OFF)

# ---------------------------------------------------------------------------
#   Helpers.
# ---------------------------------------------------------------------------
include(GNUInstallDirs)

# ---------------------------------------------------------------------------
#   Define sources.
# ---------------------------------------------------------------------------
add_library(round5-optimized)

get_filename_component(REALPATH_MATMUL_H "${CMAKE_CURRENT_LIST_DIR}/src/matmul.h" REALPATH)
get_filename_component(REALPATH_XEF_H "${CMAKE_CURRENT_LIST_DIR}/src/xef.h" REALPATH)
get_filename_component(REALPATH_A_RANDOM_H "${CMAKE_CURRENT_LIST_DIR}/src/a_random.h" REALPATH)
get_filename_component(REALPATH_R5_CPA_KEM_H "${CMAKE_CURRENT_LIST_DIR}/src/r5_cpa_kem.h" REALPATH)
get_filename_component(REALPATH_PROBE_CM_H "${CMAKE_CURRENT_LIST_DIR}/src/probe_cm.h" REALPATH)
get_filename_component(REALPATH_R5_CPA_PKE_H "${CMAKE_CURRENT_LIST_DIR}/src/r5_cpa_pke.h" REALPATH)
get_filename_component(REALPATH_A_FIXED_H "${CMAKE_CURRENT_LIST_DIR}/src/a_fixed.h" REALPATH)
get_filename_component(REALPATH_MISC_H "${CMAKE_CURRENT_LIST_DIR}/src/misc.h" REALPATH)
get_filename_component(REALPATH_R5_DEM_H "${CMAKE_CURRENT_LIST_DIR}/src/r5_dem.h" REALPATH)
get_filename_component(REALPATH_LITTLE_ENDIAN_H "${CMAKE_CURRENT_LIST_DIR}/src/little_endian.h" REALPATH)
get_filename_component(REALPATH_RNG_H "${CMAKE_CURRENT_LIST_DIR}/src/rng.h" REALPATH)
get_filename_component(REALPATH_CCA_ENCRYPT_H "${CMAKE_CURRENT_LIST_DIR}/src/cca_encrypt.h" REALPATH)
get_filename_component(REALPATH_R5_MEMORY_H "${CMAKE_CURRENT_LIST_DIR}/src/r5_memory.h" REALPATH)
get_filename_component(REALPATH_CPA_KEM_H "${CMAKE_CURRENT_LIST_DIR}/src/cpa_kem.h" REALPATH)
get_filename_component(REALPATH_SHAKE_H "${CMAKE_CURRENT_LIST_DIR}/src/shake.h" REALPATH)
get_filename_component(REALPATH_DRBG_H "${CMAKE_CURRENT_LIST_DIR}/src/drbg.h" REALPATH)
get_filename_component(REALPATH_RINGMUL_H "${CMAKE_CURRENT_LIST_DIR}/src/ringmul.h" REALPATH)
get_filename_component(REALPATH_R5_CCA_KEM_H "${CMAKE_CURRENT_LIST_DIR}/src/r5_cca_kem.h" REALPATH)
get_filename_component(REALPATH_R5_HASH_H "${CMAKE_CURRENT_LIST_DIR}/src/r5_hash.h" REALPATH)
get_filename_component(REALPATH_R5_PARAMETER_SETS_H "${CMAKE_CURRENT_LIST_DIR}/src/r5_parameter_sets.h" REALPATH)
get_filename_component(REALPATH_R5_CCA_PKE_H "${CMAKE_CURRENT_LIST_DIR}/src/r5_cca_pke.h" REALPATH)

target_sources(round5-optimized
        PRIVATE
            # Headers
            ${REALPATH_MATMUL_H}
            ${REALPATH_XEF_H}
            ${REALPATH_A_RANDOM_H}
            ${REALPATH_R5_CPA_KEM_H}
            ${REALPATH_PROBE_CM_H}
            ${REALPATH_R5_CPA_PKE_H}
            ${REALPATH_A_FIXED_H}
            ${REALPATH_MISC_H}
            ${REALPATH_R5_DEM_H}
            ${REALPATH_LITTLE_ENDIAN_H}
            ${REALPATH_RNG_H}
            ${REALPATH_CCA_ENCRYPT_H}
            ${REALPATH_R5_MEMORY_H}
            ${REALPATH_CPA_KEM_H}
            ${REALPATH_SHAKE_H}
            ${REALPATH_DRBG_H}
            ${REALPATH_RINGMUL_H}
            ${REALPATH_R5_CCA_KEM_H}
            ${REALPATH_R5_HASH_H}
            ${REALPATH_R5_PARAMETER_SETS_H}
            ${REALPATH_R5_CCA_PKE_H}

            # Sources
            ${CMAKE_CURRENT_LIST_DIR}/src/cpa_kem.c
            ${CMAKE_CURRENT_LIST_DIR}/src/shake.c
            ${CMAKE_CURRENT_LIST_DIR}/src/r5_cpa_pke_nd.c
            ${CMAKE_CURRENT_LIST_DIR}/src/r5_memory.c
            ${CMAKE_CURRENT_LIST_DIR}/src/drbg.c
            ${CMAKE_CURRENT_LIST_DIR}/src/matmul_cm.c
            ${CMAKE_CURRENT_LIST_DIR}/src/xe5_c64.c
            ${CMAKE_CURRENT_LIST_DIR}/src/xe2_c16.c
            ${CMAKE_CURRENT_LIST_DIR}/src/xef_ref.c
            ${CMAKE_CURRENT_LIST_DIR}/src/probe_cm_avx2.c
            ${CMAKE_CURRENT_LIST_DIR}/src/r5_cca_kem.c
            ${CMAKE_CURRENT_LIST_DIR}/src/ringmul.c
            ${CMAKE_CURRENT_LIST_DIR}/src/xe4_c64.c
            ${CMAKE_CURRENT_LIST_DIR}/src/r5_cca_pke.c
            ${CMAKE_CURRENT_LIST_DIR}/src/r5_hash.c
            ${CMAKE_CURRENT_LIST_DIR}/src/ringmul_cm.c
            ${CMAKE_CURRENT_LIST_DIR}/src/a_random.c
            ${CMAKE_CURRENT_LIST_DIR}/src/r5_cpa_kem.c
            ${CMAKE_CURRENT_LIST_DIR}/src/matmul.c
            ${CMAKE_CURRENT_LIST_DIR}/src/a_fixed.c
            ${CMAKE_CURRENT_LIST_DIR}/src/examples/example.c
            ${CMAKE_CURRENT_LIST_DIR}/src/probe_cm.c
            ${CMAKE_CURRENT_LIST_DIR}/src/matmul_avx2.c
            ${CMAKE_CURRENT_LIST_DIR}/src/little_endian.c
            ${CMAKE_CURRENT_LIST_DIR}/src/misc.c
            ${CMAKE_CURRENT_LIST_DIR}/src/cca_encrypt.c
            ${CMAKE_CURRENT_LIST_DIR}/src/r5_cpa_pke_n1.c
        )

if(CRYPTO_ENGINE_MBEDTLS)
    target_sources(round5-optimized PRIVATE ${CMAKE_CURRENT_LIST_DIR}/src/r5_dem_mbedtls.c)
else()
    target_sources(round5-optimized PRIVATE ${CMAKE_CURRENT_LIST_DIR}/src/r5_dem.c)
endif()

if(NIST_KAT_GENERATION)
    if(NOT CRYPTO_ENGINE_OPENSSL)
        message(FATAL_ERROR "NIST_KAT_GENERATION requires CRYPTO_ENGINE_OPENSSL to be enabled")
    endif()
    target_sources(round5-optimized PRIVATE ${CMAKE_CURRENT_LIST_DIR}/src/rng/nist_rng.c)
else()
    target_sources(round5-optimized PRIVATE ${CMAKE_CURRENT_LIST_DIR}/src/rng/shake_rng.c)
endif()

target_include_directories(round5-optimized
        PUBLIC
            $<BUILD_INTERFACE:${CMAKE_CURRENT_LIST_DIR}/src>
            $<INSTALL_INTERFACE:${CMAKE_INSTALL_INCLUDEDIR}>
        )

target_compile_features(round5-optimized PUBLIC c_std_99)

set_target_properties(round5-optimized PROPERTIES OUTPUT_NAME "round5")

# ---------------------------------------------------------------------------
#   Define definitions.
# ---------------------------------------------------------------------------
target_compile_definitions(round5-optimized PUBLIC ${ALG})

if(NIST_KAT_GENERATION)
    target_compile_definitions(round5-optimized PUBLIC NIST_KAT_GENERATION)
endif()

if(TAU)
    target_compile_definitions(round5-optimized PUBLIC ROUND5_API_TAU=${TAU})
endif()

if(TAU_LEN)
    target_compile_definitions(round5-optimized PUBLIC ROUND5_API_TAU2_LEN=${TAU2_LEN})
endif()

if(NO_OPENSSL_SHAKE)
    target_compile_definitions(round5-optimized PUBLIC NO_OPENSSL_SHAKE)
endif()

if(USE_AES_DRBG)
    target_compile_definitions(round5-optimized PUBLIC USE_AES_DRBG)
endif()

if(CM_CACHE)
    target_compile_definitions(round5-optimized PUBLIC CM_CACHE)
endif()

if(SHIFT_LEFT64_CONSTANT_TIME)
    target_compile_definitions(round5-optimized PUBLIC SHIFT_LEFT64_CONSTANT_TIME)
endif()


# ---------------------------------------------------------------------------
#   Define compilation flags.
# ---------------------------------------------------------------------------
target_compile_options(round5-optimized
        PRIVATE
            $<$<OR:$<C_COMPILER_ID:GNU>,$<C_COMPILER_ID:Clang>,$<C_COMPILER_ID:AppleClang>>:
                    -pedantic -Wall -Wextra -Wconversion -Wcast-qual -Wcast-align>
        )

target_link_libraries(round5-optimized
        PUBLIC
            XKCP::keccak
            $<$<BOOL:${CRYPTO_ENGINE_OPENSSL}>:OpenSSL::Crypto>
            $<$<BOOL:${CRYPTO_ENGINE_MBEDTLS}>:mbed::crypto>
            $<$<OR:$<C_COMPILER_ID:GNU>,$<C_COMPILER_ID:Clang>,$<C_COMPILER_ID:AppleClang>>:-lm>
        )

# ---------------------------------------------------------------------------
#   Install library.
# ---------------------------------------------------------------------------
#
# Install headers.
#

install(FILES
            "${REALPATH_MATMUL_H}"
            "${REALPATH_XEF_H}"
            "${REALPATH_A_RANDOM_H}"
            "${REALPATH_R5_CPA_KEM_H}"
            "${REALPATH_PROBE_CM_H}"
            "${REALPATH_R5_CPA_PKE_H}"
            "${REALPATH_A_FIXED_H}"
            "${REALPATH_MISC_H}"
            "${REALPATH_R5_DEM_H}"
            "${REALPATH_LITTLE_ENDIAN_H}"
            "${REALPATH_RNG_H}"
            "${REALPATH_CCA_ENCRYPT_H}"
            "${REALPATH_R5_MEMORY_H}"
            "${REALPATH_CPA_KEM_H}"
            "${REALPATH_SHAKE_H}"
            "${REALPATH_DRBG_H}"
            "${REALPATH_RINGMUL_H}"
            "${REALPATH_R5_CCA_KEM_H}"
            "${REALPATH_R5_HASH_H}"
            "${REALPATH_R5_PARAMETER_SETS_H}"
            "${REALPATH_R5_CCA_PKE_H}"
        DESTINATION
            "${CMAKE_INSTALL_INCLUDEDIR}/round5"
        )

#
# Install libraries.
#
install(
        TARGETS round5-optimized
        EXPORT round5Targets
        LIBRARY DESTINATION "${CMAKE_INSTALL_LIBDIR}"
        ARCHIVE DESTINATION "${CMAKE_INSTALL_LIBDIR}"
        FRAMEWORK DESTINATION "${CMAKE_INSTALL_LIBDIR}"
        RUNTIME DESTINATION "${CMAKE_INSTALL_BINDIR}"
        )

# ---------------------------------------------------------------------------
#   Build examples.
# ---------------------------------------------------------------------------
if(BUILD_EXAMPLES)
    add_executable(example "${CMAKE_CURRENT_LIST_DIR}/src/examples/example.c")
    target_link_libraries(example round5-optimized)

    add_executable(createAfixed "${CMAKE_CURRENT_LIST_DIR}/src/createAfixed/createAfixed.c")
    target_link_libraries(createAfixed round5-optimized)

    install(
            TARGETS example createAfixed
            RUNTIME DESTINATION "${CMAKE_INSTALL_BINDIR}"
            )
endif()

if(BUILD_SPEEDTEST)
    add_executable(speedtest)
    target_sources(speedtest
            PRIVATE
                "${CMAKE_CURRENT_LIST_DIR}/../speedtest/src/speedtest_optimized.c"
                "${CMAKE_CURRENT_LIST_DIR}/../speedtest/src/test_utils.c"
            )
    target_link_libraries(speedtest round5-optimized)

    install(
            TARGETS speedtest
            RUNTIME DESTINATION "${CMAKE_INSTALL_BINDIR}"
            )
endif()
