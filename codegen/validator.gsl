# ---------------------------------------------------------------------------
#   This file is fully generated by the script -
#   'codegen/validator/validator_gen.gsl'
# ---------------------------------------------------------------------------

gsl from "common.gsl"

function entity_dump_file(entity)
    assert_attributes(my, "entity", my)

    time.now(my.date, my.time)
    my.dump_dir = ".generated/dump"
    my.dump_filename = "$(make_id(name(my.entity)))_$(my.date)_$(my.time).xml"
    item_save_to_file(my.entity, my.dump_filename, my.dump_dir)
    return cat_path(my.dump_dir, my.dump_filename)
endfunction

function echo_fatal_required_attr(entity, attr_name)
    my.dump_filename = entity_dump_file(my.entity)
    echo_fatal("Required attribute '$(name(my.entity)).$(my.attr_name:)' is not defined. " + \
               "See dump file: $(my.dump_filename:)", my)
endfunction

function echo_fatal_resticted_attr(entity, attr_name, valid_values)
    my.dump_filename = entity_dump_file(my.entity)
    echo_fatal("Possible values of the attribute '$(name(my.entity)).$(my.attr_name:)' " + \
               "are '{$(my.valid_values:)}', " + \
               "but found $(my.entity.$(my.attr_name)). " + \
               "See dump file: $(my.dump_filename:)", my)
endfunction


# ---------------------------------------------------------------------------
function scope_setup_defaults(scope, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.scope ? "public"
    if defined(my.default_value) & !defined(my.scope.scope)
        echo_trace("       scope=\"$(my.default_value:)\"", my)
        my.scope.scope = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function scope_validate(scope, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_scope_apply ?= "1"
    my.restrictions.attr_scope_required ?= "0"

    if my.restrictions.attr_scope_apply
        echo_trace("     Validate attribute: scope=\"$(my.scope.scope?)\"", my)
    endif

    if !defined(my.scope.scope) & \
                my.restrictions.attr_scope_apply & my.restrictions.attr_scope_required
        echo_fatal_required_attr(my.scope, "scope")
    endif
    if my.restrictions.attr_scope_apply & defined(my.scope.scope)
        my.scope_is_valid = "0"
        my.scope_is_valid = my.scope_is_valid | (my.scope.scope = "public")
        my.scope_is_valid = my.scope_is_valid | (my.scope.scope = "private")
        my.scope_is_valid = my.scope_is_valid | (my.scope.scope = "internal")
        if !my.scope_is_valid
            echo_fatal_resticted_attr(my.scope, "scope", "public, private, internal")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function scope_validate_resolved(scope, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_scope_apply ?= "1"
    my.restrictions.attr_scope_required ?= "0"

    if my.restrictions.attr_scope_apply
        echo_trace("     Validate attribute: scope=\"$(my.scope.scope?)\"", my)
    endif

    if !defined(my.scope.scope) & \
                my.restrictions.attr_scope_apply & my.restrictions.attr_scope_required
        echo_fatal_required_attr(my.scope, "scope")
    endif
    if my.restrictions.attr_scope_apply & defined(my.scope.scope)
        my.scope_is_valid = "0"
        my.scope_is_valid = my.scope_is_valid | (my.scope.scope = "public")
        my.scope_is_valid = my.scope_is_valid | (my.scope.scope = "private")
        my.scope_is_valid = my.scope_is_valid | (my.scope.scope = "internal")
        if !my.scope_is_valid
            echo_fatal_resticted_attr(my.scope, "scope", "public, private, internal")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_prefix_setup_defaults(c_prefix, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.c_prefix ?
    if defined(my.default_value) & !defined(my.c_prefix.c_prefix)
        echo_trace("       c_prefix=\"$(my.default_value:)\"", my)
        my.c_prefix.c_prefix = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_prefix_validate(c_prefix, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_c_prefix_apply ?= "1"
    my.restrictions.attr_c_prefix_required ?= "0"

    if my.restrictions.attr_c_prefix_apply
        echo_trace("     Validate attribute: c_prefix=\"$(my.c_prefix.c_prefix?)\"", my)
    endif

    if !defined(my.c_prefix.c_prefix) & \
                my.restrictions.attr_c_prefix_apply & my.restrictions.attr_c_prefix_required
        echo_fatal_required_attr(my.c_prefix, "c_prefix")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_prefix_validate_resolved(c_prefix, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_c_prefix_apply ?= "1"
    my.restrictions.attr_c_prefix_required ?= "0"

    if my.restrictions.attr_c_prefix_apply
        echo_trace("     Validate attribute: c_prefix=\"$(my.c_prefix.c_prefix?)\"", my)
    endif

    if !defined(my.c_prefix.c_prefix) & \
                my.restrictions.attr_c_prefix_apply & my.restrictions.attr_c_prefix_required
        echo_fatal_required_attr(my.c_prefix, "c_prefix")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function ancestor_setup_defaults(ancestor, defaults)
    my.ancestor_name = defined(my.ancestor.name) ?? " name=\"$(my.ancestor.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.ancestor))$(my.ancestor_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.id ?
    if defined(my.default_value) & !defined(my.ancestor.id)
        echo_trace("       id=\"$(my.default_value:)\"", my)
        my.ancestor.id = my.default_value
    endif

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.ancestor.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.ancestor.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function ancestor_validate(ancestor, restrictions)
    my.ancestor_name = defined(my.ancestor.name) ?? " name=\"$(my.ancestor.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.ancestor))$(my.ancestor_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_id_apply ?= "1"
    my.restrictions.attr_id_required ?= "1"

    if my.restrictions.attr_id_apply
        echo_trace("     Validate attribute: id=\"$(my.ancestor.id?)\"", my)
    endif

    if !defined(my.ancestor.id) & \
                my.restrictions.attr_id_apply & my.restrictions.attr_id_required
        echo_fatal_required_attr(my.ancestor, "id")
    endif

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.ancestor.name?)\"", my)
    endif

    if !defined(my.ancestor.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.ancestor, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function ancestor_validate_resolved(ancestor, restrictions)
    my.ancestor_name = defined(my.ancestor.name) ?? " name=\"$(my.ancestor.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.ancestor))$(my.ancestor_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_id_apply ?= "1"
    my.restrictions.attr_id_required ?= "1"

    if my.restrictions.attr_id_apply
        echo_trace("     Validate attribute: id=\"$(my.ancestor.id?)\"", my)
    endif

    if !defined(my.ancestor.id) & \
                my.restrictions.attr_id_apply & my.restrictions.attr_id_required
        echo_fatal_required_attr(my.ancestor, "id")
    endif

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.ancestor.name?)\"", my)
    endif

    if !defined(my.ancestor.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.ancestor, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function lineage_setup_defaults(lineage, defaults)
    my.lineage_name = defined(my.lineage.name) ?? " name=\"$(my.lineage.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.lineage))$(my.lineage_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for allowed entities
    for my.lineage.ancestor as _ancestor
        ancestor_setup_defaults(_ancestor)
    endfor

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function lineage_validate(lineage, restrictions)
    my.lineage_name = defined(my.lineage.name) ?? " name=\"$(my.lineage.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.lineage))$(my.lineage_name)/>", my)

    #    Check allowed entities
    my.ancestor_count = count(my.lineage.ancestor)
    if my.ancestor_count < 1
        my.dump_filename = entity_dump_file(my.lineage)
        echo_fatal("Expected one or more entities: ancestor.\n" + \
                   "But found $(my.ancestor_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.lineage.ancestor as _ancestor
        new restrictions
            ancestor_validate(_ancestor, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function lineage_validate_resolved(lineage, restrictions)
    my.lineage_name = defined(my.lineage.name) ?? " name=\"$(my.lineage.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.lineage))$(my.lineage_name)/>", my)

    #    Check allowed entities
    for my.lineage.ancestor as _ancestor
        new restrictions
            ancestor_validate_resolved(_ancestor, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function uid_setup_defaults(uid, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for allowed entities
    for my.uid.lineage as _lineage
        lineage_setup_defaults(_lineage)
    endfor

    my.default_value = my.defaults.uid ?
    if defined(my.default_value) & !defined(my.uid.uid)
        echo_trace("       uid=\"$(my.default_value:)\"", my)
        my.uid.uid = my.default_value
    endif

    my.default_value = my.defaults.full_uid ?
    if defined(my.default_value) & !defined(my.uid.full_uid)
        echo_trace("       full_uid=\"$(my.default_value:)\"", my)
        my.uid.full_uid = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function uid_validate(uid, restrictions)

    #    Check allowed entities
    for my.uid.lineage as _lineage
        new restrictions
            lineage_validate(_lineage, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function uid_validate_resolved(uid, restrictions)

    #    Check allowed entities
    my.lineage_count = count(my.uid.lineage)
    if my.lineage_count <> 1
        my.dump_filename = entity_dump_file(my.uid)
        echo_fatal("Expected exectly one entity: lineage.\n" + \
                   "But found $(my.lineage_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.uid.lineage as _lineage
        new restrictions
            lineage_validate_resolved(_lineage, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_uid_apply ?= "1"
    my.restrictions.attr_uid_required ?= "0"

    if my.restrictions.attr_uid_apply
        echo_trace("     Validate attribute: uid=\"$(my.uid.uid?)\"", my)
    endif

    if !defined(my.uid.uid) & \
                my.restrictions.attr_uid_apply & my.restrictions.attr_uid_required
        echo_fatal_required_attr(my.uid, "uid")
    endif

    my.restrictions.attr_full_uid_apply ?= "1"
    my.restrictions.attr_full_uid_required ?= "0"

    if my.restrictions.attr_full_uid_apply
        echo_trace("     Validate attribute: full_uid=\"$(my.uid.full_uid?)\"", my)
    endif

    if !defined(my.uid.full_uid) & \
                my.restrictions.attr_full_uid_apply & my.restrictions.attr_full_uid_required
        echo_fatal_required_attr(my.uid, "full_uid")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function visibility_setup_defaults(visibility, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.visibility ? "public"
    if defined(my.default_value) & !defined(my.visibility.visibility)
        echo_trace("       visibility=\"$(my.default_value:)\"", my)
        my.visibility.visibility = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function visibility_validate(visibility, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_visibility_apply ?= "1"
    my.restrictions.attr_visibility_required ?= "0"

    if my.restrictions.attr_visibility_apply
        echo_trace("     Validate attribute: visibility=\"$(my.visibility.visibility?)\"", my)
    endif

    if !defined(my.visibility.visibility) & \
                my.restrictions.attr_visibility_apply & my.restrictions.attr_visibility_required
        echo_fatal_required_attr(my.visibility, "visibility")
    endif
    if my.restrictions.attr_visibility_apply & defined(my.visibility.visibility)
        my.visibility_is_valid = "0"
        my.visibility_is_valid = my.visibility_is_valid | (my.visibility.visibility = "public")
        my.visibility_is_valid = my.visibility_is_valid | (my.visibility.visibility = "private")
        if !my.visibility_is_valid
            echo_fatal_resticted_attr(my.visibility, "visibility", "public, private")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function visibility_validate_resolved(visibility, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_visibility_apply ?= "1"
    my.restrictions.attr_visibility_required ?= "0"

    if my.restrictions.attr_visibility_apply
        echo_trace("     Validate attribute: visibility=\"$(my.visibility.visibility?)\"", my)
    endif

    if !defined(my.visibility.visibility) & \
                my.restrictions.attr_visibility_apply & my.restrictions.attr_visibility_required
        echo_fatal_required_attr(my.visibility, "visibility")
    endif
    if my.restrictions.attr_visibility_apply & defined(my.visibility.visibility)
        my.visibility_is_valid = "0"
        my.visibility_is_valid = my.visibility_is_valid | (my.visibility.visibility = "public")
        my.visibility_is_valid = my.visibility_is_valid | (my.visibility.visibility = "private")
        if !my.visibility_is_valid
            echo_fatal_resticted_attr(my.visibility, "visibility", "public, private")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function landlord_setup_defaults(landlord, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.project ?
    if defined(my.default_value) & !defined(my.landlord.project)
        echo_trace("       project=\"$(my.default_value:)\"", my)
        my.landlord.project = my.default_value
    endif

    my.default_value = my.defaults.library ?
    if defined(my.default_value) & !defined(my.landlord.library)
        echo_trace("       library=\"$(my.default_value:)\"", my)
        my.landlord.library = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function landlord_validate(landlord, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_project_apply ?= "1"
    my.restrictions.attr_project_required ?= "0"

    if my.restrictions.attr_project_apply
        echo_trace("     Validate attribute: project=\"$(my.landlord.project?)\"", my)
    endif

    if !defined(my.landlord.project) & \
                my.restrictions.attr_project_apply & my.restrictions.attr_project_required
        echo_fatal_required_attr(my.landlord, "project")
    endif

    my.restrictions.attr_library_apply ?= "1"
    my.restrictions.attr_library_required ?= "0"

    if my.restrictions.attr_library_apply
        echo_trace("     Validate attribute: library=\"$(my.landlord.library?)\"", my)
    endif

    if !defined(my.landlord.library) & \
                my.restrictions.attr_library_apply & my.restrictions.attr_library_required
        echo_fatal_required_attr(my.landlord, "library")
    endif

    echo_trace("     Validate one of: {project, library}", my)
    my.landlord_found_attrs = ""
    my.landlord_found_attrs_count = "0"

    if defined(my.landlord.project)
        my.landlord_found_attrs_count += 1
        if my.landlord_found_attrs <> ""
            my.landlord_found_attrs += ", "
        endif
        my.landlord_found_attrs += "project"
    endif

    if defined(my.landlord.library)
        my.landlord_found_attrs_count += 1
        if my.landlord_found_attrs <> ""
            my.landlord_found_attrs += ", "
        endif
        my.landlord_found_attrs += "library"
    endif

    my.restrictions.oneof_landlord_apply ?= "1"
    my.restrictions.oneof_landlord_required ?= "0"

    if my.restrictions.oneof_landlord_apply &   my.restrictions.oneof_landlord_required &    my.landlord_found_attrs_count = "0"
        my.dump_filename = entity_dump_file(my.landlord)
        echo_fatal("Expected one of the attributes {project, library}.\n" + \
                   "But found nothing.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

    if my.landlord_found_attrs_count > "1"
        my.dump_filename = entity_dump_file(my.landlord)
        echo_fatal("Expected one of the attributes {project, library}.\n" + \
                   "But found several {$(my.landlord_found_attrs:)}.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function landlord_validate_resolved(landlord, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_project_apply ?= "1"
    my.restrictions.attr_project_required ?= "0"

    if my.restrictions.attr_project_apply
        echo_trace("     Validate attribute: project=\"$(my.landlord.project?)\"", my)
    endif

    if !defined(my.landlord.project) & \
                my.restrictions.attr_project_apply & my.restrictions.attr_project_required
        echo_fatal_required_attr(my.landlord, "project")
    endif

    my.restrictions.attr_library_apply ?= "1"
    my.restrictions.attr_library_required ?= "0"

    if my.restrictions.attr_library_apply
        echo_trace("     Validate attribute: library=\"$(my.landlord.library?)\"", my)
    endif

    if !defined(my.landlord.library) & \
                my.restrictions.attr_library_apply & my.restrictions.attr_library_required
        echo_fatal_required_attr(my.landlord, "library")
    endif

    echo_trace("     Validate one of: {project, library}", my)
    my.landlord_found_attrs = ""
    my.landlord_found_attrs_count = "0"

    if defined(my.landlord.project)
        my.landlord_found_attrs_count += 1
        if my.landlord_found_attrs <> ""
            my.landlord_found_attrs += ", "
        endif
        my.landlord_found_attrs += "project"
    endif

    if defined(my.landlord.library)
        my.landlord_found_attrs_count += 1
        if my.landlord_found_attrs <> ""
            my.landlord_found_attrs += ", "
        endif
        my.landlord_found_attrs += "library"
    endif

    my.restrictions.oneof_landlord_apply ?= "1"
    my.restrictions.oneof_landlord_required ?= "0"

    if my.restrictions.oneof_landlord_apply &   my.restrictions.oneof_landlord_required &    my.landlord_found_attrs_count = "0"
        my.dump_filename = entity_dump_file(my.landlord)
        echo_fatal("Expected one of the attributes {project, library}.\n" + \
                   "But found nothing.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

    if my.landlord_found_attrs_count > "1"
        my.dump_filename = entity_dump_file(my.landlord)
        echo_fatal("Expected one of the attributes {project, library}.\n" + \
                   "But found several {$(my.landlord_found_attrs:)}.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function require_scope_setup_defaults(require_scope, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.scope ? "private"
    if defined(my.default_value) & !defined(my.require_scope.scope)
        echo_trace("       scope=\"$(my.default_value:)\"", my)
        my.require_scope.scope = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function require_scope_validate(require_scope, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_scope_apply ?= "1"
    my.restrictions.attr_scope_required ?= "0"

    if my.restrictions.attr_scope_apply
        echo_trace("     Validate attribute: scope=\"$(my.require_scope.scope?)\"", my)
    endif

    if !defined(my.require_scope.scope) & \
                my.restrictions.attr_scope_apply & my.restrictions.attr_scope_required
        echo_fatal_required_attr(my.require_scope, "scope")
    endif
    if my.restrictions.attr_scope_apply & defined(my.require_scope.scope)
        my.scope_is_valid = "0"
        my.scope_is_valid = my.scope_is_valid | (my.require_scope.scope = "public")
        my.scope_is_valid = my.scope_is_valid | (my.require_scope.scope = "private")
        my.scope_is_valid = my.scope_is_valid | (my.require_scope.scope = "context")
        if !my.scope_is_valid
            echo_fatal_resticted_attr(my.require_scope, "scope", "public, private, context")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function require_scope_validate_resolved(require_scope, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_scope_apply ?= "1"
    my.restrictions.attr_scope_required ?= "0"

    if my.restrictions.attr_scope_apply
        echo_trace("     Validate attribute: scope=\"$(my.require_scope.scope?)\"", my)
    endif

    if !defined(my.require_scope.scope) & \
                my.restrictions.attr_scope_apply & my.restrictions.attr_scope_required
        echo_fatal_required_attr(my.require_scope, "scope")
    endif
    if my.restrictions.attr_scope_apply & defined(my.require_scope.scope)
        my.scope_is_valid = "0"
        my.scope_is_valid = my.scope_is_valid | (my.require_scope.scope = "public")
        my.scope_is_valid = my.scope_is_valid | (my.require_scope.scope = "private")
        my.scope_is_valid = my.scope_is_valid | (my.require_scope.scope = "context")
        if !my.scope_is_valid
            echo_fatal_resticted_attr(my.require_scope, "scope", "public, private, context")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function require_base_setup_defaults(require_base, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    landlord_setup_defaults(my.require_base, my.defaults)
    require_scope_setup_defaults(my.require_base, my.defaults)

    my.default_value = my.defaults.module ?
    if defined(my.default_value) & !defined(my.require_base.module)
        echo_trace("       module=\"$(my.default_value:)\"", my)
        my.require_base.module = my.default_value
    endif

    my.default_value = my.defaults.header ?
    if defined(my.default_value) & !defined(my.require_base.header)
        echo_trace("       header=\"$(my.default_value:)\"", my)
        my.require_base.header = my.default_value
    endif

    my.default_value = my.defaults.feature ?
    if defined(my.default_value) & !defined(my.require_base.feature)
        echo_trace("       feature=\"$(my.default_value:)\"", my)
        my.require_base.feature = my.default_value
    endif

    my.default_value = my.defaults.interface ?
    if defined(my.default_value) & !defined(my.require_base.interface)
        echo_trace("       interface=\"$(my.default_value:)\"", my)
        my.require_base.interface = my.default_value
    endif

    my.default_value = my.defaults.class ?
    if defined(my.default_value) & !defined(my.require_base.class)
        echo_trace("       class=\"$(my.default_value:)\"", my)
        my.require_base.class = my.default_value
    endif

    my.default_value = my.defaults.impl ?
    if defined(my.default_value) & !defined(my.require_base.impl)
        echo_trace("       impl=\"$(my.default_value:)\"", my)
        my.require_base.impl = my.default_value
    endif

    my.default_value = my.defaults.enum ?
    if defined(my.default_value) & !defined(my.require_base.enum)
        echo_trace("       enum=\"$(my.default_value:)\"", my)
        my.require_base.enum = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function require_base_validate(require_base, restrictions)

    #    Check inherited attributes and entities
    new restrictions
        landlord_validate(my.require_base, restrictions)
    endnew

    new restrictions
        require_scope_validate(my.require_base, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_module_apply ?= "1"
    my.restrictions.attr_module_required ?= "0"

    if my.restrictions.attr_module_apply
        echo_trace("     Validate attribute: module=\"$(my.require_base.module?)\"", my)
    endif

    if !defined(my.require_base.module) & \
                my.restrictions.attr_module_apply & my.restrictions.attr_module_required
        echo_fatal_required_attr(my.require_base, "module")
    endif

    my.restrictions.attr_header_apply ?= "1"
    my.restrictions.attr_header_required ?= "0"

    if my.restrictions.attr_header_apply
        echo_trace("     Validate attribute: header=\"$(my.require_base.header?)\"", my)
    endif

    if !defined(my.require_base.header) & \
                my.restrictions.attr_header_apply & my.restrictions.attr_header_required
        echo_fatal_required_attr(my.require_base, "header")
    endif

    my.restrictions.attr_feature_apply ?= "1"
    my.restrictions.attr_feature_required ?= "0"

    if my.restrictions.attr_feature_apply
        echo_trace("     Validate attribute: feature=\"$(my.require_base.feature?)\"", my)
    endif

    if !defined(my.require_base.feature) & \
                my.restrictions.attr_feature_apply & my.restrictions.attr_feature_required
        echo_fatal_required_attr(my.require_base, "feature")
    endif

    my.restrictions.attr_interface_apply ?= "1"
    my.restrictions.attr_interface_required ?= "0"

    if my.restrictions.attr_interface_apply
        echo_trace("     Validate attribute: interface=\"$(my.require_base.interface?)\"", my)
    endif

    if !defined(my.require_base.interface) & \
                my.restrictions.attr_interface_apply & my.restrictions.attr_interface_required
        echo_fatal_required_attr(my.require_base, "interface")
    endif

    my.restrictions.attr_class_apply ?= "1"
    my.restrictions.attr_class_required ?= "0"

    if my.restrictions.attr_class_apply
        echo_trace("     Validate attribute: class=\"$(my.require_base.class?)\"", my)
    endif

    if !defined(my.require_base.class) & \
                my.restrictions.attr_class_apply & my.restrictions.attr_class_required
        echo_fatal_required_attr(my.require_base, "class")
    endif

    my.restrictions.attr_impl_apply ?= "1"
    my.restrictions.attr_impl_required ?= "0"

    if my.restrictions.attr_impl_apply
        echo_trace("     Validate attribute: impl=\"$(my.require_base.impl?)\"", my)
    endif

    if !defined(my.require_base.impl) & \
                my.restrictions.attr_impl_apply & my.restrictions.attr_impl_required
        echo_fatal_required_attr(my.require_base, "impl")
    endif

    my.restrictions.attr_enum_apply ?= "1"
    my.restrictions.attr_enum_required ?= "0"

    if my.restrictions.attr_enum_apply
        echo_trace("     Validate attribute: enum=\"$(my.require_base.enum?)\"", my)
    endif

    if !defined(my.require_base.enum) & \
                my.restrictions.attr_enum_apply & my.restrictions.attr_enum_required
        echo_fatal_required_attr(my.require_base, "enum")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function require_base_validate_resolved(require_base, restrictions)

    #    Check inherited attributes and entities
    new restrictions
        landlord_validate_resolved(my.require_base, restrictions)
    endnew

    new restrictions
        require_scope_validate_resolved(my.require_base, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_module_apply ?= "1"
    my.restrictions.attr_module_required ?= "0"

    if my.restrictions.attr_module_apply
        echo_trace("     Validate attribute: module=\"$(my.require_base.module?)\"", my)
    endif

    if !defined(my.require_base.module) & \
                my.restrictions.attr_module_apply & my.restrictions.attr_module_required
        echo_fatal_required_attr(my.require_base, "module")
    endif

    my.restrictions.attr_header_apply ?= "1"
    my.restrictions.attr_header_required ?= "0"

    if my.restrictions.attr_header_apply
        echo_trace("     Validate attribute: header=\"$(my.require_base.header?)\"", my)
    endif

    if !defined(my.require_base.header) & \
                my.restrictions.attr_header_apply & my.restrictions.attr_header_required
        echo_fatal_required_attr(my.require_base, "header")
    endif

    my.restrictions.attr_feature_apply ?= "1"
    my.restrictions.attr_feature_required ?= "0"

    if my.restrictions.attr_feature_apply
        echo_trace("     Validate attribute: feature=\"$(my.require_base.feature?)\"", my)
    endif

    if !defined(my.require_base.feature) & \
                my.restrictions.attr_feature_apply & my.restrictions.attr_feature_required
        echo_fatal_required_attr(my.require_base, "feature")
    endif

    my.restrictions.attr_interface_apply ?= "1"
    my.restrictions.attr_interface_required ?= "0"

    if my.restrictions.attr_interface_apply
        echo_trace("     Validate attribute: interface=\"$(my.require_base.interface?)\"", my)
    endif

    if !defined(my.require_base.interface) & \
                my.restrictions.attr_interface_apply & my.restrictions.attr_interface_required
        echo_fatal_required_attr(my.require_base, "interface")
    endif

    my.restrictions.attr_class_apply ?= "1"
    my.restrictions.attr_class_required ?= "0"

    if my.restrictions.attr_class_apply
        echo_trace("     Validate attribute: class=\"$(my.require_base.class?)\"", my)
    endif

    if !defined(my.require_base.class) & \
                my.restrictions.attr_class_apply & my.restrictions.attr_class_required
        echo_fatal_required_attr(my.require_base, "class")
    endif

    my.restrictions.attr_impl_apply ?= "1"
    my.restrictions.attr_impl_required ?= "0"

    if my.restrictions.attr_impl_apply
        echo_trace("     Validate attribute: impl=\"$(my.require_base.impl?)\"", my)
    endif

    if !defined(my.require_base.impl) & \
                my.restrictions.attr_impl_apply & my.restrictions.attr_impl_required
        echo_fatal_required_attr(my.require_base, "impl")
    endif

    my.restrictions.attr_enum_apply ?= "1"
    my.restrictions.attr_enum_required ?= "0"

    if my.restrictions.attr_enum_apply
        echo_trace("     Validate attribute: enum=\"$(my.require_base.enum?)\"", my)
    endif

    if !defined(my.require_base.enum) & \
                my.restrictions.attr_enum_apply & my.restrictions.attr_enum_required
        echo_fatal_required_attr(my.require_base, "enum")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function alternative_setup_defaults(alternative, defaults)
    my.alternative_name = defined(my.alternative.name) ?? " name=\"$(my.alternative.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.alternative))$(my.alternative_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    require_base_setup_defaults(my.alternative, my.defaults)

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function alternative_validate(alternative, restrictions)
    my.alternative_name = defined(my.alternative.name) ?? " name=\"$(my.alternative.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.alternative))$(my.alternative_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        require_base_validate(my.alternative, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function alternative_validate_resolved(alternative, restrictions)
    my.alternative_name = defined(my.alternative.name) ?? " name=\"$(my.alternative.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.alternative))$(my.alternative_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        require_base_validate_resolved(my.alternative, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function require_setup_defaults(require, defaults)
    my.require_name = defined(my.require.name) ?? " name=\"$(my.require.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.require))$(my.require_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    require_base_setup_defaults(my.require, my.defaults)

    #    Setup defaults for allowed entities
    for my.require.alternative as _alternative
        alternative_setup_defaults(_alternative)
    endfor

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function require_validate(require, restrictions)
    my.require_name = defined(my.require.name) ?? " name=\"$(my.require.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.require))$(my.require_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        require_base_validate(my.require, restrictions)
    endnew

    #    Check allowed entities
    my.alternative_count = count(my.require.alternative)
    for my.require.alternative as _alternative
        new restrictions
            alternative_validate(_alternative, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function require_validate_resolved(require, restrictions)
    my.require_name = defined(my.require.name) ?? " name=\"$(my.require.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.require))$(my.require_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        require_base_validate_resolved(my.require, restrictions)
    endnew

    #    Check allowed entities
    for my.require.alternative as _alternative
        new restrictions
            alternative_validate_resolved(_alternative, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function access_setup_defaults(access, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.access ?
    if defined(my.default_value) & !defined(my.access.access)
        echo_trace("       access=\"$(my.default_value:)\"", my)
        my.access.access = my.default_value
    endif

    my.default_value = my.defaults.ownership ?
    if defined(my.default_value) & !defined(my.access.ownership)
        echo_trace("       ownership=\"$(my.default_value:)\"", my)
        my.access.ownership = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function access_validate(access, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_access_apply ?= "1"
    my.restrictions.attr_access_required ?= "0"

    if my.restrictions.attr_access_apply
        echo_trace("     Validate attribute: access=\"$(my.access.access?)\"", my)
    endif

    if !defined(my.access.access) & \
                my.restrictions.attr_access_apply & my.restrictions.attr_access_required
        echo_fatal_required_attr(my.access, "access")
    endif
    if my.restrictions.attr_access_apply & defined(my.access.access)
        my.access_is_valid = "0"
        my.access_is_valid = my.access_is_valid | (my.access.access = "readonly")
        my.access_is_valid = my.access_is_valid | (my.access.access = "writeonly")
        my.access_is_valid = my.access_is_valid | (my.access.access = "readwrite")
        my.access_is_valid = my.access_is_valid | (my.access.access = "disown")
        my.access_is_valid = my.access_is_valid | (my.access.access = "retain")
        if !my.access_is_valid
            echo_fatal_resticted_attr(my.access, "access", "readonly, writeonly, readwrite, disown, retain")
        endif
    endif

    my.restrictions.attr_ownership_apply ?= "1"
    my.restrictions.attr_ownership_required ?= "0"

    if my.restrictions.attr_ownership_apply
        echo_trace("     Validate attribute: ownership=\"$(my.access.ownership?)\"", my)
    endif

    if !defined(my.access.ownership) & \
                my.restrictions.attr_ownership_apply & my.restrictions.attr_ownership_required
        echo_fatal_required_attr(my.access, "ownership")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function access_validate_resolved(access, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_access_apply ?= "1"
    my.restrictions.attr_access_required ?= "0"

    if my.restrictions.attr_access_apply
        echo_trace("     Validate attribute: access=\"$(my.access.access?)\"", my)
    endif

    if !defined(my.access.access) & \
                my.restrictions.attr_access_apply & my.restrictions.attr_access_required
        echo_fatal_required_attr(my.access, "access")
    endif
    if my.restrictions.attr_access_apply & defined(my.access.access)
        my.access_is_valid = "0"
        my.access_is_valid = my.access_is_valid | (my.access.access = "readonly")
        my.access_is_valid = my.access_is_valid | (my.access.access = "writeonly")
        my.access_is_valid = my.access_is_valid | (my.access.access = "readwrite")
        my.access_is_valid = my.access_is_valid | (my.access.access = "disown")
        my.access_is_valid = my.access_is_valid | (my.access.access = "retain")
        if !my.access_is_valid
            echo_fatal_resticted_attr(my.access, "access", "readonly, writeonly, readwrite, disown, retain")
        endif
    endif

    my.restrictions.attr_ownership_apply ?= "1"
    my.restrictions.attr_ownership_required ?= "0"

    if my.restrictions.attr_ownership_apply
        echo_trace("     Validate attribute: ownership=\"$(my.access.ownership?)\"", my)
    endif

    if !defined(my.access.ownership) & \
                my.restrictions.attr_ownership_apply & my.restrictions.attr_ownership_required
        echo_fatal_required_attr(my.access, "ownership")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function string_setup_defaults(string, defaults)
    my.string_name = defined(my.string.name) ?? " name=\"$(my.string.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.string))$(my.string_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    access_setup_defaults(my.string, my.defaults)

    my.default_value = my.defaults.length ? "null_terminated"
    if defined(my.default_value) & !defined(my.string.length)
        echo_trace("       length=\"$(my.default_value:)\"", my)
        my.string.length = my.default_value
    endif

    my.default_value = my.defaults.length_constant ?
    if defined(my.default_value) & !defined(my.string.length_constant)
        echo_trace("       length_constant=\"$(my.default_value:)\"", my)
        my.string.length_constant = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function string_validate(string, restrictions)
    my.string_name = defined(my.string.name) ?? " name=\"$(my.string.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.string))$(my.string_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        access_validate(my.string, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_length_apply ?= "1"
    my.restrictions.attr_length_required ?= "0"

    if my.restrictions.attr_length_apply
        echo_trace("     Validate attribute: length=\"$(my.string.length?)\"", my)
    endif

    if !defined(my.string.length) & \
                my.restrictions.attr_length_apply & my.restrictions.attr_length_required
        echo_fatal_required_attr(my.string, "length")
    endif
    if my.restrictions.attr_length_apply & defined(my.string.length)
        my.length_is_valid = "0"
        my.length_is_valid = my.length_is_valid | (my.string.length = "null_terminated")
        my.length_is_valid = my.length_is_valid | (my.string.length = "given")
        my.length_is_valid = my.length_is_valid | (my.string.length = "fixed")
        my.length_is_valid = my.length_is_valid | (my.string.length = "derived")
        if !my.length_is_valid
            echo_fatal_resticted_attr(my.string, "length", "null_terminated, given, fixed, derived")
        endif
    endif

    my.restrictions.attr_length_constant_apply ?= "1"
    my.restrictions.attr_length_constant_required ?= "0"

    if my.restrictions.attr_length_constant_apply
        echo_trace("     Validate attribute: length_constant=\"$(my.string.length_constant?)\"", my)
    endif

    if !defined(my.string.length_constant) & \
                my.restrictions.attr_length_constant_apply & my.restrictions.attr_length_constant_required
        echo_fatal_required_attr(my.string, "length_constant")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function string_validate_resolved(string, restrictions)
    my.string_name = defined(my.string.name) ?? " name=\"$(my.string.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.string))$(my.string_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        access_validate_resolved(my.string, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_length_apply ?= "1"
    my.restrictions.attr_length_required ?= "0"

    if my.restrictions.attr_length_apply
        echo_trace("     Validate attribute: length=\"$(my.string.length?)\"", my)
    endif

    if !defined(my.string.length) & \
                my.restrictions.attr_length_apply & my.restrictions.attr_length_required
        echo_fatal_required_attr(my.string, "length")
    endif
    if my.restrictions.attr_length_apply & defined(my.string.length)
        my.length_is_valid = "0"
        my.length_is_valid = my.length_is_valid | (my.string.length = "null_terminated")
        my.length_is_valid = my.length_is_valid | (my.string.length = "given")
        my.length_is_valid = my.length_is_valid | (my.string.length = "fixed")
        my.length_is_valid = my.length_is_valid | (my.string.length = "derived")
        if !my.length_is_valid
            echo_fatal_resticted_attr(my.string, "length", "null_terminated, given, fixed, derived")
        endif
    endif

    my.restrictions.attr_length_constant_apply ?= "1"
    my.restrictions.attr_length_constant_required ?= "0"

    if my.restrictions.attr_length_constant_apply
        echo_trace("     Validate attribute: length_constant=\"$(my.string.length_constant?)\"", my)
    endif

    if !defined(my.string.length_constant) & \
                my.restrictions.attr_length_constant_apply & my.restrictions.attr_length_constant_required
        echo_fatal_required_attr(my.string, "length_constant")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function array_setup_defaults(array, defaults)
    my.array_name = defined(my.array.name) ?? " name=\"$(my.array.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.array))$(my.array_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    access_setup_defaults(my.array, my.defaults)

    my.default_value = my.defaults.length ? "given"
    if defined(my.default_value) & !defined(my.array.length)
        echo_trace("       length=\"$(my.default_value:)\"", my)
        my.array.length = my.default_value
    endif

    my.default_value = my.defaults.length_constant ?
    if defined(my.default_value) & !defined(my.array.length_constant)
        echo_trace("       length_constant=\"$(my.default_value:)\"", my)
        my.array.length_constant = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function array_validate(array, restrictions)
    my.array_name = defined(my.array.name) ?? " name=\"$(my.array.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.array))$(my.array_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        access_validate(my.array, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_length_apply ?= "1"
    my.restrictions.attr_length_required ?= "0"

    if my.restrictions.attr_length_apply
        echo_trace("     Validate attribute: length=\"$(my.array.length?)\"", my)
    endif

    if !defined(my.array.length) & \
                my.restrictions.attr_length_apply & my.restrictions.attr_length_required
        echo_fatal_required_attr(my.array, "length")
    endif
    if my.restrictions.attr_length_apply & defined(my.array.length)
        my.length_is_valid = "0"
        my.length_is_valid = my.length_is_valid | (my.array.length = "null_terminated")
        my.length_is_valid = my.length_is_valid | (my.array.length = "given")
        my.length_is_valid = my.length_is_valid | (my.array.length = "known")
        my.length_is_valid = my.length_is_valid | (my.array.length = "fixed")
        my.length_is_valid = my.length_is_valid | (my.array.length = "derived")
        if !my.length_is_valid
            echo_fatal_resticted_attr(my.array, "length", "null_terminated, given, known, fixed, derived")
        endif
    endif

    my.restrictions.attr_length_constant_apply ?= "1"
    my.restrictions.attr_length_constant_required ?= "0"

    if my.restrictions.attr_length_constant_apply
        echo_trace("     Validate attribute: length_constant=\"$(my.array.length_constant?)\"", my)
    endif

    if !defined(my.array.length_constant) & \
                my.restrictions.attr_length_constant_apply & my.restrictions.attr_length_constant_required
        echo_fatal_required_attr(my.array, "length_constant")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function array_validate_resolved(array, restrictions)
    my.array_name = defined(my.array.name) ?? " name=\"$(my.array.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.array))$(my.array_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        access_validate_resolved(my.array, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_length_apply ?= "1"
    my.restrictions.attr_length_required ?= "0"

    if my.restrictions.attr_length_apply
        echo_trace("     Validate attribute: length=\"$(my.array.length?)\"", my)
    endif

    if !defined(my.array.length) & \
                my.restrictions.attr_length_apply & my.restrictions.attr_length_required
        echo_fatal_required_attr(my.array, "length")
    endif
    if my.restrictions.attr_length_apply & defined(my.array.length)
        my.length_is_valid = "0"
        my.length_is_valid = my.length_is_valid | (my.array.length = "null_terminated")
        my.length_is_valid = my.length_is_valid | (my.array.length = "given")
        my.length_is_valid = my.length_is_valid | (my.array.length = "known")
        my.length_is_valid = my.length_is_valid | (my.array.length = "fixed")
        my.length_is_valid = my.length_is_valid | (my.array.length = "derived")
        if !my.length_is_valid
            echo_fatal_resticted_attr(my.array, "length", "null_terminated, given, known, fixed, derived")
        endif
    endif

    my.restrictions.attr_length_constant_apply ?= "1"
    my.restrictions.attr_length_constant_required ?= "0"

    if my.restrictions.attr_length_constant_apply
        echo_trace("     Validate attribute: length_constant=\"$(my.array.length_constant?)\"", my)
    endif

    if !defined(my.array.length_constant) & \
                my.restrictions.attr_length_constant_apply & my.restrictions.attr_length_constant_required
        echo_fatal_required_attr(my.array, "length_constant")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function instance_setup_defaults(instance, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    access_setup_defaults(my.instance, my.defaults)
    landlord_setup_defaults(my.instance, my.defaults)

    #    Setup defaults for allowed entities
    for my.instance.string as _string
        string_setup_defaults(_string)
    endfor

    for my.instance.array as _array
        array_setup_defaults(_array)
    endfor

    my.default_value = my.defaults.type ?
    if defined(my.default_value) & !defined(my.instance.type)
        echo_trace("       type=\"$(my.default_value:)\"", my)
        my.instance.type = my.default_value
    endif

    my.default_value = my.defaults.class ?
    if defined(my.default_value) & !defined(my.instance.class)
        echo_trace("       class=\"$(my.default_value:)\"", my)
        my.instance.class = my.default_value
    endif

    my.default_value = my.defaults.enum ?
    if defined(my.default_value) & !defined(my.instance.enum)
        echo_trace("       enum=\"$(my.default_value:)\"", my)
        my.instance.enum = my.default_value
    endif

    my.default_value = my.defaults.callback ?
    if defined(my.default_value) & !defined(my.instance.callback)
        echo_trace("       callback=\"$(my.default_value:)\"", my)
        my.instance.callback = my.default_value
    endif

    my.default_value = my.defaults.interface ?
    if defined(my.default_value) & !defined(my.instance.interface)
        echo_trace("       interface=\"$(my.default_value:)\"", my)
        my.instance.interface = my.default_value
    endif

    my.default_value = my.defaults.api ?
    if defined(my.default_value) & !defined(my.instance.api)
        echo_trace("       api=\"$(my.default_value:)\"", my)
        my.instance.api = my.default_value
    endif

    my.default_value = my.defaults.impl ?
    if defined(my.default_value) & !defined(my.instance.impl)
        echo_trace("       impl=\"$(my.default_value:)\"", my)
        my.instance.impl = my.default_value
    endif

    my.default_value = my.defaults.size ?
    if defined(my.default_value) & !defined(my.instance.size)
        echo_trace("       size=\"$(my.default_value:)\"", my)
        my.instance.size = my.default_value
    endif

    my.default_value = my.defaults.is_reference ?
    if defined(my.default_value) & !defined(my.instance.is_reference)
        echo_trace("       is_reference=\"$(my.default_value:)\"", my)
        my.instance.is_reference = my.default_value
    endif

    my.default_value = my.defaults.require_definition ?
    if defined(my.default_value) & !defined(my.instance.require_definition)
        echo_trace("       require_definition=\"$(my.default_value:)\"", my)
        my.instance.require_definition = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function instance_validate(instance, restrictions)

    #    Check inherited attributes and entities
    new restrictions
        access_validate(my.instance, restrictions)
    endnew

    new restrictions
        landlord_validate(my.instance, restrictions)
    endnew

    #    Check allowed entities
    my.string_count = count(my.instance.string)
    if my.string_count > 1
        my.dump_filename = entity_dump_file(my.instance)
        echo_fatal("Expected zero one entity: string.\n" + \
                   "But found $(my.string_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.instance.string as _string
        new restrictions
            string_validate(_string, restrictions)
        endnew
    endfor

    my.array_count = count(my.instance.array)
    if my.array_count > 1
        my.dump_filename = entity_dump_file(my.instance)
        echo_fatal("Expected zero one entity: array.\n" + \
                   "But found $(my.array_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.instance.array as _array
        new restrictions
            array_validate(_array, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_type_apply ?= "1"
    my.restrictions.attr_type_required ?= "0"

    if my.restrictions.attr_type_apply
        echo_trace("     Validate attribute: type=\"$(my.instance.type?)\"", my)
    endif

    if !defined(my.instance.type) & \
                my.restrictions.attr_type_apply & my.restrictions.attr_type_required
        echo_fatal_required_attr(my.instance, "type")
    endif
    if my.restrictions.attr_type_apply & defined(my.instance.type)
        my.type_is_valid = "0"
        my.type_is_valid = my.type_is_valid | (my.instance.type = "nothing")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "boolean")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "integer")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "unsigned")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "size")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "byte")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "string")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "char")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "varargs")
        if !my.type_is_valid
            echo_fatal_resticted_attr(my.instance, "type", "nothing, boolean, integer, unsigned, size, byte, string, char, varargs")
        endif
    endif

    my.restrictions.attr_class_apply ?= "1"
    my.restrictions.attr_class_required ?= "0"

    if my.restrictions.attr_class_apply
        echo_trace("     Validate attribute: class=\"$(my.instance.class?)\"", my)
    endif

    if !defined(my.instance.class) & \
                my.restrictions.attr_class_apply & my.restrictions.attr_class_required
        echo_fatal_required_attr(my.instance, "class")
    endif

    my.restrictions.attr_enum_apply ?= "1"
    my.restrictions.attr_enum_required ?= "0"

    if my.restrictions.attr_enum_apply
        echo_trace("     Validate attribute: enum=\"$(my.instance.enum?)\"", my)
    endif

    if !defined(my.instance.enum) & \
                my.restrictions.attr_enum_apply & my.restrictions.attr_enum_required
        echo_fatal_required_attr(my.instance, "enum")
    endif

    my.restrictions.attr_callback_apply ?= "1"
    my.restrictions.attr_callback_required ?= "0"

    if my.restrictions.attr_callback_apply
        echo_trace("     Validate attribute: callback=\"$(my.instance.callback?)\"", my)
    endif

    if !defined(my.instance.callback) & \
                my.restrictions.attr_callback_apply & my.restrictions.attr_callback_required
        echo_fatal_required_attr(my.instance, "callback")
    endif

    my.restrictions.attr_interface_apply ?= "1"
    my.restrictions.attr_interface_required ?= "0"

    if my.restrictions.attr_interface_apply
        echo_trace("     Validate attribute: interface=\"$(my.instance.interface?)\"", my)
    endif

    if !defined(my.instance.interface) & \
                my.restrictions.attr_interface_apply & my.restrictions.attr_interface_required
        echo_fatal_required_attr(my.instance, "interface")
    endif

    my.restrictions.attr_api_apply ?= "1"
    my.restrictions.attr_api_required ?= "0"

    if my.restrictions.attr_api_apply
        echo_trace("     Validate attribute: api=\"$(my.instance.api?)\"", my)
    endif

    if !defined(my.instance.api) & \
                my.restrictions.attr_api_apply & my.restrictions.attr_api_required
        echo_fatal_required_attr(my.instance, "api")
    endif

    my.restrictions.attr_impl_apply ?= "1"
    my.restrictions.attr_impl_required ?= "0"

    if my.restrictions.attr_impl_apply
        echo_trace("     Validate attribute: impl=\"$(my.instance.impl?)\"", my)
    endif

    if !defined(my.instance.impl) & \
                my.restrictions.attr_impl_apply & my.restrictions.attr_impl_required
        echo_fatal_required_attr(my.instance, "impl")
    endif

    my.restrictions.attr_size_apply ?= "1"
    my.restrictions.attr_size_required ?= "0"

    if my.restrictions.attr_size_apply
        echo_trace("     Validate attribute: size=\"$(my.instance.size?)\"", my)
    endif

    if !defined(my.instance.size) & \
                my.restrictions.attr_size_apply & my.restrictions.attr_size_required
        echo_fatal_required_attr(my.instance, "size")
    endif
    if my.restrictions.attr_size_apply & defined(my.instance.size)
        my.size_is_valid = "0"
        my.size_is_valid = my.size_is_valid | (my.instance.size = "1")
        my.size_is_valid = my.size_is_valid | (my.instance.size = "2")
        my.size_is_valid = my.size_is_valid | (my.instance.size = "4")
        my.size_is_valid = my.size_is_valid | (my.instance.size = "8")
        if !my.size_is_valid
            echo_fatal_resticted_attr(my.instance, "size", "1, 2, 4, 8")
        endif
    endif

    my.restrictions.attr_is_reference_apply ?= "1"
    my.restrictions.attr_is_reference_required ?= "0"

    if my.restrictions.attr_is_reference_apply
        echo_trace("     Validate attribute: is_reference=\"$(my.instance.is_reference?)\"", my)
    endif

    if !defined(my.instance.is_reference) & \
                my.restrictions.attr_is_reference_apply & my.restrictions.attr_is_reference_required
        echo_fatal_required_attr(my.instance, "is_reference")
    endif
    if my.restrictions.attr_is_reference_apply & defined(my.instance.is_reference)
        my.is_reference_is_valid = "0"
        my.is_reference_is_valid = my.is_reference_is_valid | (my.instance.is_reference = "0")
        my.is_reference_is_valid = my.is_reference_is_valid | (my.instance.is_reference = "1")
        if !my.is_reference_is_valid
            echo_fatal_resticted_attr(my.instance, "is_reference", "0, 1")
        endif
    endif

    my.restrictions.attr_require_definition_apply ?= "1"
    my.restrictions.attr_require_definition_required ?= "0"

    if my.restrictions.attr_require_definition_apply
        echo_trace("     Validate attribute: require_definition=\"$(my.instance.require_definition?)\"", my)
    endif

    if !defined(my.instance.require_definition) & \
                my.restrictions.attr_require_definition_apply & my.restrictions.attr_require_definition_required
        echo_fatal_required_attr(my.instance, "require_definition")
    endif
    if my.restrictions.attr_require_definition_apply & defined(my.instance.require_definition)
        my.require_definition_is_valid = "0"
        my.require_definition_is_valid = my.require_definition_is_valid | (my.instance.require_definition = "public")
        my.require_definition_is_valid = my.require_definition_is_valid | (my.instance.require_definition = "private")
        if !my.require_definition_is_valid
            echo_fatal_resticted_attr(my.instance, "require_definition", "public, private")
        endif
    endif

    echo_trace("     Validate one of: {type, class, enum, callback, interface, api, impl}", my)
    my.typeof_found_attrs = ""
    my.typeof_found_attrs_count = "0"

    if defined(my.instance.type)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "type"
    endif

    if defined(my.instance.class)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "class"
    endif

    if defined(my.instance.enum)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "enum"
    endif

    if defined(my.instance.callback)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "callback"
    endif

    if defined(my.instance.interface)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "interface"
    endif

    if defined(my.instance.api)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "api"
    endif

    if defined(my.instance.impl)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "impl"
    endif

    my.restrictions.oneof_typeof_apply ?= "1"
    my.restrictions.oneof_typeof_required ?= "1"

    if my.restrictions.oneof_typeof_apply &   my.restrictions.oneof_typeof_required &    my.typeof_found_attrs_count = "0"
        my.dump_filename = entity_dump_file(my.instance)
        echo_fatal("Expected one of the attributes {type, class, enum, callback, interface, api, impl}.\n" + \
                   "But found nothing.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

    if my.typeof_found_attrs_count > "1"
        my.dump_filename = entity_dump_file(my.instance)
        echo_fatal("Expected one of the attributes {type, class, enum, callback, interface, api, impl}.\n" + \
                   "But found several {$(my.typeof_found_attrs:)}.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function instance_validate_resolved(instance, restrictions)

    #    Check inherited attributes and entities
    new restrictions
        access_validate_resolved(my.instance, restrictions)
    endnew

    new restrictions
        landlord_validate_resolved(my.instance, restrictions)
    endnew

    #    Check allowed entities
    for my.instance.string as _string
        new restrictions
            string_validate_resolved(_string, restrictions)
        endnew
    endfor

    for my.instance.array as _array
        new restrictions
            array_validate_resolved(_array, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_type_apply ?= "1"
    my.restrictions.attr_type_required ?= "0"

    if my.restrictions.attr_type_apply
        echo_trace("     Validate attribute: type=\"$(my.instance.type?)\"", my)
    endif

    if !defined(my.instance.type) & \
                my.restrictions.attr_type_apply & my.restrictions.attr_type_required
        echo_fatal_required_attr(my.instance, "type")
    endif
    if my.restrictions.attr_type_apply & defined(my.instance.type)
        my.type_is_valid = "0"
        my.type_is_valid = my.type_is_valid | (my.instance.type = "nothing")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "boolean")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "integer")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "unsigned")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "size")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "byte")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "string")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "char")
        my.type_is_valid = my.type_is_valid | (my.instance.type = "varargs")
        if !my.type_is_valid
            echo_fatal_resticted_attr(my.instance, "type", "nothing, boolean, integer, unsigned, size, byte, string, char, varargs")
        endif
    endif

    my.restrictions.attr_class_apply ?= "1"
    my.restrictions.attr_class_required ?= "0"

    if my.restrictions.attr_class_apply
        echo_trace("     Validate attribute: class=\"$(my.instance.class?)\"", my)
    endif

    if !defined(my.instance.class) & \
                my.restrictions.attr_class_apply & my.restrictions.attr_class_required
        echo_fatal_required_attr(my.instance, "class")
    endif

    my.restrictions.attr_enum_apply ?= "1"
    my.restrictions.attr_enum_required ?= "0"

    if my.restrictions.attr_enum_apply
        echo_trace("     Validate attribute: enum=\"$(my.instance.enum?)\"", my)
    endif

    if !defined(my.instance.enum) & \
                my.restrictions.attr_enum_apply & my.restrictions.attr_enum_required
        echo_fatal_required_attr(my.instance, "enum")
    endif

    my.restrictions.attr_callback_apply ?= "1"
    my.restrictions.attr_callback_required ?= "0"

    if my.restrictions.attr_callback_apply
        echo_trace("     Validate attribute: callback=\"$(my.instance.callback?)\"", my)
    endif

    if !defined(my.instance.callback) & \
                my.restrictions.attr_callback_apply & my.restrictions.attr_callback_required
        echo_fatal_required_attr(my.instance, "callback")
    endif

    my.restrictions.attr_interface_apply ?= "1"
    my.restrictions.attr_interface_required ?= "0"

    if my.restrictions.attr_interface_apply
        echo_trace("     Validate attribute: interface=\"$(my.instance.interface?)\"", my)
    endif

    if !defined(my.instance.interface) & \
                my.restrictions.attr_interface_apply & my.restrictions.attr_interface_required
        echo_fatal_required_attr(my.instance, "interface")
    endif

    my.restrictions.attr_api_apply ?= "1"
    my.restrictions.attr_api_required ?= "0"

    if my.restrictions.attr_api_apply
        echo_trace("     Validate attribute: api=\"$(my.instance.api?)\"", my)
    endif

    if !defined(my.instance.api) & \
                my.restrictions.attr_api_apply & my.restrictions.attr_api_required
        echo_fatal_required_attr(my.instance, "api")
    endif

    my.restrictions.attr_impl_apply ?= "1"
    my.restrictions.attr_impl_required ?= "0"

    if my.restrictions.attr_impl_apply
        echo_trace("     Validate attribute: impl=\"$(my.instance.impl?)\"", my)
    endif

    if !defined(my.instance.impl) & \
                my.restrictions.attr_impl_apply & my.restrictions.attr_impl_required
        echo_fatal_required_attr(my.instance, "impl")
    endif

    my.restrictions.attr_size_apply ?= "1"
    my.restrictions.attr_size_required ?= "0"

    if my.restrictions.attr_size_apply
        echo_trace("     Validate attribute: size=\"$(my.instance.size?)\"", my)
    endif

    if !defined(my.instance.size) & \
                my.restrictions.attr_size_apply & my.restrictions.attr_size_required
        echo_fatal_required_attr(my.instance, "size")
    endif
    if my.restrictions.attr_size_apply & defined(my.instance.size)
        my.size_is_valid = "0"
        my.size_is_valid = my.size_is_valid | (my.instance.size = "1")
        my.size_is_valid = my.size_is_valid | (my.instance.size = "2")
        my.size_is_valid = my.size_is_valid | (my.instance.size = "4")
        my.size_is_valid = my.size_is_valid | (my.instance.size = "8")
        if !my.size_is_valid
            echo_fatal_resticted_attr(my.instance, "size", "1, 2, 4, 8")
        endif
    endif

    my.restrictions.attr_is_reference_apply ?= "1"
    my.restrictions.attr_is_reference_required ?= "0"

    if my.restrictions.attr_is_reference_apply
        echo_trace("     Validate attribute: is_reference=\"$(my.instance.is_reference?)\"", my)
    endif

    if !defined(my.instance.is_reference) & \
                my.restrictions.attr_is_reference_apply & my.restrictions.attr_is_reference_required
        echo_fatal_required_attr(my.instance, "is_reference")
    endif
    if my.restrictions.attr_is_reference_apply & defined(my.instance.is_reference)
        my.is_reference_is_valid = "0"
        my.is_reference_is_valid = my.is_reference_is_valid | (my.instance.is_reference = "0")
        my.is_reference_is_valid = my.is_reference_is_valid | (my.instance.is_reference = "1")
        if !my.is_reference_is_valid
            echo_fatal_resticted_attr(my.instance, "is_reference", "0, 1")
        endif
    endif

    my.restrictions.attr_require_definition_apply ?= "1"
    my.restrictions.attr_require_definition_required ?= "0"

    if my.restrictions.attr_require_definition_apply
        echo_trace("     Validate attribute: require_definition=\"$(my.instance.require_definition?)\"", my)
    endif

    if !defined(my.instance.require_definition) & \
                my.restrictions.attr_require_definition_apply & my.restrictions.attr_require_definition_required
        echo_fatal_required_attr(my.instance, "require_definition")
    endif
    if my.restrictions.attr_require_definition_apply & defined(my.instance.require_definition)
        my.require_definition_is_valid = "0"
        my.require_definition_is_valid = my.require_definition_is_valid | (my.instance.require_definition = "public")
        my.require_definition_is_valid = my.require_definition_is_valid | (my.instance.require_definition = "private")
        if !my.require_definition_is_valid
            echo_fatal_resticted_attr(my.instance, "require_definition", "public, private")
        endif
    endif

    echo_trace("     Validate one of: {type, class, enum, callback, interface, api, impl}", my)
    my.typeof_found_attrs = ""
    my.typeof_found_attrs_count = "0"

    if defined(my.instance.type)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "type"
    endif

    if defined(my.instance.class)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "class"
    endif

    if defined(my.instance.enum)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "enum"
    endif

    if defined(my.instance.callback)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "callback"
    endif

    if defined(my.instance.interface)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "interface"
    endif

    if defined(my.instance.api)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "api"
    endif

    if defined(my.instance.impl)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "impl"
    endif

    my.restrictions.oneof_typeof_apply ?= "1"
    my.restrictions.oneof_typeof_required ?= "1"

    if my.restrictions.oneof_typeof_apply &   my.restrictions.oneof_typeof_required &    my.typeof_found_attrs_count = "0"
        my.dump_filename = entity_dump_file(my.instance)
        echo_fatal("Expected one of the attributes {type, class, enum, callback, interface, api, impl}.\n" + \
                   "But found nothing.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

    if my.typeof_found_attrs_count > "1"
        my.dump_filename = entity_dump_file(my.instance)
        echo_fatal("Expected one of the attributes {type, class, enum, callback, interface, api, impl}.\n" + \
                   "But found several {$(my.typeof_found_attrs:)}.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function dependency_setup_defaults(dependency, defaults)
    my.dependency_name = defined(my.dependency.name) ?? " name=\"$(my.dependency.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.dependency))$(my.dependency_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
     my.defaults.access = "readwrite"
    instance_setup_defaults(my.dependency, my.defaults)
    landlord_setup_defaults(my.dependency, my.defaults)

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.dependency.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.dependency.name = my.default_value
    endif

    my.default_value = my.defaults.interface ?
    if defined(my.default_value) & !defined(my.dependency.interface)
        echo_trace("       interface=\"$(my.default_value:)\"", my)
        my.dependency.interface = my.default_value
    endif

    my.default_value = my.defaults.api ?
    if defined(my.default_value) & !defined(my.dependency.api)
        echo_trace("       api=\"$(my.default_value:)\"", my)
        my.dependency.api = my.default_value
    endif

    my.default_value = my.defaults.class ?
    if defined(my.default_value) & !defined(my.dependency.class)
        echo_trace("       class=\"$(my.default_value:)\"", my)
        my.dependency.class = my.default_value
    endif

    my.default_value = my.defaults.impl ?
    if defined(my.default_value) & !defined(my.dependency.impl)
        echo_trace("       impl=\"$(my.default_value:)\"", my)
        my.dependency.impl = my.default_value
    endif

    my.default_value = my.defaults.type_name ?
    if defined(my.default_value) & !defined(my.dependency.type_name)
        echo_trace("       type_name=\"$(my.default_value:)\"", my)
        my.dependency.type_name = my.default_value
    endif

    my.default_value = my.defaults.has_observers ? "0"
    if defined(my.default_value) & !defined(my.dependency.has_observers)
        echo_trace("       has_observers=\"$(my.default_value:)\"", my)
        my.dependency.has_observers = my.default_value
    endif

    my.default_value = my.defaults.is_observers_return_status ? "0"
    if defined(my.default_value) & !defined(my.dependency.is_observers_return_status)
        echo_trace("       is_observers_return_status=\"$(my.default_value:)\"", my)
        my.dependency.is_observers_return_status = my.default_value
    endif

    my.default_value = my.defaults.type_name ?
    if defined(my.default_value) & !defined(my.dependency.type_name)
        echo_trace("       type_name=\"$(my.default_value:)\"", my)
        my.dependency.type_name = my.default_value
    endif

    my.default_value = my.defaults.type_kind ?
    if defined(my.default_value) & !defined(my.dependency.type_kind)
        echo_trace("       type_kind=\"$(my.default_value:)\"", my)
        my.dependency.type_kind = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function dependency_validate(dependency, restrictions)
    my.dependency_name = defined(my.dependency.name) ?? " name=\"$(my.dependency.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.dependency))$(my.dependency_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        .attr_access_apply = "0"
        .attr_access_required = "0"
        instance_validate(my.dependency, restrictions)
    endnew

    new restrictions
        landlord_validate(my.dependency, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.dependency.name?)\"", my)
    endif

    if !defined(my.dependency.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.dependency, "name")
    endif

    my.restrictions.attr_interface_apply ?= "1"
    my.restrictions.attr_interface_required ?= "0"

    if my.restrictions.attr_interface_apply
        echo_trace("     Validate attribute: interface=\"$(my.dependency.interface?)\"", my)
    endif

    if !defined(my.dependency.interface) & \
                my.restrictions.attr_interface_apply & my.restrictions.attr_interface_required
        echo_fatal_required_attr(my.dependency, "interface")
    endif

    my.restrictions.attr_api_apply ?= "1"
    my.restrictions.attr_api_required ?= "0"

    if my.restrictions.attr_api_apply
        echo_trace("     Validate attribute: api=\"$(my.dependency.api?)\"", my)
    endif

    if !defined(my.dependency.api) & \
                my.restrictions.attr_api_apply & my.restrictions.attr_api_required
        echo_fatal_required_attr(my.dependency, "api")
    endif

    my.restrictions.attr_class_apply ?= "1"
    my.restrictions.attr_class_required ?= "0"

    if my.restrictions.attr_class_apply
        echo_trace("     Validate attribute: class=\"$(my.dependency.class?)\"", my)
    endif

    if !defined(my.dependency.class) & \
                my.restrictions.attr_class_apply & my.restrictions.attr_class_required
        echo_fatal_required_attr(my.dependency, "class")
    endif

    my.restrictions.attr_impl_apply ?= "1"
    my.restrictions.attr_impl_required ?= "0"

    if my.restrictions.attr_impl_apply
        echo_trace("     Validate attribute: impl=\"$(my.dependency.impl?)\"", my)
    endif

    if !defined(my.dependency.impl) & \
                my.restrictions.attr_impl_apply & my.restrictions.attr_impl_required
        echo_fatal_required_attr(my.dependency, "impl")
    endif

    my.restrictions.attr_type_name_apply ?= "1"
    my.restrictions.attr_type_name_required ?= "0"

    if my.restrictions.attr_type_name_apply
        echo_trace("     Validate attribute: type_name=\"$(my.dependency.type_name?)\"", my)
    endif

    if !defined(my.dependency.type_name) & \
                my.restrictions.attr_type_name_apply & my.restrictions.attr_type_name_required
        echo_fatal_required_attr(my.dependency, "type_name")
    endif

    my.restrictions.attr_has_observers_apply ?= "1"
    my.restrictions.attr_has_observers_required ?= "0"

    if my.restrictions.attr_has_observers_apply
        echo_trace("     Validate attribute: has_observers=\"$(my.dependency.has_observers?)\"", my)
    endif

    if !defined(my.dependency.has_observers) & \
                my.restrictions.attr_has_observers_apply & my.restrictions.attr_has_observers_required
        echo_fatal_required_attr(my.dependency, "has_observers")
    endif
    if my.restrictions.attr_has_observers_apply & defined(my.dependency.has_observers)
        my.has_observers_is_valid = "0"
        my.has_observers_is_valid = my.has_observers_is_valid | (my.dependency.has_observers = "0")
        my.has_observers_is_valid = my.has_observers_is_valid | (my.dependency.has_observers = "1")
        if !my.has_observers_is_valid
            echo_fatal_resticted_attr(my.dependency, "has_observers", "0, 1")
        endif
    endif

    my.restrictions.attr_is_observers_return_status_apply ?= "1"
    my.restrictions.attr_is_observers_return_status_required ?= "0"

    if my.restrictions.attr_is_observers_return_status_apply
        echo_trace("     Validate attribute: is_observers_return_status=\"$(my.dependency.is_observers_return_status?)\"", my)
    endif

    if !defined(my.dependency.is_observers_return_status) & \
                my.restrictions.attr_is_observers_return_status_apply & my.restrictions.attr_is_observers_return_status_required
        echo_fatal_required_attr(my.dependency, "is_observers_return_status")
    endif
    if my.restrictions.attr_is_observers_return_status_apply & defined(my.dependency.is_observers_return_status)
        my.is_observers_return_status_is_valid = "0"
        my.is_observers_return_status_is_valid = my.is_observers_return_status_is_valid | (my.dependency.is_observers_return_status = "0")
        my.is_observers_return_status_is_valid = my.is_observers_return_status_is_valid | (my.dependency.is_observers_return_status = "1")
        if !my.is_observers_return_status_is_valid
            echo_fatal_resticted_attr(my.dependency, "is_observers_return_status", "0, 1")
        endif
    endif

    echo_trace("     Validate one of: {interface, api, class, impl}", my)
    my.typeof_found_attrs = ""
    my.typeof_found_attrs_count = "0"

    if defined(my.dependency.interface)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "interface"
    endif

    if defined(my.dependency.api)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "api"
    endif

    if defined(my.dependency.class)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "class"
    endif

    if defined(my.dependency.impl)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "impl"
    endif

    my.restrictions.oneof_typeof_apply ?= "1"
    my.restrictions.oneof_typeof_required ?= "1"

    if my.restrictions.oneof_typeof_apply &   my.restrictions.oneof_typeof_required &    my.typeof_found_attrs_count = "0"
        my.dump_filename = entity_dump_file(my.dependency)
        echo_fatal("Expected one of the attributes {interface, api, class, impl}.\n" + \
                   "But found nothing.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

    if my.typeof_found_attrs_count > "1"
        my.dump_filename = entity_dump_file(my.dependency)
        echo_fatal("Expected one of the attributes {interface, api, class, impl}.\n" + \
                   "But found several {$(my.typeof_found_attrs:)}.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function dependency_validate_resolved(dependency, restrictions)
    my.dependency_name = defined(my.dependency.name) ?? " name=\"$(my.dependency.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.dependency))$(my.dependency_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        instance_validate_resolved(my.dependency, restrictions)
    endnew

    new restrictions
        landlord_validate_resolved(my.dependency, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.dependency.name?)\"", my)
    endif

    if !defined(my.dependency.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.dependency, "name")
    endif

    my.restrictions.attr_interface_apply ?= "1"
    my.restrictions.attr_interface_required ?= "0"

    if my.restrictions.attr_interface_apply
        echo_trace("     Validate attribute: interface=\"$(my.dependency.interface?)\"", my)
    endif

    if !defined(my.dependency.interface) & \
                my.restrictions.attr_interface_apply & my.restrictions.attr_interface_required
        echo_fatal_required_attr(my.dependency, "interface")
    endif

    my.restrictions.attr_api_apply ?= "1"
    my.restrictions.attr_api_required ?= "0"

    if my.restrictions.attr_api_apply
        echo_trace("     Validate attribute: api=\"$(my.dependency.api?)\"", my)
    endif

    if !defined(my.dependency.api) & \
                my.restrictions.attr_api_apply & my.restrictions.attr_api_required
        echo_fatal_required_attr(my.dependency, "api")
    endif

    my.restrictions.attr_class_apply ?= "1"
    my.restrictions.attr_class_required ?= "0"

    if my.restrictions.attr_class_apply
        echo_trace("     Validate attribute: class=\"$(my.dependency.class?)\"", my)
    endif

    if !defined(my.dependency.class) & \
                my.restrictions.attr_class_apply & my.restrictions.attr_class_required
        echo_fatal_required_attr(my.dependency, "class")
    endif

    my.restrictions.attr_impl_apply ?= "1"
    my.restrictions.attr_impl_required ?= "0"

    if my.restrictions.attr_impl_apply
        echo_trace("     Validate attribute: impl=\"$(my.dependency.impl?)\"", my)
    endif

    if !defined(my.dependency.impl) & \
                my.restrictions.attr_impl_apply & my.restrictions.attr_impl_required
        echo_fatal_required_attr(my.dependency, "impl")
    endif

    my.restrictions.attr_type_name_apply ?= "1"
    my.restrictions.attr_type_name_required ?= "0"

    if my.restrictions.attr_type_name_apply
        echo_trace("     Validate attribute: type_name=\"$(my.dependency.type_name?)\"", my)
    endif

    if !defined(my.dependency.type_name) & \
                my.restrictions.attr_type_name_apply & my.restrictions.attr_type_name_required
        echo_fatal_required_attr(my.dependency, "type_name")
    endif

    my.restrictions.attr_has_observers_apply ?= "1"
    my.restrictions.attr_has_observers_required ?= "0"

    if my.restrictions.attr_has_observers_apply
        echo_trace("     Validate attribute: has_observers=\"$(my.dependency.has_observers?)\"", my)
    endif

    if !defined(my.dependency.has_observers) & \
                my.restrictions.attr_has_observers_apply & my.restrictions.attr_has_observers_required
        echo_fatal_required_attr(my.dependency, "has_observers")
    endif
    if my.restrictions.attr_has_observers_apply & defined(my.dependency.has_observers)
        my.has_observers_is_valid = "0"
        my.has_observers_is_valid = my.has_observers_is_valid | (my.dependency.has_observers = "0")
        my.has_observers_is_valid = my.has_observers_is_valid | (my.dependency.has_observers = "1")
        if !my.has_observers_is_valid
            echo_fatal_resticted_attr(my.dependency, "has_observers", "0, 1")
        endif
    endif

    my.restrictions.attr_is_observers_return_status_apply ?= "1"
    my.restrictions.attr_is_observers_return_status_required ?= "0"

    if my.restrictions.attr_is_observers_return_status_apply
        echo_trace("     Validate attribute: is_observers_return_status=\"$(my.dependency.is_observers_return_status?)\"", my)
    endif

    if !defined(my.dependency.is_observers_return_status) & \
                my.restrictions.attr_is_observers_return_status_apply & my.restrictions.attr_is_observers_return_status_required
        echo_fatal_required_attr(my.dependency, "is_observers_return_status")
    endif
    if my.restrictions.attr_is_observers_return_status_apply & defined(my.dependency.is_observers_return_status)
        my.is_observers_return_status_is_valid = "0"
        my.is_observers_return_status_is_valid = my.is_observers_return_status_is_valid | (my.dependency.is_observers_return_status = "0")
        my.is_observers_return_status_is_valid = my.is_observers_return_status_is_valid | (my.dependency.is_observers_return_status = "1")
        if !my.is_observers_return_status_is_valid
            echo_fatal_resticted_attr(my.dependency, "is_observers_return_status", "0, 1")
        endif
    endif

    my.restrictions.attr_type_name_apply ?= "1"
    my.restrictions.attr_type_name_required ?= "0"

    if my.restrictions.attr_type_name_apply
        echo_trace("     Validate attribute: type_name=\"$(my.dependency.type_name?)\"", my)
    endif

    if !defined(my.dependency.type_name) & \
                my.restrictions.attr_type_name_apply & my.restrictions.attr_type_name_required
        echo_fatal_required_attr(my.dependency, "type_name")
    endif

    my.restrictions.attr_type_kind_apply ?= "1"
    my.restrictions.attr_type_kind_required ?= "0"

    if my.restrictions.attr_type_kind_apply
        echo_trace("     Validate attribute: type_kind=\"$(my.dependency.type_kind?)\"", my)
    endif

    if !defined(my.dependency.type_kind) & \
                my.restrictions.attr_type_kind_apply & my.restrictions.attr_type_kind_required
        echo_fatal_required_attr(my.dependency, "type_kind")
    endif
    if my.restrictions.attr_type_kind_apply & defined(my.dependency.type_kind)
        my.type_kind_is_valid = "0"
        my.type_kind_is_valid = my.type_kind_is_valid | (my.dependency.type_kind = "interface")
        my.type_kind_is_valid = my.type_kind_is_valid | (my.dependency.type_kind = "interface api")
        my.type_kind_is_valid = my.type_kind_is_valid | (my.dependency.type_kind = "class")
        my.type_kind_is_valid = my.type_kind_is_valid | (my.dependency.type_kind = "implementation")
        if !my.type_kind_is_valid
            echo_fatal_resticted_attr(my.dependency, "type_kind", "interface, interface api, class, implementation")
        endif
    endif

    echo_trace("     Validate one of: {interface, api, class, impl}", my)
    my.typeof_found_attrs = ""
    my.typeof_found_attrs_count = "0"

    if defined(my.dependency.interface)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "interface"
    endif

    if defined(my.dependency.api)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "api"
    endif

    if defined(my.dependency.class)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "class"
    endif

    if defined(my.dependency.impl)
        my.typeof_found_attrs_count += 1
        if my.typeof_found_attrs <> ""
            my.typeof_found_attrs += ", "
        endif
        my.typeof_found_attrs += "impl"
    endif

    my.restrictions.oneof_typeof_apply ?= "1"
    my.restrictions.oneof_typeof_required ?= "1"

    if my.restrictions.oneof_typeof_apply &   my.restrictions.oneof_typeof_required &    my.typeof_found_attrs_count = "0"
        my.dump_filename = entity_dump_file(my.dependency)
        echo_fatal("Expected one of the attributes {interface, api, class, impl}.\n" + \
                   "But found nothing.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

    if my.typeof_found_attrs_count > "1"
        my.dump_filename = entity_dump_file(my.dependency)
        echo_fatal("Expected one of the attributes {interface, api, class, impl}.\n" + \
                   "But found several {$(my.typeof_found_attrs:)}.\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function of_class_setup_defaults(of_class, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.of_class ?
    if defined(my.default_value) & !defined(my.of_class.of_class)
        echo_trace("       of_class=\"$(my.default_value:)\"", my)
        my.of_class.of_class = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function of_class_validate(of_class, restrictions)

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function of_class_validate_resolved(of_class, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_of_class_apply ?= "1"
    my.restrictions.attr_of_class_required ?= "0"

    if my.restrictions.attr_of_class_apply
        echo_trace("     Validate attribute: of_class=\"$(my.of_class.of_class?)\"", my)
    endif

    if !defined(my.of_class.of_class) & \
                my.restrictions.attr_of_class_apply & my.restrictions.attr_of_class_required
        echo_fatal_required_attr(my.of_class, "of_class")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function component_setup_defaults(component, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    uid_setup_defaults(my.component, my.defaults)
    of_class_setup_defaults(my.component, my.defaults)
    c_prefix_setup_defaults(my.component, my.defaults)

    my.default_value = my.defaults.feature ?
    if defined(my.default_value) & !defined(my.component.feature)
        echo_trace("       feature=\"$(my.default_value:)\"", my)
        my.component.feature = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function component_validate(component, restrictions)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate(my.component, restrictions)
    endnew

    new restrictions
        of_class_validate(my.component, restrictions)
    endnew

    new restrictions
        c_prefix_validate(my.component, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_feature_apply ?= "1"
    my.restrictions.attr_feature_required ?= "0"

    if my.restrictions.attr_feature_apply
        echo_trace("     Validate attribute: feature=\"$(my.component.feature?)\"", my)
    endif

    if !defined(my.component.feature) & \
                my.restrictions.attr_feature_apply & my.restrictions.attr_feature_required
        echo_fatal_required_attr(my.component, "feature")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function component_validate_resolved(component, restrictions)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate_resolved(my.component, restrictions)
    endnew

    new restrictions
        of_class_validate_resolved(my.component, restrictions)
    endnew

    new restrictions
        c_prefix_validate_resolved(my.component, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_feature_apply ?= "1"
    my.restrictions.attr_feature_required ?= "0"

    if my.restrictions.attr_feature_apply
        echo_trace("     Validate attribute: feature=\"$(my.component.feature?)\"", my)
    endif

    if !defined(my.component.feature) & \
                my.restrictions.attr_feature_apply & my.restrictions.attr_feature_required
        echo_fatal_required_attr(my.component, "feature")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function scoped_component_setup_defaults(scoped_component, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    component_setup_defaults(my.scoped_component, my.defaults)

    my.default_value = my.defaults.scope ? "public"
    if defined(my.default_value) & !defined(my.scoped_component.scope)
        echo_trace("       scope=\"$(my.default_value:)\"", my)
        my.scoped_component.scope = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function scoped_component_validate(scoped_component, restrictions)

    #    Check inherited attributes and entities
    new restrictions
        component_validate(my.scoped_component, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_scope_apply ?= "1"
    my.restrictions.attr_scope_required ?= "0"

    if my.restrictions.attr_scope_apply
        echo_trace("     Validate attribute: scope=\"$(my.scoped_component.scope?)\"", my)
    endif

    if !defined(my.scoped_component.scope) & \
                my.restrictions.attr_scope_apply & my.restrictions.attr_scope_required
        echo_fatal_required_attr(my.scoped_component, "scope")
    endif
    if my.restrictions.attr_scope_apply & defined(my.scoped_component.scope)
        my.scope_is_valid = "0"
        my.scope_is_valid = my.scope_is_valid | (my.scoped_component.scope = "public")
        my.scope_is_valid = my.scope_is_valid | (my.scoped_component.scope = "private")
        my.scope_is_valid = my.scope_is_valid | (my.scoped_component.scope = "internal")
        my.scope_is_valid = my.scope_is_valid | (my.scoped_component.scope = "hidden")
        if !my.scope_is_valid
            echo_fatal_resticted_attr(my.scoped_component, "scope", "public, private, internal, hidden")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function scoped_component_validate_resolved(scoped_component, restrictions)

    #    Check inherited attributes and entities
    new restrictions
        component_validate_resolved(my.scoped_component, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_scope_apply ?= "1"
    my.restrictions.attr_scope_required ?= "0"

    if my.restrictions.attr_scope_apply
        echo_trace("     Validate attribute: scope=\"$(my.scoped_component.scope?)\"", my)
    endif

    if !defined(my.scoped_component.scope) & \
                my.restrictions.attr_scope_apply & my.restrictions.attr_scope_required
        echo_fatal_required_attr(my.scoped_component, "scope")
    endif
    if my.restrictions.attr_scope_apply & defined(my.scoped_component.scope)
        my.scope_is_valid = "0"
        my.scope_is_valid = my.scope_is_valid | (my.scoped_component.scope = "public")
        my.scope_is_valid = my.scope_is_valid | (my.scoped_component.scope = "private")
        my.scope_is_valid = my.scope_is_valid | (my.scoped_component.scope = "internal")
        my.scope_is_valid = my.scope_is_valid | (my.scoped_component.scope = "hidden")
        if !my.scope_is_valid
            echo_fatal_resticted_attr(my.scoped_component, "scope", "public, private, internal, hidden")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function definition_setup_defaults(definition, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.definition ? "private"
    if defined(my.default_value) & !defined(my.definition.definition)
        echo_trace("       definition=\"$(my.default_value:)\"", my)
        my.definition.definition = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function definition_validate(definition, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_definition_apply ?= "1"
    my.restrictions.attr_definition_required ?= "0"

    if my.restrictions.attr_definition_apply
        echo_trace("     Validate attribute: definition=\"$(my.definition.definition?)\"", my)
    endif

    if !defined(my.definition.definition) & \
                my.restrictions.attr_definition_apply & my.restrictions.attr_definition_required
        echo_fatal_required_attr(my.definition, "definition")
    endif
    if my.restrictions.attr_definition_apply & defined(my.definition.definition)
        my.definition_is_valid = "0"
        my.definition_is_valid = my.definition_is_valid | (my.definition.definition = "public")
        my.definition_is_valid = my.definition_is_valid | (my.definition.definition = "private")
        my.definition_is_valid = my.definition_is_valid | (my.definition.definition = "external")
        if !my.definition_is_valid
            echo_fatal_resticted_attr(my.definition, "definition", "public, private, external")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function definition_validate_resolved(definition, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_definition_apply ?= "1"
    my.restrictions.attr_definition_required ?= "0"

    if my.restrictions.attr_definition_apply
        echo_trace("     Validate attribute: definition=\"$(my.definition.definition?)\"", my)
    endif

    if !defined(my.definition.definition) & \
                my.restrictions.attr_definition_apply & my.restrictions.attr_definition_required
        echo_fatal_required_attr(my.definition, "definition")
    endif
    if my.restrictions.attr_definition_apply & defined(my.definition.definition)
        my.definition_is_valid = "0"
        my.definition_is_valid = my.definition_is_valid | (my.definition.definition = "public")
        my.definition_is_valid = my.definition_is_valid | (my.definition.definition = "private")
        my.definition_is_valid = my.definition_is_valid | (my.definition.definition = "external")
        if !my.definition_is_valid
            echo_fatal_resticted_attr(my.definition, "definition", "public, private, external")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function constant_setup_defaults(constant, defaults)
    my.constant_name = defined(my.constant.name) ?? " name=\"$(my.constant.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.constant))$(my.constant_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    scoped_component_setup_defaults(my.constant, my.defaults)
     my.defaults.default = "public"
    definition_setup_defaults(my.constant, my.defaults)

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.constant.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.constant.name = my.default_value
    endif

    my.default_value = my.defaults.type ? "size"
    if defined(my.default_value) & !defined(my.constant.type)
        echo_trace("       type=\"$(my.default_value:)\"", my)
        my.constant.type = my.default_value
    endif

    my.default_value = my.defaults.value ?
    if defined(my.default_value) & !defined(my.constant.value)
        echo_trace("       value=\"$(my.default_value:)\"", my)
        my.constant.value = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function constant_validate(constant, restrictions)
    my.constant_name = defined(my.constant.name) ?? " name=\"$(my.constant.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.constant))$(my.constant_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate(my.constant, restrictions)
    endnew

    new restrictions
        .attr_default_apply = "0"
        .attr_default_required = "0"
        definition_validate(my.constant, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.constant.name?)\"", my)
    endif

    if !defined(my.constant.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.constant, "name")
    endif

    my.restrictions.attr_type_apply ?= "1"
    my.restrictions.attr_type_required ?= "0"

    if my.restrictions.attr_type_apply
        echo_trace("     Validate attribute: type=\"$(my.constant.type?)\"", my)
    endif

    if !defined(my.constant.type) & \
                my.restrictions.attr_type_apply & my.restrictions.attr_type_required
        echo_fatal_required_attr(my.constant, "type")
    endif
    if my.restrictions.attr_type_apply & defined(my.constant.type)
        my.type_is_valid = "0"
        my.type_is_valid = my.type_is_valid | (my.constant.type = "boolean")
        my.type_is_valid = my.type_is_valid | (my.constant.type = "integer")
        my.type_is_valid = my.type_is_valid | (my.constant.type = "size")
        if !my.type_is_valid
            echo_fatal_resticted_attr(my.constant, "type", "boolean, integer, size")
        endif
    endif

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "0"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.constant.value?)\"", my)
    endif

    if !defined(my.constant.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.constant, "value")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function constant_validate_resolved(constant, restrictions)
    my.constant_name = defined(my.constant.name) ?? " name=\"$(my.constant.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.constant))$(my.constant_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate_resolved(my.constant, restrictions)
    endnew

    new restrictions
        definition_validate_resolved(my.constant, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.constant.name?)\"", my)
    endif

    if !defined(my.constant.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.constant, "name")
    endif

    my.restrictions.attr_type_apply ?= "1"
    my.restrictions.attr_type_required ?= "0"

    if my.restrictions.attr_type_apply
        echo_trace("     Validate attribute: type=\"$(my.constant.type?)\"", my)
    endif

    if !defined(my.constant.type) & \
                my.restrictions.attr_type_apply & my.restrictions.attr_type_required
        echo_fatal_required_attr(my.constant, "type")
    endif
    if my.restrictions.attr_type_apply & defined(my.constant.type)
        my.type_is_valid = "0"
        my.type_is_valid = my.type_is_valid | (my.constant.type = "boolean")
        my.type_is_valid = my.type_is_valid | (my.constant.type = "integer")
        my.type_is_valid = my.type_is_valid | (my.constant.type = "size")
        if !my.type_is_valid
            echo_fatal_resticted_attr(my.constant, "type", "boolean, integer, size")
        endif
    endif

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "0"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.constant.value?)\"", my)
    endif

    if !defined(my.constant.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.constant, "value")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function property_setup_defaults(property, defaults)
    my.property_name = defined(my.property.name) ?? " name=\"$(my.property.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.property))$(my.property_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
     my.defaults.access = "readwrite"
    instance_setup_defaults(my.property, my.defaults)
    uid_setup_defaults(my.property, my.defaults)

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.property.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.property.name = my.default_value
    endif

    my.default_value = my.defaults.bits ?
    if defined(my.default_value) & !defined(my.property.bits)
        echo_trace("       bits=\"$(my.default_value:)\"", my)
        my.property.bits = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function property_validate(property, restrictions)
    my.property_name = defined(my.property.name) ?? " name=\"$(my.property.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.property))$(my.property_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        .attr_access_apply = "0"
        .attr_access_required = "0"
        instance_validate(my.property, restrictions)
    endnew

    new restrictions
        uid_validate(my.property, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.property.name?)\"", my)
    endif

    if !defined(my.property.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.property, "name")
    endif

    my.restrictions.attr_bits_apply ?= "1"
    my.restrictions.attr_bits_required ?= "0"

    if my.restrictions.attr_bits_apply
        echo_trace("     Validate attribute: bits=\"$(my.property.bits?)\"", my)
    endif

    if !defined(my.property.bits) & \
                my.restrictions.attr_bits_apply & my.restrictions.attr_bits_required
        echo_fatal_required_attr(my.property, "bits")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function property_validate_resolved(property, restrictions)
    my.property_name = defined(my.property.name) ?? " name=\"$(my.property.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.property))$(my.property_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        instance_validate_resolved(my.property, restrictions)
    endnew

    new restrictions
        uid_validate_resolved(my.property, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.property.name?)\"", my)
    endif

    if !defined(my.property.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.property, "name")
    endif

    my.restrictions.attr_bits_apply ?= "1"
    my.restrictions.attr_bits_required ?= "0"

    if my.restrictions.attr_bits_apply
        echo_trace("     Validate attribute: bits=\"$(my.property.bits?)\"", my)
    endif

    if !defined(my.property.bits) & \
                my.restrictions.attr_bits_apply & my.restrictions.attr_bits_required
        echo_fatal_required_attr(my.property, "bits")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function declaration_setup_defaults(declaration, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.declaration ? "public"
    if defined(my.default_value) & !defined(my.declaration.declaration)
        echo_trace("       declaration=\"$(my.default_value:)\"", my)
        my.declaration.declaration = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function declaration_validate(declaration, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_declaration_apply ?= "1"
    my.restrictions.attr_declaration_required ?= "0"

    if my.restrictions.attr_declaration_apply
        echo_trace("     Validate attribute: declaration=\"$(my.declaration.declaration?)\"", my)
    endif

    if !defined(my.declaration.declaration) & \
                my.restrictions.attr_declaration_apply & my.restrictions.attr_declaration_required
        echo_fatal_required_attr(my.declaration, "declaration")
    endif
    if my.restrictions.attr_declaration_apply & defined(my.declaration.declaration)
        my.declaration_is_valid = "0"
        my.declaration_is_valid = my.declaration_is_valid | (my.declaration.declaration = "public")
        my.declaration_is_valid = my.declaration_is_valid | (my.declaration.declaration = "private")
        my.declaration_is_valid = my.declaration_is_valid | (my.declaration.declaration = "external")
        if !my.declaration_is_valid
            echo_fatal_resticted_attr(my.declaration, "declaration", "public, private, external")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function declaration_validate_resolved(declaration, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_declaration_apply ?= "1"
    my.restrictions.attr_declaration_required ?= "0"

    if my.restrictions.attr_declaration_apply
        echo_trace("     Validate attribute: declaration=\"$(my.declaration.declaration?)\"", my)
    endif

    if !defined(my.declaration.declaration) & \
                my.restrictions.attr_declaration_apply & my.restrictions.attr_declaration_required
        echo_fatal_required_attr(my.declaration, "declaration")
    endif
    if my.restrictions.attr_declaration_apply & defined(my.declaration.declaration)
        my.declaration_is_valid = "0"
        my.declaration_is_valid = my.declaration_is_valid | (my.declaration.declaration = "public")
        my.declaration_is_valid = my.declaration_is_valid | (my.declaration.declaration = "private")
        my.declaration_is_valid = my.declaration_is_valid | (my.declaration.declaration = "external")
        if !my.declaration_is_valid
            echo_fatal_resticted_attr(my.declaration, "declaration", "public, private, external")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function enum_setup_defaults(enum, defaults)
    my.enum_name = defined(my.enum.name) ?? " name=\"$(my.enum.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.enum))$(my.enum_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    scoped_component_setup_defaults(my.enum, my.defaults)
    visibility_setup_defaults(my.enum, my.defaults)
    declaration_setup_defaults(my.enum, my.defaults)
    definition_setup_defaults(my.enum, my.defaults)

    #    Setup defaults for allowed entities
    new defaults
        for my.enum.constant as _constant
            constant_setup_defaults(_constant, defaults)
        endfor
        delete defaults
    endnew

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.enum.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.enum.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function enum_validate(enum, restrictions)
    my.enum_name = defined(my.enum.name) ?? " name=\"$(my.enum.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.enum))$(my.enum_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate(my.enum, restrictions)
    endnew

    new restrictions
        visibility_validate(my.enum, restrictions)
    endnew

    new restrictions
        declaration_validate(my.enum, restrictions)
    endnew

    new restrictions
        definition_validate(my.enum, restrictions)
    endnew

    #    Check allowed entities
    my.constant_count = count(my.enum.constant)
    for my.enum.constant as _constant
        new restrictions
            .attr_value_apply = "1"
            .attr_value_required = "0"
            constant_validate(_constant, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "0"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.enum.name?)\"", my)
    endif

    if !defined(my.enum.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.enum, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function enum_validate_resolved(enum, restrictions)
    my.enum_name = defined(my.enum.name) ?? " name=\"$(my.enum.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.enum))$(my.enum_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate_resolved(my.enum, restrictions)
    endnew

    new restrictions
        visibility_validate_resolved(my.enum, restrictions)
    endnew

    new restrictions
        declaration_validate_resolved(my.enum, restrictions)
    endnew

    new restrictions
        definition_validate_resolved(my.enum, restrictions)
    endnew

    #    Check allowed entities
    for my.enum.constant as _constant
        new restrictions
            .attr_value_apply = "1"
            .attr_value_required = "0"
            constant_validate_resolved(_constant, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "0"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.enum.name?)\"", my)
    endif

    if !defined(my.enum.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.enum, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function return_setup_defaults(return, defaults)
    my.return_name = defined(my.return.name) ?? " name=\"$(my.return.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.return))$(my.return_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    instance_setup_defaults(my.return, my.defaults)

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function return_validate(return, restrictions)
    my.return_name = defined(my.return.name) ?? " name=\"$(my.return.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.return))$(my.return_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        instance_validate(my.return, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function return_validate_resolved(return, restrictions)
    my.return_name = defined(my.return.name) ?? " name=\"$(my.return.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.return))$(my.return_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        instance_validate_resolved(my.return, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function argument_setup_defaults(argument, defaults)
    my.argument_name = defined(my.argument.name) ?? " name=\"$(my.argument.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.argument))$(my.argument_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    instance_setup_defaults(my.argument, my.defaults)
    uid_setup_defaults(my.argument, my.defaults)

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.argument.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.argument.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function argument_validate(argument, restrictions)
    my.argument_name = defined(my.argument.name) ?? " name=\"$(my.argument.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.argument))$(my.argument_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        instance_validate(my.argument, restrictions)
    endnew

    new restrictions
        uid_validate(my.argument, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function argument_validate_resolved(argument, restrictions)
    my.argument_name = defined(my.argument.name) ?? " name=\"$(my.argument.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.argument))$(my.argument_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        instance_validate_resolved(my.argument, restrictions)
    endnew

    new restrictions
        uid_validate_resolved(my.argument, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.argument.name?)\"", my)
    endif

    if !defined(my.argument.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.argument, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function callback_setup_defaults(callback, defaults)
    my.callback_name = defined(my.callback.name) ?? " name=\"$(my.callback.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.callback))$(my.callback_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    scoped_component_setup_defaults(my.callback, my.defaults)
    declaration_setup_defaults(my.callback, my.defaults)

    #    Setup defaults for allowed entities
    for my.callback.return as _return
        return_setup_defaults(_return)
    endfor

    for my.callback.argument as _argument
        argument_setup_defaults(_argument)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.callback.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.callback.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function callback_validate(callback, restrictions)
    my.callback_name = defined(my.callback.name) ?? " name=\"$(my.callback.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.callback))$(my.callback_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate(my.callback, restrictions)
    endnew

    new restrictions
        declaration_validate(my.callback, restrictions)
    endnew

    #    Check allowed entities
    my.return_count = count(my.callback.return)
    if my.return_count > 1
        my.dump_filename = entity_dump_file(my.callback)
        echo_fatal("Expected zero one entity: return.\n" + \
                   "But found $(my.return_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.callback.return as _return
        new restrictions
            return_validate(_return, restrictions)
        endnew
    endfor

    my.argument_count = count(my.callback.argument)
    for my.callback.argument as _argument
        new restrictions
            argument_validate(_argument, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.callback.name?)\"", my)
    endif

    if !defined(my.callback.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.callback, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function callback_validate_resolved(callback, restrictions)
    my.callback_name = defined(my.callback.name) ?? " name=\"$(my.callback.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.callback))$(my.callback_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate_resolved(my.callback, restrictions)
    endnew

    new restrictions
        declaration_validate_resolved(my.callback, restrictions)
    endnew

    #    Check allowed entities
    for my.callback.return as _return
        new restrictions
            return_validate_resolved(_return, restrictions)
        endnew
    endfor

    for my.callback.argument as _argument
        new restrictions
            argument_validate_resolved(_argument, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.callback.name?)\"", my)
    endif

    if !defined(my.callback.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.callback, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function cast_setup_defaults(cast, defaults)
    my.cast_name = defined(my.cast.name) ?? " name=\"$(my.cast.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.cast))$(my.cast_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    instance_setup_defaults(my.cast, my.defaults)

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function cast_validate(cast, restrictions)
    my.cast_name = defined(my.cast.name) ?? " name=\"$(my.cast.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.cast))$(my.cast_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        instance_validate(my.cast, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function cast_validate_resolved(cast, restrictions)
    my.cast_name = defined(my.cast.name) ?? " name=\"$(my.cast.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.cast))$(my.cast_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        instance_validate_resolved(my.cast, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function value_setup_defaults(value, defaults)
    my.value_name = defined(my.value.name) ?? " name=\"$(my.value.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.value))$(my.value_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    instance_setup_defaults(my.value, my.defaults)

    #    Setup defaults for allowed entities
    for my.value.cast as _cast
        cast_setup_defaults(_cast)
    endfor

    my.default_value = my.defaults.value ?
    if defined(my.default_value) & !defined(my.value.value)
        echo_trace("       value=\"$(my.default_value:)\"", my)
        my.value.value = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function value_validate(value, restrictions)
    my.value_name = defined(my.value.name) ?? " name=\"$(my.value.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.value))$(my.value_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        .oneof_typeof_apply = "1"
        .oneof_typeof_required = "0"
        instance_validate(my.value, restrictions)
    endnew

    #    Check allowed entities
    my.cast_count = count(my.value.cast)
    if my.cast_count > 1
        my.dump_filename = entity_dump_file(my.value)
        echo_fatal("Expected zero one entity: cast.\n" + \
                   "But found $(my.cast_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.value.cast as _cast
        new restrictions
            cast_validate(_cast, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "1"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.value.value?)\"", my)
    endif

    if !defined(my.value.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.value, "value")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function value_validate_resolved(value, restrictions)
    my.value_name = defined(my.value.name) ?? " name=\"$(my.value.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.value))$(my.value_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        instance_validate_resolved(my.value, restrictions)
    endnew

    #    Check allowed entities
    for my.value.cast as _cast
        new restrictions
            cast_validate_resolved(_cast, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "1"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.value.value?)\"", my)
    endif

    if !defined(my.value.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.value, "value")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function variable_setup_defaults(variable, defaults)
    my.variable_name = defined(my.variable.name) ?? " name=\"$(my.variable.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.variable))$(my.variable_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    scoped_component_setup_defaults(my.variable, my.defaults)
    visibility_setup_defaults(my.variable, my.defaults)
    declaration_setup_defaults(my.variable, my.defaults)
    definition_setup_defaults(my.variable, my.defaults)
    instance_setup_defaults(my.variable, my.defaults)

    #    Setup defaults for allowed entities
    for my.variable.value as _value
        value_setup_defaults(_value)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.variable.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.variable.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function variable_validate(variable, restrictions)
    my.variable_name = defined(my.variable.name) ?? " name=\"$(my.variable.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.variable))$(my.variable_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate(my.variable, restrictions)
    endnew

    new restrictions
        visibility_validate(my.variable, restrictions)
    endnew

    new restrictions
        declaration_validate(my.variable, restrictions)
    endnew

    new restrictions
        definition_validate(my.variable, restrictions)
    endnew

    new restrictions
        instance_validate(my.variable, restrictions)
    endnew

    #    Check allowed entities
    my.value_count = count(my.variable.value)
    if my.value_count < 1
        my.dump_filename = entity_dump_file(my.variable)
        echo_fatal("Expected one or more entities: value.\n" + \
                   "But found $(my.value_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.variable.value as _value
        new restrictions
            value_validate(_value, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.variable.name?)\"", my)
    endif

    if !defined(my.variable.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.variable, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function variable_validate_resolved(variable, restrictions)
    my.variable_name = defined(my.variable.name) ?? " name=\"$(my.variable.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.variable))$(my.variable_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate_resolved(my.variable, restrictions)
    endnew

    new restrictions
        visibility_validate_resolved(my.variable, restrictions)
    endnew

    new restrictions
        declaration_validate_resolved(my.variable, restrictions)
    endnew

    new restrictions
        definition_validate_resolved(my.variable, restrictions)
    endnew

    new restrictions
        instance_validate_resolved(my.variable, restrictions)
    endnew

    #    Check allowed entities
    for my.variable.value as _value
        new restrictions
            value_validate_resolved(_value, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.variable.name?)\"", my)
    endif

    if !defined(my.variable.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.variable, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function lang_setup_defaults(lang, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.lang ? "c"
    if defined(my.default_value) & !defined(my.lang.lang)
        echo_trace("       lang=\"$(my.default_value:)\"", my)
        my.lang.lang = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function lang_validate(lang, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_lang_apply ?= "1"
    my.restrictions.attr_lang_required ?= "0"

    if my.restrictions.attr_lang_apply
        echo_trace("     Validate attribute: lang=\"$(my.lang.lang?)\"", my)
    endif

    if !defined(my.lang.lang) & \
                my.restrictions.attr_lang_apply & my.restrictions.attr_lang_required
        echo_fatal_required_attr(my.lang, "lang")
    endif
    if my.restrictions.attr_lang_apply & defined(my.lang.lang)
        my.lang_is_valid = "0"
        my.lang_is_valid = my.lang_is_valid | (my.lang.lang = "c")
        my.lang_is_valid = my.lang_is_valid | (my.lang.lang = "java")
        my.lang_is_valid = my.lang_is_valid | (my.lang.lang = "python")
        my.lang_is_valid = my.lang_is_valid | (my.lang.lang = "swift")
        my.lang_is_valid = my.lang_is_valid | (my.lang.lang = "wasm")
        if !my.lang_is_valid
            echo_fatal_resticted_attr(my.lang, "lang", "c, java, python, swift, wasm")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function lang_validate_resolved(lang, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_lang_apply ?= "1"
    my.restrictions.attr_lang_required ?= "0"

    if my.restrictions.attr_lang_apply
        echo_trace("     Validate attribute: lang=\"$(my.lang.lang?)\"", my)
    endif

    if !defined(my.lang.lang) & \
                my.restrictions.attr_lang_apply & my.restrictions.attr_lang_required
        echo_fatal_required_attr(my.lang, "lang")
    endif
    if my.restrictions.attr_lang_apply & defined(my.lang.lang)
        my.lang_is_valid = "0"
        my.lang_is_valid = my.lang_is_valid | (my.lang.lang = "c")
        my.lang_is_valid = my.lang_is_valid | (my.lang.lang = "java")
        my.lang_is_valid = my.lang_is_valid | (my.lang.lang = "python")
        my.lang_is_valid = my.lang_is_valid | (my.lang.lang = "swift")
        my.lang_is_valid = my.lang_is_valid | (my.lang.lang = "wasm")
        if !my.lang_is_valid
            echo_fatal_resticted_attr(my.lang, "lang", "c, java, python, swift, wasm")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function code_setup_defaults(code, defaults)
    my.code_name = defined(my.code.name) ?? " name=\"$(my.code.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.code))$(my.code_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    lang_setup_defaults(my.code, my.defaults)

    my.default_value = my.defaults.type ? "generated"
    if defined(my.default_value) & !defined(my.code.type)
        echo_trace("       type=\"$(my.default_value:)\"", my)
        my.code.type = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function code_validate(code, restrictions)
    my.code_name = defined(my.code.name) ?? " name=\"$(my.code.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.code))$(my.code_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        lang_validate(my.code, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_type_apply ?= "1"
    my.restrictions.attr_type_required ?= "0"

    if my.restrictions.attr_type_apply
        echo_trace("     Validate attribute: type=\"$(my.code.type?)\"", my)
    endif

    if !defined(my.code.type) & \
                my.restrictions.attr_type_apply & my.restrictions.attr_type_required
        echo_fatal_required_attr(my.code, "type")
    endif
    if my.restrictions.attr_type_apply & defined(my.code.type)
        my.type_is_valid = "0"
        my.type_is_valid = my.type_is_valid | (my.code.type = "stub")
        my.type_is_valid = my.type_is_valid | (my.code.type = "generated")
        my.type_is_valid = my.type_is_valid | (my.code.type = "handwritten")
        if !my.type_is_valid
            echo_fatal_resticted_attr(my.code, "type", "stub, generated, handwritten")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function code_validate_resolved(code, restrictions)
    my.code_name = defined(my.code.name) ?? " name=\"$(my.code.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.code))$(my.code_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        lang_validate_resolved(my.code, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_type_apply ?= "1"
    my.restrictions.attr_type_required ?= "0"

    if my.restrictions.attr_type_apply
        echo_trace("     Validate attribute: type=\"$(my.code.type?)\"", my)
    endif

    if !defined(my.code.type) & \
                my.restrictions.attr_type_apply & my.restrictions.attr_type_required
        echo_fatal_required_attr(my.code, "type")
    endif
    if my.restrictions.attr_type_apply & defined(my.code.type)
        my.type_is_valid = "0"
        my.type_is_valid = my.type_is_valid | (my.code.type = "stub")
        my.type_is_valid = my.type_is_valid | (my.code.type = "generated")
        my.type_is_valid = my.type_is_valid | (my.code.type = "handwritten")
        if !my.type_is_valid
            echo_fatal_resticted_attr(my.code, "type", "stub, generated, handwritten")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function method_setup_defaults(method, defaults)
    my.method_name = defined(my.method.name) ?? " name=\"$(my.method.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.method))$(my.method_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    scoped_component_setup_defaults(my.method, my.defaults)
    visibility_setup_defaults(my.method, my.defaults)
    declaration_setup_defaults(my.method, my.defaults)
    definition_setup_defaults(my.method, my.defaults)

    #    Setup defaults for allowed entities
    for my.method.return as _return
        return_setup_defaults(_return)
    endfor

    for my.method.argument as _argument
        argument_setup_defaults(_argument)
    endfor

    for my.method.variable as _variable
        variable_setup_defaults(_variable)
    endfor

    for my.method.code as _code
        code_setup_defaults(_code)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.method.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.method.name = my.default_value
    endif

    my.default_value = my.defaults.is_static ? "0"
    if defined(my.default_value) & !defined(my.method.is_static)
        echo_trace("       is_static=\"$(my.default_value:)\"", my)
        my.method.is_static = my.default_value
    endif

    my.default_value = my.defaults.is_const ? "0"
    if defined(my.default_value) & !defined(my.method.is_const)
        echo_trace("       is_const=\"$(my.default_value:)\"", my)
        my.method.is_const = my.default_value
    endif

    my.default_value = my.defaults.nodiscard ? "0"
    if defined(my.default_value) & !defined(my.method.nodiscard)
        echo_trace("       nodiscard=\"$(my.default_value:)\"", my)
        my.method.nodiscard = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function method_validate(method, restrictions)
    my.method_name = defined(my.method.name) ?? " name=\"$(my.method.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.method))$(my.method_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate(my.method, restrictions)
    endnew

    new restrictions
        visibility_validate(my.method, restrictions)
    endnew

    new restrictions
        declaration_validate(my.method, restrictions)
    endnew

    new restrictions
        definition_validate(my.method, restrictions)
    endnew

    #    Check allowed entities
    my.return_count = count(my.method.return)
    if my.return_count > 1
        my.dump_filename = entity_dump_file(my.method)
        echo_fatal("Expected zero one entity: return.\n" + \
                   "But found $(my.return_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.method.return as _return
        new restrictions
            return_validate(_return, restrictions)
        endnew
    endfor

    my.argument_count = count(my.method.argument)
    for my.method.argument as _argument
        new restrictions
            argument_validate(_argument, restrictions)
        endnew
    endfor

    my.variable_count = count(my.method.variable)
    for my.method.variable as _variable
        new restrictions
            variable_validate(_variable, restrictions)
        endnew
    endfor

    my.code_count = count(my.method.code)
    if my.code_count > 1
        my.dump_filename = entity_dump_file(my.method)
        echo_fatal("Expected zero one entity: code.\n" + \
                   "But found $(my.code_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.method.code as _code
        new restrictions
            code_validate(_code, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.method.name?)\"", my)
    endif

    if !defined(my.method.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.method, "name")
    endif

    my.restrictions.attr_is_static_apply ?= "1"
    my.restrictions.attr_is_static_required ?= "0"

    if my.restrictions.attr_is_static_apply
        echo_trace("     Validate attribute: is_static=\"$(my.method.is_static?)\"", my)
    endif

    if !defined(my.method.is_static) & \
                my.restrictions.attr_is_static_apply & my.restrictions.attr_is_static_required
        echo_fatal_required_attr(my.method, "is_static")
    endif
    if my.restrictions.attr_is_static_apply & defined(my.method.is_static)
        my.is_static_is_valid = "0"
        my.is_static_is_valid = my.is_static_is_valid | (my.method.is_static = "0")
        my.is_static_is_valid = my.is_static_is_valid | (my.method.is_static = "1")
        if !my.is_static_is_valid
            echo_fatal_resticted_attr(my.method, "is_static", "0, 1")
        endif
    endif

    my.restrictions.attr_is_const_apply ?= "1"
    my.restrictions.attr_is_const_required ?= "0"

    if my.restrictions.attr_is_const_apply
        echo_trace("     Validate attribute: is_const=\"$(my.method.is_const?)\"", my)
    endif

    if !defined(my.method.is_const) & \
                my.restrictions.attr_is_const_apply & my.restrictions.attr_is_const_required
        echo_fatal_required_attr(my.method, "is_const")
    endif
    if my.restrictions.attr_is_const_apply & defined(my.method.is_const)
        my.is_const_is_valid = "0"
        my.is_const_is_valid = my.is_const_is_valid | (my.method.is_const = "0")
        my.is_const_is_valid = my.is_const_is_valid | (my.method.is_const = "1")
        if !my.is_const_is_valid
            echo_fatal_resticted_attr(my.method, "is_const", "0, 1")
        endif
    endif

    my.restrictions.attr_nodiscard_apply ?= "1"
    my.restrictions.attr_nodiscard_required ?= "0"

    if my.restrictions.attr_nodiscard_apply
        echo_trace("     Validate attribute: nodiscard=\"$(my.method.nodiscard?)\"", my)
    endif

    if !defined(my.method.nodiscard) & \
                my.restrictions.attr_nodiscard_apply & my.restrictions.attr_nodiscard_required
        echo_fatal_required_attr(my.method, "nodiscard")
    endif
    if my.restrictions.attr_nodiscard_apply & defined(my.method.nodiscard)
        my.nodiscard_is_valid = "0"
        my.nodiscard_is_valid = my.nodiscard_is_valid | (my.method.nodiscard = "0")
        my.nodiscard_is_valid = my.nodiscard_is_valid | (my.method.nodiscard = "1")
        if !my.nodiscard_is_valid
            echo_fatal_resticted_attr(my.method, "nodiscard", "0, 1")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function method_validate_resolved(method, restrictions)
    my.method_name = defined(my.method.name) ?? " name=\"$(my.method.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.method))$(my.method_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate_resolved(my.method, restrictions)
    endnew

    new restrictions
        visibility_validate_resolved(my.method, restrictions)
    endnew

    new restrictions
        declaration_validate_resolved(my.method, restrictions)
    endnew

    new restrictions
        definition_validate_resolved(my.method, restrictions)
    endnew

    #    Check allowed entities
    for my.method.return as _return
        new restrictions
            return_validate_resolved(_return, restrictions)
        endnew
    endfor

    for my.method.argument as _argument
        new restrictions
            argument_validate_resolved(_argument, restrictions)
        endnew
    endfor

    for my.method.variable as _variable
        new restrictions
            variable_validate_resolved(_variable, restrictions)
        endnew
    endfor

    for my.method.code as _code
        new restrictions
            code_validate_resolved(_code, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.method.name?)\"", my)
    endif

    if !defined(my.method.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.method, "name")
    endif

    my.restrictions.attr_is_static_apply ?= "1"
    my.restrictions.attr_is_static_required ?= "0"

    if my.restrictions.attr_is_static_apply
        echo_trace("     Validate attribute: is_static=\"$(my.method.is_static?)\"", my)
    endif

    if !defined(my.method.is_static) & \
                my.restrictions.attr_is_static_apply & my.restrictions.attr_is_static_required
        echo_fatal_required_attr(my.method, "is_static")
    endif
    if my.restrictions.attr_is_static_apply & defined(my.method.is_static)
        my.is_static_is_valid = "0"
        my.is_static_is_valid = my.is_static_is_valid | (my.method.is_static = "0")
        my.is_static_is_valid = my.is_static_is_valid | (my.method.is_static = "1")
        if !my.is_static_is_valid
            echo_fatal_resticted_attr(my.method, "is_static", "0, 1")
        endif
    endif

    my.restrictions.attr_is_const_apply ?= "1"
    my.restrictions.attr_is_const_required ?= "0"

    if my.restrictions.attr_is_const_apply
        echo_trace("     Validate attribute: is_const=\"$(my.method.is_const?)\"", my)
    endif

    if !defined(my.method.is_const) & \
                my.restrictions.attr_is_const_apply & my.restrictions.attr_is_const_required
        echo_fatal_required_attr(my.method, "is_const")
    endif
    if my.restrictions.attr_is_const_apply & defined(my.method.is_const)
        my.is_const_is_valid = "0"
        my.is_const_is_valid = my.is_const_is_valid | (my.method.is_const = "0")
        my.is_const_is_valid = my.is_const_is_valid | (my.method.is_const = "1")
        if !my.is_const_is_valid
            echo_fatal_resticted_attr(my.method, "is_const", "0, 1")
        endif
    endif

    my.restrictions.attr_nodiscard_apply ?= "1"
    my.restrictions.attr_nodiscard_required ?= "0"

    if my.restrictions.attr_nodiscard_apply
        echo_trace("     Validate attribute: nodiscard=\"$(my.method.nodiscard?)\"", my)
    endif

    if !defined(my.method.nodiscard) & \
                my.restrictions.attr_nodiscard_apply & my.restrictions.attr_nodiscard_required
        echo_fatal_required_attr(my.method, "nodiscard")
    endif
    if my.restrictions.attr_nodiscard_apply & defined(my.method.nodiscard)
        my.nodiscard_is_valid = "0"
        my.nodiscard_is_valid = my.nodiscard_is_valid | (my.method.nodiscard = "0")
        my.nodiscard_is_valid = my.nodiscard_is_valid | (my.method.nodiscard = "1")
        if !my.nodiscard_is_valid
            echo_fatal_resticted_attr(my.method, "nodiscard", "0, 1")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function macros_setup_defaults(macros, defaults)
    my.macros_name = defined(my.macros.name) ?? " name=\"$(my.macros.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.macros))$(my.macros_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
     my.defaults.default = "public"
    definition_setup_defaults(my.macros, my.defaults)

    #    Setup defaults for allowed entities
    for my.macros.code as _code
        code_setup_defaults(_code)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.macros.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.macros.name = my.default_value
    endif

    my.default_value = my.defaults.is_method ? "0"
    if defined(my.default_value) & !defined(my.macros.is_method)
        echo_trace("       is_method=\"$(my.default_value:)\"", my)
        my.macros.is_method = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function macros_validate(macros, restrictions)
    my.macros_name = defined(my.macros.name) ?? " name=\"$(my.macros.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.macros))$(my.macros_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        .attr_default_apply = "0"
        .attr_default_required = "0"
        definition_validate(my.macros, restrictions)
    endnew

    #    Check allowed entities
    my.code_count = count(my.macros.code)
    if my.code_count > 1
        my.dump_filename = entity_dump_file(my.macros)
        echo_fatal("Expected zero one entity: code.\n" + \
                   "But found $(my.code_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.macros.code as _code
        new restrictions
            code_validate(_code, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.macros.name?)\"", my)
    endif

    if !defined(my.macros.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.macros, "name")
    endif

    my.restrictions.attr_is_method_apply ?= "1"
    my.restrictions.attr_is_method_required ?= "0"

    if my.restrictions.attr_is_method_apply
        echo_trace("     Validate attribute: is_method=\"$(my.macros.is_method?)\"", my)
    endif

    if !defined(my.macros.is_method) & \
                my.restrictions.attr_is_method_apply & my.restrictions.attr_is_method_required
        echo_fatal_required_attr(my.macros, "is_method")
    endif
    if my.restrictions.attr_is_method_apply & defined(my.macros.is_method)
        my.is_method_is_valid = "0"
        my.is_method_is_valid = my.is_method_is_valid | (my.macros.is_method = "0")
        my.is_method_is_valid = my.is_method_is_valid | (my.macros.is_method = "1")
        if !my.is_method_is_valid
            echo_fatal_resticted_attr(my.macros, "is_method", "0, 1")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function macros_validate_resolved(macros, restrictions)
    my.macros_name = defined(my.macros.name) ?? " name=\"$(my.macros.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.macros))$(my.macros_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        definition_validate_resolved(my.macros, restrictions)
    endnew

    #    Check allowed entities
    for my.macros.code as _code
        new restrictions
            code_validate_resolved(_code, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.macros.name?)\"", my)
    endif

    if !defined(my.macros.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.macros, "name")
    endif

    my.restrictions.attr_is_method_apply ?= "1"
    my.restrictions.attr_is_method_required ?= "0"

    if my.restrictions.attr_is_method_apply
        echo_trace("     Validate attribute: is_method=\"$(my.macros.is_method?)\"", my)
    endif

    if !defined(my.macros.is_method) & \
                my.restrictions.attr_is_method_apply & my.restrictions.attr_is_method_required
        echo_fatal_required_attr(my.macros, "is_method")
    endif
    if my.restrictions.attr_is_method_apply & defined(my.macros.is_method)
        my.is_method_is_valid = "0"
        my.is_method_is_valid = my.is_method_is_valid | (my.macros.is_method = "0")
        my.is_method_is_valid = my.is_method_is_valid | (my.macros.is_method = "1")
        if !my.is_method_is_valid
            echo_fatal_resticted_attr(my.macros, "is_method", "0, 1")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function macroses_setup_defaults(macroses, defaults)
    my.macroses_name = defined(my.macroses.name) ?? " name=\"$(my.macroses.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.macroses))$(my.macroses_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
     my.defaults.default = "public"
    definition_setup_defaults(my.macroses, my.defaults)

    #    Setup defaults for allowed entities
    for my.macroses.macros as _macros
        macros_setup_defaults(_macros)
    endfor

    for my.macroses.code as _code
        code_setup_defaults(_code)
    endfor

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function macroses_validate(macroses, restrictions)
    my.macroses_name = defined(my.macroses.name) ?? " name=\"$(my.macroses.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.macroses))$(my.macroses_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        .attr_default_apply = "0"
        .attr_default_required = "0"
        definition_validate(my.macroses, restrictions)
    endnew

    #    Check allowed entities
    my.macros_count = count(my.macroses.macros)
    if my.macros_count < 1
        my.dump_filename = entity_dump_file(my.macroses)
        echo_fatal("Expected one or more entities: macros.\n" + \
                   "But found $(my.macros_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.macroses.macros as _macros
        new restrictions
            macros_validate(_macros, restrictions)
        endnew
    endfor

    my.code_count = count(my.macroses.code)
    if my.code_count <> 1
        my.dump_filename = entity_dump_file(my.macroses)
        echo_fatal("Expected exectly one entity: code.\n" + \
                   "But found $(my.code_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.macroses.code as _code
        new restrictions
            code_validate(_code, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function macroses_validate_resolved(macroses, restrictions)
    my.macroses_name = defined(my.macroses.name) ?? " name=\"$(my.macroses.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.macroses))$(my.macroses_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        definition_validate_resolved(my.macroses, restrictions)
    endnew

    #    Check allowed entities
    for my.macroses.macros as _macros
        new restrictions
            macros_validate_resolved(_macros, restrictions)
        endnew
    endfor

    for my.macroses.code as _code
        new restrictions
            code_validate_resolved(_code, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function struct_setup_defaults(struct, defaults)
    my.struct_name = defined(my.struct.name) ?? " name=\"$(my.struct.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.struct))$(my.struct_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    scoped_component_setup_defaults(my.struct, my.defaults)
    visibility_setup_defaults(my.struct, my.defaults)
    declaration_setup_defaults(my.struct, my.defaults)
    definition_setup_defaults(my.struct, my.defaults)

    #    Setup defaults for allowed entities
    for my.struct.property as _property
        property_setup_defaults(_property)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.struct.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.struct.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function struct_validate(struct, restrictions)
    my.struct_name = defined(my.struct.name) ?? " name=\"$(my.struct.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.struct))$(my.struct_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate(my.struct, restrictions)
    endnew

    new restrictions
        visibility_validate(my.struct, restrictions)
    endnew

    new restrictions
        declaration_validate(my.struct, restrictions)
    endnew

    new restrictions
        definition_validate(my.struct, restrictions)
    endnew

    #    Check allowed entities
    my.property_count = count(my.struct.property)
    for my.struct.property as _property
        new restrictions
            property_validate(_property, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.struct.name?)\"", my)
    endif

    if !defined(my.struct.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.struct, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function struct_validate_resolved(struct, restrictions)
    my.struct_name = defined(my.struct.name) ?? " name=\"$(my.struct.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.struct))$(my.struct_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scoped_component_validate_resolved(my.struct, restrictions)
    endnew

    new restrictions
        visibility_validate_resolved(my.struct, restrictions)
    endnew

    new restrictions
        declaration_validate_resolved(my.struct, restrictions)
    endnew

    new restrictions
        definition_validate_resolved(my.struct, restrictions)
    endnew

    #    Check allowed entities
    for my.struct.property as _property
        new restrictions
            property_validate_resolved(_property, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.struct.name?)\"", my)
    endif

    if !defined(my.struct.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.struct, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function class_setup_defaults(class, defaults)
    my.class_name = defined(my.class.name) ?? " name=\"$(my.class.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.class))$(my.class_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    scope_setup_defaults(my.class, my.defaults)
    c_prefix_setup_defaults(my.class, my.defaults)
    uid_setup_defaults(my.class, my.defaults)
    visibility_setup_defaults(my.class, my.defaults)

    #    Setup defaults for allowed entities
    for my.class.require as _require
        require_setup_defaults(_require)
    endfor

    for my.class.dependency as _dependency
        dependency_setup_defaults(_dependency)
    endfor

    new defaults
        for my.class.constant as _constant
            constant_setup_defaults(_constant, defaults)
        endfor
        delete defaults
    endnew

    for my.class.property as _property
        property_setup_defaults(_property)
    endfor

    for my.class.enum as _enum
        enum_setup_defaults(_enum)
    endfor

    for my.class.callback as _callback
        callback_setup_defaults(_callback)
    endfor

    for my.class.method as _method
        method_setup_defaults(_method)
    endfor

    for my.class.macros as _macros
        macros_setup_defaults(_macros)
    endfor

    for my.class.macroses as _macroses
        macroses_setup_defaults(_macroses)
    endfor

    for my.class.struct as _struct
        struct_setup_defaults(_struct)
    endfor

    for my.class.variable as _variable
        variable_setup_defaults(_variable)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.class.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.class.name = my.default_value
    endif

    my.default_value = my.defaults.context ? "none"
    if defined(my.default_value) & !defined(my.class.context)
        echo_trace("       context=\"$(my.default_value:)\"", my)
        my.class.context = my.default_value
    endif

    my.default_value = my.defaults.lifecycle ? "default"
    if defined(my.default_value) & !defined(my.class.lifecycle)
        echo_trace("       lifecycle=\"$(my.default_value:)\"", my)
        my.class.lifecycle = my.default_value
    endif

    my.default_value = my.defaults.is_value_type ? "0"
    if defined(my.default_value) & !defined(my.class.is_value_type)
        echo_trace("       is_value_type=\"$(my.default_value:)\"", my)
        my.class.is_value_type = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function class_validate(class, restrictions)
    my.class_name = defined(my.class.name) ?? " name=\"$(my.class.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.class))$(my.class_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scope_validate(my.class, restrictions)
    endnew

    new restrictions
        c_prefix_validate(my.class, restrictions)
    endnew

    new restrictions
        uid_validate(my.class, restrictions)
    endnew

    new restrictions
        visibility_validate(my.class, restrictions)
    endnew

    #    Check allowed entities
    my.require_count = count(my.class.require)
    for my.class.require as _require
        new restrictions
            require_validate(_require, restrictions)
        endnew
    endfor

    my.dependency_count = count(my.class.dependency)
    for my.class.dependency as _dependency
        new restrictions
            dependency_validate(_dependency, restrictions)
        endnew
    endfor

    my.constant_count = count(my.class.constant)
    for my.class.constant as _constant
        new restrictions
            .attr_value_apply = "1"
            .attr_value_required = "1"
            constant_validate(_constant, restrictions)
        endnew
    endfor

    my.property_count = count(my.class.property)
    for my.class.property as _property
        new restrictions
            property_validate(_property, restrictions)
        endnew
    endfor

    my.enum_count = count(my.class.enum)
    for my.class.enum as _enum
        new restrictions
            enum_validate(_enum, restrictions)
        endnew
    endfor

    my.callback_count = count(my.class.callback)
    for my.class.callback as _callback
        new restrictions
            callback_validate(_callback, restrictions)
        endnew
    endfor

    my.method_count = count(my.class.method)
    for my.class.method as _method
        new restrictions
            method_validate(_method, restrictions)
        endnew
    endfor

    my.macros_count = count(my.class.macros)
    for my.class.macros as _macros
        new restrictions
            macros_validate(_macros, restrictions)
        endnew
    endfor

    my.macroses_count = count(my.class.macroses)
    for my.class.macroses as _macroses
        new restrictions
            macroses_validate(_macroses, restrictions)
        endnew
    endfor

    my.struct_count = count(my.class.struct)
    for my.class.struct as _struct
        new restrictions
            struct_validate(_struct, restrictions)
        endnew
    endfor

    my.variable_count = count(my.class.variable)
    for my.class.variable as _variable
        new restrictions
            variable_validate(_variable, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.class.name?)\"", my)
    endif

    if !defined(my.class.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.class, "name")
    endif

    my.restrictions.attr_context_apply ?= "1"
    my.restrictions.attr_context_required ?= "0"

    if my.restrictions.attr_context_apply
        echo_trace("     Validate attribute: context=\"$(my.class.context?)\"", my)
    endif

    if !defined(my.class.context) & \
                my.restrictions.attr_context_apply & my.restrictions.attr_context_required
        echo_fatal_required_attr(my.class, "context")
    endif
    if my.restrictions.attr_context_apply & defined(my.class.context)
        my.context_is_valid = "0"
        my.context_is_valid = my.context_is_valid | (my.class.context = "none")
        my.context_is_valid = my.context_is_valid | (my.class.context = "public")
        my.context_is_valid = my.context_is_valid | (my.class.context = "private")
        my.context_is_valid = my.context_is_valid | (my.class.context = "internal")
        if !my.context_is_valid
            echo_fatal_resticted_attr(my.class, "context", "none, public, private, internal")
        endif
    endif

    my.restrictions.attr_lifecycle_apply ?= "1"
    my.restrictions.attr_lifecycle_required ?= "0"

    if my.restrictions.attr_lifecycle_apply
        echo_trace("     Validate attribute: lifecycle=\"$(my.class.lifecycle?)\"", my)
    endif

    if !defined(my.class.lifecycle) & \
                my.restrictions.attr_lifecycle_apply & my.restrictions.attr_lifecycle_required
        echo_fatal_required_attr(my.class, "lifecycle")
    endif
    if my.restrictions.attr_lifecycle_apply & defined(my.class.lifecycle)
        my.lifecycle_is_valid = "0"
        my.lifecycle_is_valid = my.lifecycle_is_valid | (my.class.lifecycle = "none")
        my.lifecycle_is_valid = my.lifecycle_is_valid | (my.class.lifecycle = "default")
        if !my.lifecycle_is_valid
            echo_fatal_resticted_attr(my.class, "lifecycle", "none, default")
        endif
    endif

    my.restrictions.attr_is_value_type_apply ?= "1"
    my.restrictions.attr_is_value_type_required ?= "0"

    if my.restrictions.attr_is_value_type_apply
        echo_trace("     Validate attribute: is_value_type=\"$(my.class.is_value_type?)\"", my)
    endif

    if !defined(my.class.is_value_type) & \
                my.restrictions.attr_is_value_type_apply & my.restrictions.attr_is_value_type_required
        echo_fatal_required_attr(my.class, "is_value_type")
    endif
    if my.restrictions.attr_is_value_type_apply & defined(my.class.is_value_type)
        my.is_value_type_is_valid = "0"
        my.is_value_type_is_valid = my.is_value_type_is_valid | (my.class.is_value_type = "0")
        my.is_value_type_is_valid = my.is_value_type_is_valid | (my.class.is_value_type = "1")
        if !my.is_value_type_is_valid
            echo_fatal_resticted_attr(my.class, "is_value_type", "0, 1")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function class_validate_resolved(class, restrictions)
    my.class_name = defined(my.class.name) ?? " name=\"$(my.class.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.class))$(my.class_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scope_validate_resolved(my.class, restrictions)
    endnew

    new restrictions
        c_prefix_validate_resolved(my.class, restrictions)
    endnew

    new restrictions
        uid_validate_resolved(my.class, restrictions)
    endnew

    new restrictions
        visibility_validate_resolved(my.class, restrictions)
    endnew

    #    Check allowed entities
    for my.class.require as _require
        new restrictions
            require_validate_resolved(_require, restrictions)
        endnew
    endfor

    for my.class.dependency as _dependency
        new restrictions
            dependency_validate_resolved(_dependency, restrictions)
        endnew
    endfor

    for my.class.constant as _constant
        new restrictions
            .attr_value_apply = "1"
            .attr_value_required = "1"
            constant_validate_resolved(_constant, restrictions)
        endnew
    endfor

    for my.class.property as _property
        new restrictions
            property_validate_resolved(_property, restrictions)
        endnew
    endfor

    for my.class.enum as _enum
        new restrictions
            enum_validate_resolved(_enum, restrictions)
        endnew
    endfor

    for my.class.callback as _callback
        new restrictions
            callback_validate_resolved(_callback, restrictions)
        endnew
    endfor

    for my.class.method as _method
        new restrictions
            method_validate_resolved(_method, restrictions)
        endnew
    endfor

    for my.class.macros as _macros
        new restrictions
            macros_validate_resolved(_macros, restrictions)
        endnew
    endfor

    for my.class.macroses as _macroses
        new restrictions
            macroses_validate_resolved(_macroses, restrictions)
        endnew
    endfor

    for my.class.struct as _struct
        new restrictions
            struct_validate_resolved(_struct, restrictions)
        endnew
    endfor

    for my.class.variable as _variable
        new restrictions
            variable_validate_resolved(_variable, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.class.name?)\"", my)
    endif

    if !defined(my.class.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.class, "name")
    endif

    my.restrictions.attr_context_apply ?= "1"
    my.restrictions.attr_context_required ?= "0"

    if my.restrictions.attr_context_apply
        echo_trace("     Validate attribute: context=\"$(my.class.context?)\"", my)
    endif

    if !defined(my.class.context) & \
                my.restrictions.attr_context_apply & my.restrictions.attr_context_required
        echo_fatal_required_attr(my.class, "context")
    endif
    if my.restrictions.attr_context_apply & defined(my.class.context)
        my.context_is_valid = "0"
        my.context_is_valid = my.context_is_valid | (my.class.context = "none")
        my.context_is_valid = my.context_is_valid | (my.class.context = "public")
        my.context_is_valid = my.context_is_valid | (my.class.context = "private")
        my.context_is_valid = my.context_is_valid | (my.class.context = "internal")
        if !my.context_is_valid
            echo_fatal_resticted_attr(my.class, "context", "none, public, private, internal")
        endif
    endif

    my.restrictions.attr_lifecycle_apply ?= "1"
    my.restrictions.attr_lifecycle_required ?= "0"

    if my.restrictions.attr_lifecycle_apply
        echo_trace("     Validate attribute: lifecycle=\"$(my.class.lifecycle?)\"", my)
    endif

    if !defined(my.class.lifecycle) & \
                my.restrictions.attr_lifecycle_apply & my.restrictions.attr_lifecycle_required
        echo_fatal_required_attr(my.class, "lifecycle")
    endif
    if my.restrictions.attr_lifecycle_apply & defined(my.class.lifecycle)
        my.lifecycle_is_valid = "0"
        my.lifecycle_is_valid = my.lifecycle_is_valid | (my.class.lifecycle = "none")
        my.lifecycle_is_valid = my.lifecycle_is_valid | (my.class.lifecycle = "default")
        if !my.lifecycle_is_valid
            echo_fatal_resticted_attr(my.class, "lifecycle", "none, default")
        endif
    endif

    my.restrictions.attr_is_value_type_apply ?= "1"
    my.restrictions.attr_is_value_type_required ?= "0"

    if my.restrictions.attr_is_value_type_apply
        echo_trace("     Validate attribute: is_value_type=\"$(my.class.is_value_type?)\"", my)
    endif

    if !defined(my.class.is_value_type) & \
                my.restrictions.attr_is_value_type_apply & my.restrictions.attr_is_value_type_required
        echo_fatal_required_attr(my.class, "is_value_type")
    endif
    if my.restrictions.attr_is_value_type_apply & defined(my.class.is_value_type)
        my.is_value_type_is_valid = "0"
        my.is_value_type_is_valid = my.is_value_type_is_valid | (my.class.is_value_type = "0")
        my.is_value_type_is_valid = my.is_value_type_is_valid | (my.class.is_value_type = "1")
        if !my.is_value_type_is_valid
            echo_fatal_resticted_attr(my.class, "is_value_type", "0, 1")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function inherit_setup_defaults(inherit, defaults)
    my.inherit_name = defined(my.inherit.name) ?? " name=\"$(my.inherit.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.inherit))$(my.inherit_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.interface ?
    if defined(my.default_value) & !defined(my.inherit.interface)
        echo_trace("       interface=\"$(my.default_value:)\"", my)
        my.inherit.interface = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function inherit_validate(inherit, restrictions)
    my.inherit_name = defined(my.inherit.name) ?? " name=\"$(my.inherit.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.inherit))$(my.inherit_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_interface_apply ?= "1"
    my.restrictions.attr_interface_required ?= "1"

    if my.restrictions.attr_interface_apply
        echo_trace("     Validate attribute: interface=\"$(my.inherit.interface?)\"", my)
    endif

    if !defined(my.inherit.interface) & \
                my.restrictions.attr_interface_apply & my.restrictions.attr_interface_required
        echo_fatal_required_attr(my.inherit, "interface")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function inherit_validate_resolved(inherit, restrictions)
    my.inherit_name = defined(my.inherit.name) ?? " name=\"$(my.inherit.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.inherit))$(my.inherit_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_interface_apply ?= "1"
    my.restrictions.attr_interface_required ?= "1"

    if my.restrictions.attr_interface_apply
        echo_trace("     Validate attribute: interface=\"$(my.inherit.interface?)\"", my)
    endif

    if !defined(my.inherit.interface) & \
                my.restrictions.attr_interface_apply & my.restrictions.attr_interface_required
        echo_fatal_required_attr(my.inherit, "interface")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function interface_setup_defaults(interface, defaults)
    my.interface_name = defined(my.interface.name) ?? " name=\"$(my.interface.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.interface))$(my.interface_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    scope_setup_defaults(my.interface, my.defaults)
    visibility_setup_defaults(my.interface, my.defaults)
    uid_setup_defaults(my.interface, my.defaults)
    c_prefix_setup_defaults(my.interface, my.defaults)

    #    Setup defaults for allowed entities
    new defaults
        for my.interface.constant as _constant
            constant_setup_defaults(_constant, defaults)
        endfor
        delete defaults
    endnew

    for my.interface.method as _method
        method_setup_defaults(_method)
    endfor

    for my.interface.inherit as _inherit
        inherit_setup_defaults(_inherit)
    endfor

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function interface_validate(interface, restrictions)
    my.interface_name = defined(my.interface.name) ?? " name=\"$(my.interface.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.interface))$(my.interface_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scope_validate(my.interface, restrictions)
    endnew

    new restrictions
        visibility_validate(my.interface, restrictions)
    endnew

    new restrictions
        uid_validate(my.interface, restrictions)
    endnew

    new restrictions
        c_prefix_validate(my.interface, restrictions)
    endnew

    #    Check allowed entities
    my.constant_count = count(my.interface.constant)
    for my.interface.constant as _constant
        new restrictions
            .attr_value_apply = "1"
            .attr_value_required = "0"
            constant_validate(_constant, restrictions)
        endnew
    endfor

    my.method_count = count(my.interface.method)
    for my.interface.method as _method
        new restrictions
            method_validate(_method, restrictions)
        endnew
    endfor

    my.inherit_count = count(my.interface.inherit)
    for my.interface.inherit as _inherit
        new restrictions
            inherit_validate(_inherit, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function interface_validate_resolved(interface, restrictions)
    my.interface_name = defined(my.interface.name) ?? " name=\"$(my.interface.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.interface))$(my.interface_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scope_validate_resolved(my.interface, restrictions)
    endnew

    new restrictions
        visibility_validate_resolved(my.interface, restrictions)
    endnew

    new restrictions
        uid_validate_resolved(my.interface, restrictions)
    endnew

    new restrictions
        c_prefix_validate_resolved(my.interface, restrictions)
    endnew

    #    Check allowed entities
    for my.interface.constant as _constant
        new restrictions
            .attr_value_apply = "1"
            .attr_value_required = "0"
            constant_validate_resolved(_constant, restrictions)
        endnew
    endfor

    for my.interface.method as _method
        new restrictions
            method_validate_resolved(_method, restrictions)
        endnew
    endfor

    for my.interface.inherit as _inherit
        new restrictions
            inherit_validate_resolved(_inherit, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function context_setup_defaults(context, defaults)
    my.context_name = defined(my.context.name) ?? " name=\"$(my.context.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.context))$(my.context_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for allowed entities
    for my.context.require as _require
        require_setup_defaults(_require)
    endfor

    for my.context.property as _property
        property_setup_defaults(_property)
    endfor

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function context_validate(context, restrictions)
    my.context_name = defined(my.context.name) ?? " name=\"$(my.context.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.context))$(my.context_name)/>", my)

    #    Check allowed entities
    my.require_count = count(my.context.require)
    for my.context.require as _require
        new restrictions
            require_validate(_require, restrictions)
        endnew
    endfor

    my.property_count = count(my.context.property)
    for my.context.property as _property
        new restrictions
            property_validate(_property, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function context_validate_resolved(context, restrictions)
    my.context_name = defined(my.context.name) ?? " name=\"$(my.context.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.context))$(my.context_name)/>", my)

    #    Check allowed entities
    for my.context.require as _require
        new restrictions
            require_validate_resolved(_require, restrictions)
        endnew
    endfor

    for my.context.property as _property
        new restrictions
            property_validate_resolved(_property, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function implemented_interface_setup_defaults(interface, defaults)
    my.interface_name = defined(my.interface.name) ?? " name=\"$(my.interface.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.interface))$(my.interface_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for allowed entities
    for my.interface.constant as _constant
        constant_setup_defaults(_constant)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.interface.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.interface.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function implemented_interface_validate(interface, restrictions)
    my.interface_name = defined(my.interface.name) ?? " name=\"$(my.interface.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.interface))$(my.interface_name)/>", my)

    #    Check allowed entities
    my.constant_count = count(my.interface.constant)
    for my.interface.constant as _constant
        new restrictions
            constant_validate(_constant, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.interface.name?)\"", my)
    endif

    if !defined(my.interface.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.interface, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function implemented_interface_validate_resolved(interface, restrictions)
    my.interface_name = defined(my.interface.name) ?? " name=\"$(my.interface.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.interface))$(my.interface_name)/>", my)

    #    Check allowed entities
    for my.interface.constant as _constant
        new restrictions
            constant_validate_resolved(_constant, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.interface.name?)\"", my)
    endif

    if !defined(my.interface.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.interface, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function implementation_setup_defaults(implementation, defaults)
    my.implementation_name = defined(my.implementation.name) ?? " name=\"$(my.implementation.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.implementation))$(my.implementation_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    scope_setup_defaults(my.implementation, my.defaults)
    visibility_setup_defaults(my.implementation, my.defaults)
    uid_setup_defaults(my.implementation, my.defaults)
    c_prefix_setup_defaults(my.implementation, my.defaults)

    #    Setup defaults for allowed entities
    for my.implementation.context as _context
        context_setup_defaults(_context)
    endfor

    for my.implementation.interface as _interface
        implemented_interface_setup_defaults(_interface)
    endfor

    for my.implementation.dependency as _dependency
        dependency_setup_defaults(_dependency)
    endfor

    for my.implementation.require as _require
        require_setup_defaults(_require)
    endfor

    new defaults
        .visibility = "private"
        .declaration = "private"
        .defnition = "private"
        for my.implementation.method as _method
            method_setup_defaults(_method, defaults)
        endfor
        delete defaults
    endnew

    new defaults
        .declaration = "private"
        .defnition = "private"
        for my.implementation.enum as _enum
            enum_setup_defaults(_enum, defaults)
        endfor
        delete defaults
    endnew

    new defaults
        .defnition = "private"
        for my.implementation.constant as _constant
            constant_setup_defaults(_constant, defaults)
        endfor
        delete defaults
    endnew

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.implementation.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.implementation.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function implementation_validate(implementation, restrictions)
    my.implementation_name = defined(my.implementation.name) ?? " name=\"$(my.implementation.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.implementation))$(my.implementation_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scope_validate(my.implementation, restrictions)
    endnew

    new restrictions
        visibility_validate(my.implementation, restrictions)
    endnew

    new restrictions
        uid_validate(my.implementation, restrictions)
    endnew

    new restrictions
        c_prefix_validate(my.implementation, restrictions)
    endnew

    #    Check allowed entities
    my.context_count = count(my.implementation.context)
    if my.context_count > 1
        my.dump_filename = entity_dump_file(my.implementation)
        echo_fatal("Expected zero one entity: context.\n" + \
                   "But found $(my.context_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.implementation.context as _context
        new restrictions
            context_validate(_context, restrictions)
        endnew
    endfor

    my.interface_count = count(my.implementation.interface)
    if my.interface_count < 1
        my.dump_filename = entity_dump_file(my.implementation)
        echo_fatal("Expected one or more entities: interface.\n" + \
                   "But found $(my.interface_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.implementation.interface as _interface
        new restrictions
            implemented_interface_validate(_interface, restrictions)
        endnew
    endfor

    my.dependency_count = count(my.implementation.dependency)
    for my.implementation.dependency as _dependency
        new restrictions
            dependency_validate(_dependency, restrictions)
        endnew
    endfor

    my.require_count = count(my.implementation.require)
    for my.implementation.require as _require
        new restrictions
            require_validate(_require, restrictions)
        endnew
    endfor

    my.method_count = count(my.implementation.method)
    for my.implementation.method as _method
        new restrictions
            .attr_visibility_apply = "1"
            .attr_visibility_required = "0"
            .attr_declaration_apply = "1"
            .attr_declaration_required = "0"
            .attr_defnition_apply = "1"
            .attr_defnition_required = "0"
            method_validate(_method, restrictions)
        endnew
    endfor

    my.enum_count = count(my.implementation.enum)
    for my.implementation.enum as _enum
        new restrictions
            .attr_declaration_apply = "1"
            .attr_declaration_required = "0"
            .attr_defnition_apply = "1"
            .attr_defnition_required = "0"
            enum_validate(_enum, restrictions)
        endnew
    endfor

    my.constant_count = count(my.implementation.constant)
    for my.implementation.constant as _constant
        new restrictions
            .attr_value_apply = "1"
            .attr_value_required = "1"
            .attr_defnition_apply = "1"
            .attr_defnition_required = "0"
            constant_validate(_constant, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.implementation.name?)\"", my)
    endif

    if !defined(my.implementation.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.implementation, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function implementation_validate_resolved(implementation, restrictions)
    my.implementation_name = defined(my.implementation.name) ?? " name=\"$(my.implementation.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.implementation))$(my.implementation_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scope_validate_resolved(my.implementation, restrictions)
    endnew

    new restrictions
        visibility_validate_resolved(my.implementation, restrictions)
    endnew

    new restrictions
        uid_validate_resolved(my.implementation, restrictions)
    endnew

    new restrictions
        c_prefix_validate_resolved(my.implementation, restrictions)
    endnew

    #    Check allowed entities
    for my.implementation.context as _context
        new restrictions
            context_validate_resolved(_context, restrictions)
        endnew
    endfor

    for my.implementation.interface as _interface
        new restrictions
            implemented_interface_validate_resolved(_interface, restrictions)
        endnew
    endfor

    for my.implementation.dependency as _dependency
        new restrictions
            dependency_validate_resolved(_dependency, restrictions)
        endnew
    endfor

    for my.implementation.require as _require
        new restrictions
            require_validate_resolved(_require, restrictions)
        endnew
    endfor

    for my.implementation.method as _method
        new restrictions
            .attr_visibility_apply = "1"
            .attr_visibility_required = "0"
            .attr_declaration_apply = "1"
            .attr_declaration_required = "0"
            .attr_defnition_apply = "1"
            .attr_defnition_required = "0"
            method_validate_resolved(_method, restrictions)
        endnew
    endfor

    for my.implementation.enum as _enum
        new restrictions
            .attr_declaration_apply = "1"
            .attr_declaration_required = "0"
            .attr_defnition_apply = "1"
            .attr_defnition_required = "0"
            enum_validate_resolved(_enum, restrictions)
        endnew
    endfor

    for my.implementation.constant as _constant
        new restrictions
            .attr_value_apply = "1"
            .attr_value_required = "1"
            .attr_defnition_apply = "1"
            .attr_defnition_required = "0"
            constant_validate_resolved(_constant, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.implementation.name?)\"", my)
    endif

    if !defined(my.implementation.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.implementation, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function implementor_setup_defaults(implementor, defaults)
    my.implementor_name = defined(my.implementor.name) ?? " name=\"$(my.implementor.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.implementor))$(my.implementor_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for allowed entities
    for my.implementor.implementation as _implementation
        implementation_setup_defaults(_implementation)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.implementor.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.implementor.name = my.default_value
    endif

    my.default_value = my.defaults.is_default ? "0"
    if defined(my.default_value) & !defined(my.implementor.is_default)
        echo_trace("       is_default=\"$(my.default_value:)\"", my)
        my.implementor.is_default = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function implementor_validate(implementor, restrictions)
    my.implementor_name = defined(my.implementor.name) ?? " name=\"$(my.implementor.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.implementor))$(my.implementor_name)/>", my)

    #    Check allowed entities
    my.implementation_count = count(my.implementor.implementation)
    if my.implementation_count < 1
        my.dump_filename = entity_dump_file(my.implementor)
        echo_fatal("Expected one or more entities: implementation.\n" + \
                   "But found $(my.implementation_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.implementor.implementation as _implementation
        new restrictions
            implementation_validate(_implementation, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.implementor.name?)\"", my)
    endif

    if !defined(my.implementor.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.implementor, "name")
    endif

    my.restrictions.attr_is_default_apply ?= "1"
    my.restrictions.attr_is_default_required ?= "0"

    if my.restrictions.attr_is_default_apply
        echo_trace("     Validate attribute: is_default=\"$(my.implementor.is_default?)\"", my)
    endif

    if !defined(my.implementor.is_default) & \
                my.restrictions.attr_is_default_apply & my.restrictions.attr_is_default_required
        echo_fatal_required_attr(my.implementor, "is_default")
    endif
    if my.restrictions.attr_is_default_apply & defined(my.implementor.is_default)
        my.is_default_is_valid = "0"
        my.is_default_is_valid = my.is_default_is_valid | (my.implementor.is_default = "0")
        my.is_default_is_valid = my.is_default_is_valid | (my.implementor.is_default = "1")
        if !my.is_default_is_valid
            echo_fatal_resticted_attr(my.implementor, "is_default", "0, 1")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function implementor_validate_resolved(implementor, restrictions)
    my.implementor_name = defined(my.implementor.name) ?? " name=\"$(my.implementor.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.implementor))$(my.implementor_name)/>", my)

    #    Check allowed entities
    for my.implementor.implementation as _implementation
        new restrictions
            implementation_validate_resolved(_implementation, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.implementor.name?)\"", my)
    endif

    if !defined(my.implementor.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.implementor, "name")
    endif

    my.restrictions.attr_is_default_apply ?= "1"
    my.restrictions.attr_is_default_required ?= "0"

    if my.restrictions.attr_is_default_apply
        echo_trace("     Validate attribute: is_default=\"$(my.implementor.is_default?)\"", my)
    endif

    if !defined(my.implementor.is_default) & \
                my.restrictions.attr_is_default_apply & my.restrictions.attr_is_default_required
        echo_fatal_required_attr(my.implementor, "is_default")
    endif
    if my.restrictions.attr_is_default_apply & defined(my.implementor.is_default)
        my.is_default_is_valid = "0"
        my.is_default_is_valid = my.is_default_is_valid | (my.implementor.is_default = "0")
        my.is_default_is_valid = my.is_default_is_valid | (my.implementor.is_default = "1")
        if !my.is_default_is_valid
            echo_fatal_resticted_attr(my.implementor, "is_default", "0, 1")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function module_setup_defaults(module, defaults)
    my.module_name = defined(my.module.name) ?? " name=\"$(my.module.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.module))$(my.module_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.module.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.module.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function module_validate(module, restrictions)
    my.module_name = defined(my.module.name) ?? " name=\"$(my.module.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.module))$(my.module_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.module.name?)\"", my)
    endif

    if !defined(my.module.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.module, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function module_validate_resolved(module, restrictions)
    my.module_name = defined(my.module.name) ?? " name=\"$(my.module.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.module))$(my.module_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.module.name?)\"", my)
    endif

    if !defined(my.module.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.module, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function feature_setup_defaults(feature, defaults)
    my.feature_name = defined(my.feature.name) ?? " name=\"$(my.feature.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.feature))$(my.feature_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    landlord_setup_defaults(my.feature, my.defaults)

    #    Setup defaults for allowed entities
    for my.feature.require as _require
        require_setup_defaults(_require)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.feature.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.feature.name = my.default_value
    endif

    my.default_value = my.defaults.prefix ?
    if defined(my.default_value) & !defined(my.feature.prefix)
        echo_trace("       prefix=\"$(my.default_value:)\"", my)
        my.feature.prefix = my.default_value
    endif

    my.default_value = my.defaults.default ? "on"
    if defined(my.default_value) & !defined(my.feature.default)
        echo_trace("       default=\"$(my.default_value:)\"", my)
        my.feature.default = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function feature_validate(feature, restrictions)
    my.feature_name = defined(my.feature.name) ?? " name=\"$(my.feature.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.feature))$(my.feature_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        landlord_validate(my.feature, restrictions)
    endnew

    #    Check allowed entities
    my.require_count = count(my.feature.require)
    for my.feature.require as _require
        new restrictions
            require_validate(_require, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.feature.name?)\"", my)
    endif

    if !defined(my.feature.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.feature, "name")
    endif

    my.restrictions.attr_prefix_apply ?= "1"
    my.restrictions.attr_prefix_required ?= "0"

    if my.restrictions.attr_prefix_apply
        echo_trace("     Validate attribute: prefix=\"$(my.feature.prefix?)\"", my)
    endif

    if !defined(my.feature.prefix) & \
                my.restrictions.attr_prefix_apply & my.restrictions.attr_prefix_required
        echo_fatal_required_attr(my.feature, "prefix")
    endif

    my.restrictions.attr_default_apply ?= "1"
    my.restrictions.attr_default_required ?= "0"

    if my.restrictions.attr_default_apply
        echo_trace("     Validate attribute: default=\"$(my.feature.default?)\"", my)
    endif

    if !defined(my.feature.default) & \
                my.restrictions.attr_default_apply & my.restrictions.attr_default_required
        echo_fatal_required_attr(my.feature, "default")
    endif
    if my.restrictions.attr_default_apply & defined(my.feature.default)
        my.default_is_valid = "0"
        my.default_is_valid = my.default_is_valid | (my.feature.default = "on")
        my.default_is_valid = my.default_is_valid | (my.feature.default = "off")
        if !my.default_is_valid
            echo_fatal_resticted_attr(my.feature, "default", "on, off")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function feature_validate_resolved(feature, restrictions)
    my.feature_name = defined(my.feature.name) ?? " name=\"$(my.feature.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.feature))$(my.feature_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        landlord_validate_resolved(my.feature, restrictions)
    endnew

    #    Check allowed entities
    for my.feature.require as _require
        new restrictions
            require_validate_resolved(_require, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.feature.name?)\"", my)
    endif

    if !defined(my.feature.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.feature, "name")
    endif

    my.restrictions.attr_prefix_apply ?= "1"
    my.restrictions.attr_prefix_required ?= "0"

    if my.restrictions.attr_prefix_apply
        echo_trace("     Validate attribute: prefix=\"$(my.feature.prefix?)\"", my)
    endif

    if !defined(my.feature.prefix) & \
                my.restrictions.attr_prefix_apply & my.restrictions.attr_prefix_required
        echo_fatal_required_attr(my.feature, "prefix")
    endif

    my.restrictions.attr_default_apply ?= "1"
    my.restrictions.attr_default_required ?= "0"

    if my.restrictions.attr_default_apply
        echo_trace("     Validate attribute: default=\"$(my.feature.default?)\"", my)
    endif

    if !defined(my.feature.default) & \
                my.restrictions.attr_default_apply & my.restrictions.attr_default_required
        echo_fatal_required_attr(my.feature, "default")
    endif
    if my.restrictions.attr_default_apply & defined(my.feature.default)
        my.default_is_valid = "0"
        my.default_is_valid = my.default_is_valid | (my.feature.default = "on")
        my.default_is_valid = my.default_is_valid | (my.feature.default = "off")
        if !my.default_is_valid
            echo_fatal_resticted_attr(my.feature, "default", "on, off")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function project_setup_defaults(project, defaults)
    my.project_name = defined(my.project.name) ?? " name=\"$(my.project.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.project))$(my.project_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for allowed entities
    for my.project.interface as _interface
        interface_setup_defaults(_interface)
    endfor

    for my.project.implementor as _implementor
        implementor_setup_defaults(_implementor)
    endfor

    for my.project.module as _module
        module_setup_defaults(_module)
    endfor

    for my.project.feature as _feature
        feature_setup_defaults(_feature)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.project.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.project.name = my.default_value
    endif

    my.default_value = my.defaults.brief ?
    if defined(my.default_value) & !defined(my.project.brief)
        echo_trace("       brief=\"$(my.default_value:)\"", my)
        my.project.brief = my.default_value
    endif

    my.default_value = my.defaults.prefix ?
    if defined(my.default_value) & !defined(my.project.prefix)
        echo_trace("       prefix=\"$(my.default_value:)\"", my)
        my.project.prefix = my.default_value
    endif

    my.default_value = my.defaults.namespace ?
    if defined(my.default_value) & !defined(my.project.namespace)
        echo_trace("       namespace=\"$(my.default_value:)\"", my)
        my.project.namespace = my.default_value
    endif

    my.default_value = my.defaults.framework ?
    if defined(my.default_value) & !defined(my.project.framework)
        echo_trace("       framework=\"$(my.default_value:)\"", my)
        my.project.framework = my.default_value
    endif

    my.default_value = my.defaults.path ?
    if defined(my.default_value) & !defined(my.project.path)
        echo_trace("       path=\"$(my.default_value:)\"", my)
        my.project.path = my.default_value
    endif

    my.default_value = my.defaults.inc_path ?
    if defined(my.default_value) & !defined(my.project.inc_path)
        echo_trace("       inc_path=\"$(my.default_value:)\"", my)
        my.project.inc_path = my.default_value
    endif

    my.default_value = my.defaults.inc_private_path ?
    if defined(my.default_value) & !defined(my.project.inc_private_path)
        echo_trace("       inc_private_path=\"$(my.default_value:)\"", my)
        my.project.inc_private_path = my.default_value
    endif

    my.default_value = my.defaults.src_path ?
    if defined(my.default_value) & !defined(my.project.src_path)
        echo_trace("       src_path=\"$(my.default_value:)\"", my)
        my.project.src_path = my.default_value
    endif

    my.default_value = my.defaults.install_headers_dir ?
    if defined(my.default_value) & !defined(my.project.install_headers_dir)
        echo_trace("       install_headers_dir=\"$(my.default_value:)\"", my)
        my.project.install_headers_dir = my.default_value
    endif

    my.default_value = my.defaults.install_private_headers_dir ?
    if defined(my.default_value) & !defined(my.project.install_private_headers_dir)
        echo_trace("       install_private_headers_dir=\"$(my.default_value:)\"", my)
        my.project.install_private_headers_dir = my.default_value
    endif

    my.default_value = my.defaults.work_path ?
    if defined(my.default_value) & !defined(my.project.work_path)
        echo_trace("       work_path=\"$(my.default_value:)\"", my)
        my.project.work_path = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function project_validate(project, restrictions)
    my.project_name = defined(my.project.name) ?? " name=\"$(my.project.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.project))$(my.project_name)/>", my)

    #    Check allowed entities
    my.interface_count = count(my.project.interface)
    for my.project.interface as _interface
        new restrictions
            interface_validate(_interface, restrictions)
        endnew
    endfor

    my.implementor_count = count(my.project.implementor)
    for my.project.implementor as _implementor
        new restrictions
            implementor_validate(_implementor, restrictions)
        endnew
    endfor

    my.module_count = count(my.project.module)
    for my.project.module as _module
        new restrictions
            module_validate(_module, restrictions)
        endnew
    endfor

    my.feature_count = count(my.project.feature)
    for my.project.feature as _feature
        new restrictions
            feature_validate(_feature, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.project.name?)\"", my)
    endif

    if !defined(my.project.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.project, "name")
    endif

    my.restrictions.attr_brief_apply ?= "1"
    my.restrictions.attr_brief_required ?= "1"

    if my.restrictions.attr_brief_apply
        echo_trace("     Validate attribute: brief=\"$(my.project.brief?)\"", my)
    endif

    if !defined(my.project.brief) & \
                my.restrictions.attr_brief_apply & my.restrictions.attr_brief_required
        echo_fatal_required_attr(my.project, "brief")
    endif

    my.restrictions.attr_prefix_apply ?= "1"
    my.restrictions.attr_prefix_required ?= "1"

    if my.restrictions.attr_prefix_apply
        echo_trace("     Validate attribute: prefix=\"$(my.project.prefix?)\"", my)
    endif

    if !defined(my.project.prefix) & \
                my.restrictions.attr_prefix_apply & my.restrictions.attr_prefix_required
        echo_fatal_required_attr(my.project, "prefix")
    endif

    my.restrictions.attr_namespace_apply ?= "1"
    my.restrictions.attr_namespace_required ?= "1"

    if my.restrictions.attr_namespace_apply
        echo_trace("     Validate attribute: namespace=\"$(my.project.namespace?)\"", my)
    endif

    if !defined(my.project.namespace) & \
                my.restrictions.attr_namespace_apply & my.restrictions.attr_namespace_required
        echo_fatal_required_attr(my.project, "namespace")
    endif

    my.restrictions.attr_framework_apply ?= "1"
    my.restrictions.attr_framework_required ?= "1"

    if my.restrictions.attr_framework_apply
        echo_trace("     Validate attribute: framework=\"$(my.project.framework?)\"", my)
    endif

    if !defined(my.project.framework) & \
                my.restrictions.attr_framework_apply & my.restrictions.attr_framework_required
        echo_fatal_required_attr(my.project, "framework")
    endif

    my.restrictions.attr_path_apply ?= "1"
    my.restrictions.attr_path_required ?= "1"

    if my.restrictions.attr_path_apply
        echo_trace("     Validate attribute: path=\"$(my.project.path?)\"", my)
    endif

    if !defined(my.project.path) & \
                my.restrictions.attr_path_apply & my.restrictions.attr_path_required
        echo_fatal_required_attr(my.project, "path")
    endif

    my.restrictions.attr_inc_path_apply ?= "1"
    my.restrictions.attr_inc_path_required ?= "1"

    if my.restrictions.attr_inc_path_apply
        echo_trace("     Validate attribute: inc_path=\"$(my.project.inc_path?)\"", my)
    endif

    if !defined(my.project.inc_path) & \
                my.restrictions.attr_inc_path_apply & my.restrictions.attr_inc_path_required
        echo_fatal_required_attr(my.project, "inc_path")
    endif

    my.restrictions.attr_inc_private_path_apply ?= "1"
    my.restrictions.attr_inc_private_path_required ?= "1"

    if my.restrictions.attr_inc_private_path_apply
        echo_trace("     Validate attribute: inc_private_path=\"$(my.project.inc_private_path?)\"", my)
    endif

    if !defined(my.project.inc_private_path) & \
                my.restrictions.attr_inc_private_path_apply & my.restrictions.attr_inc_private_path_required
        echo_fatal_required_attr(my.project, "inc_private_path")
    endif

    my.restrictions.attr_src_path_apply ?= "1"
    my.restrictions.attr_src_path_required ?= "1"

    if my.restrictions.attr_src_path_apply
        echo_trace("     Validate attribute: src_path=\"$(my.project.src_path?)\"", my)
    endif

    if !defined(my.project.src_path) & \
                my.restrictions.attr_src_path_apply & my.restrictions.attr_src_path_required
        echo_fatal_required_attr(my.project, "src_path")
    endif

    my.restrictions.attr_install_headers_dir_apply ?= "1"
    my.restrictions.attr_install_headers_dir_required ?= "0"

    if my.restrictions.attr_install_headers_dir_apply
        echo_trace("     Validate attribute: install_headers_dir=\"$(my.project.install_headers_dir?)\"", my)
    endif

    if !defined(my.project.install_headers_dir) & \
                my.restrictions.attr_install_headers_dir_apply & my.restrictions.attr_install_headers_dir_required
        echo_fatal_required_attr(my.project, "install_headers_dir")
    endif

    my.restrictions.attr_install_private_headers_dir_apply ?= "1"
    my.restrictions.attr_install_private_headers_dir_required ?= "0"

    if my.restrictions.attr_install_private_headers_dir_apply
        echo_trace("     Validate attribute: install_private_headers_dir=\"$(my.project.install_private_headers_dir?)\"", my)
    endif

    if !defined(my.project.install_private_headers_dir) & \
                my.restrictions.attr_install_private_headers_dir_apply & my.restrictions.attr_install_private_headers_dir_required
        echo_fatal_required_attr(my.project, "install_private_headers_dir")
    endif

    my.restrictions.attr_work_path_apply ?= "1"
    my.restrictions.attr_work_path_required ?= "1"

    if my.restrictions.attr_work_path_apply
        echo_trace("     Validate attribute: work_path=\"$(my.project.work_path?)\"", my)
    endif

    if !defined(my.project.work_path) & \
                my.restrictions.attr_work_path_apply & my.restrictions.attr_work_path_required
        echo_fatal_required_attr(my.project, "work_path")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function project_validate_resolved(project, restrictions)
    my.project_name = defined(my.project.name) ?? " name=\"$(my.project.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.project))$(my.project_name)/>", my)

    #    Check allowed entities
    for my.project.interface as _interface
        new restrictions
            interface_validate_resolved(_interface, restrictions)
        endnew
    endfor

    for my.project.implementor as _implementor
        new restrictions
            implementor_validate_resolved(_implementor, restrictions)
        endnew
    endfor

    for my.project.module as _module
        new restrictions
            module_validate_resolved(_module, restrictions)
        endnew
    endfor

    for my.project.feature as _feature
        new restrictions
            feature_validate_resolved(_feature, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.project.name?)\"", my)
    endif

    if !defined(my.project.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.project, "name")
    endif

    my.restrictions.attr_brief_apply ?= "1"
    my.restrictions.attr_brief_required ?= "1"

    if my.restrictions.attr_brief_apply
        echo_trace("     Validate attribute: brief=\"$(my.project.brief?)\"", my)
    endif

    if !defined(my.project.brief) & \
                my.restrictions.attr_brief_apply & my.restrictions.attr_brief_required
        echo_fatal_required_attr(my.project, "brief")
    endif

    my.restrictions.attr_prefix_apply ?= "1"
    my.restrictions.attr_prefix_required ?= "1"

    if my.restrictions.attr_prefix_apply
        echo_trace("     Validate attribute: prefix=\"$(my.project.prefix?)\"", my)
    endif

    if !defined(my.project.prefix) & \
                my.restrictions.attr_prefix_apply & my.restrictions.attr_prefix_required
        echo_fatal_required_attr(my.project, "prefix")
    endif

    my.restrictions.attr_namespace_apply ?= "1"
    my.restrictions.attr_namespace_required ?= "1"

    if my.restrictions.attr_namespace_apply
        echo_trace("     Validate attribute: namespace=\"$(my.project.namespace?)\"", my)
    endif

    if !defined(my.project.namespace) & \
                my.restrictions.attr_namespace_apply & my.restrictions.attr_namespace_required
        echo_fatal_required_attr(my.project, "namespace")
    endif

    my.restrictions.attr_framework_apply ?= "1"
    my.restrictions.attr_framework_required ?= "1"

    if my.restrictions.attr_framework_apply
        echo_trace("     Validate attribute: framework=\"$(my.project.framework?)\"", my)
    endif

    if !defined(my.project.framework) & \
                my.restrictions.attr_framework_apply & my.restrictions.attr_framework_required
        echo_fatal_required_attr(my.project, "framework")
    endif

    my.restrictions.attr_path_apply ?= "1"
    my.restrictions.attr_path_required ?= "1"

    if my.restrictions.attr_path_apply
        echo_trace("     Validate attribute: path=\"$(my.project.path?)\"", my)
    endif

    if !defined(my.project.path) & \
                my.restrictions.attr_path_apply & my.restrictions.attr_path_required
        echo_fatal_required_attr(my.project, "path")
    endif

    my.restrictions.attr_inc_path_apply ?= "1"
    my.restrictions.attr_inc_path_required ?= "1"

    if my.restrictions.attr_inc_path_apply
        echo_trace("     Validate attribute: inc_path=\"$(my.project.inc_path?)\"", my)
    endif

    if !defined(my.project.inc_path) & \
                my.restrictions.attr_inc_path_apply & my.restrictions.attr_inc_path_required
        echo_fatal_required_attr(my.project, "inc_path")
    endif

    my.restrictions.attr_inc_private_path_apply ?= "1"
    my.restrictions.attr_inc_private_path_required ?= "1"

    if my.restrictions.attr_inc_private_path_apply
        echo_trace("     Validate attribute: inc_private_path=\"$(my.project.inc_private_path?)\"", my)
    endif

    if !defined(my.project.inc_private_path) & \
                my.restrictions.attr_inc_private_path_apply & my.restrictions.attr_inc_private_path_required
        echo_fatal_required_attr(my.project, "inc_private_path")
    endif

    my.restrictions.attr_src_path_apply ?= "1"
    my.restrictions.attr_src_path_required ?= "1"

    if my.restrictions.attr_src_path_apply
        echo_trace("     Validate attribute: src_path=\"$(my.project.src_path?)\"", my)
    endif

    if !defined(my.project.src_path) & \
                my.restrictions.attr_src_path_apply & my.restrictions.attr_src_path_required
        echo_fatal_required_attr(my.project, "src_path")
    endif

    my.restrictions.attr_install_headers_dir_apply ?= "1"
    my.restrictions.attr_install_headers_dir_required ?= "0"

    if my.restrictions.attr_install_headers_dir_apply
        echo_trace("     Validate attribute: install_headers_dir=\"$(my.project.install_headers_dir?)\"", my)
    endif

    if !defined(my.project.install_headers_dir) & \
                my.restrictions.attr_install_headers_dir_apply & my.restrictions.attr_install_headers_dir_required
        echo_fatal_required_attr(my.project, "install_headers_dir")
    endif

    my.restrictions.attr_install_private_headers_dir_apply ?= "1"
    my.restrictions.attr_install_private_headers_dir_required ?= "0"

    if my.restrictions.attr_install_private_headers_dir_apply
        echo_trace("     Validate attribute: install_private_headers_dir=\"$(my.project.install_private_headers_dir?)\"", my)
    endif

    if !defined(my.project.install_private_headers_dir) & \
                my.restrictions.attr_install_private_headers_dir_apply & my.restrictions.attr_install_private_headers_dir_required
        echo_fatal_required_attr(my.project, "install_private_headers_dir")
    endif

    my.restrictions.attr_work_path_apply ?= "1"
    my.restrictions.attr_work_path_required ?= "1"

    if my.restrictions.attr_work_path_apply
        echo_trace("     Validate attribute: work_path=\"$(my.project.work_path?)\"", my)
    endif

    if !defined(my.project.work_path) & \
                my.restrictions.attr_work_path_apply & my.restrictions.attr_work_path_required
        echo_fatal_required_attr(my.project, "work_path")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function interface_setup_defaults(interface, defaults)
    my.interface_name = defined(my.interface.name) ?? " name=\"$(my.interface.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.interface))$(my.interface_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.interface.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.interface.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function interface_validate(interface, restrictions)
    my.interface_name = defined(my.interface.name) ?? " name=\"$(my.interface.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.interface))$(my.interface_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.interface.name?)\"", my)
    endif

    if !defined(my.interface.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.interface, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function interface_validate_resolved(interface, restrictions)
    my.interface_name = defined(my.interface.name) ?? " name=\"$(my.interface.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.interface))$(my.interface_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.interface.name?)\"", my)
    endif

    if !defined(my.interface.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.interface, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function implementor_setup_defaults(implementor, defaults)
    my.implementor_name = defined(my.implementor.name) ?? " name=\"$(my.implementor.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.implementor))$(my.implementor_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.implementor.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.implementor.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function implementor_validate(implementor, restrictions)
    my.implementor_name = defined(my.implementor.name) ?? " name=\"$(my.implementor.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.implementor))$(my.implementor_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.implementor.name?)\"", my)
    endif

    if !defined(my.implementor.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.implementor, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function implementor_validate_resolved(implementor, restrictions)
    my.implementor_name = defined(my.implementor.name) ?? " name=\"$(my.implementor.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.implementor))$(my.implementor_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.implementor.name?)\"", my)
    endif

    if !defined(my.implementor.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.implementor, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function features_setup_defaults(features, defaults)
    my.features_name = defined(my.features.name) ?? " name=\"$(my.features.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.features))$(my.features_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    landlord_setup_defaults(my.features, my.defaults)

    #    Setup defaults for allowed entities
    for my.features.feature as _feature
        feature_setup_defaults(_feature)
    endfor

    my.default_value = my.defaults.prefix ?
    if defined(my.default_value) & !defined(my.features.prefix)
        echo_trace("       prefix=\"$(my.default_value:)\"", my)
        my.features.prefix = my.default_value
    endif

    my.default_value = my.defaults.path ?
    if defined(my.default_value) & !defined(my.features.path)
        echo_trace("       path=\"$(my.default_value:)\"", my)
        my.features.path = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function features_validate(features, restrictions)
    my.features_name = defined(my.features.name) ?? " name=\"$(my.features.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.features))$(my.features_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        landlord_validate(my.features, restrictions)
    endnew

    #    Check allowed entities
    my.feature_count = count(my.features.feature)
    for my.features.feature as _feature
        new restrictions
            feature_validate(_feature, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_prefix_apply ?= "1"
    my.restrictions.attr_prefix_required ?= "0"

    if my.restrictions.attr_prefix_apply
        echo_trace("     Validate attribute: prefix=\"$(my.features.prefix?)\"", my)
    endif

    if !defined(my.features.prefix) & \
                my.restrictions.attr_prefix_apply & my.restrictions.attr_prefix_required
        echo_fatal_required_attr(my.features, "prefix")
    endif

    my.restrictions.attr_path_apply ?= "1"
    my.restrictions.attr_path_required ?= "1"

    if my.restrictions.attr_path_apply
        echo_trace("     Validate attribute: path=\"$(my.features.path?)\"", my)
    endif

    if !defined(my.features.path) & \
                my.restrictions.attr_path_apply & my.restrictions.attr_path_required
        echo_fatal_required_attr(my.features, "path")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function features_validate_resolved(features, restrictions)
    my.features_name = defined(my.features.name) ?? " name=\"$(my.features.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.features))$(my.features_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        landlord_validate_resolved(my.features, restrictions)
    endnew

    #    Check allowed entities
    for my.features.feature as _feature
        new restrictions
            feature_validate_resolved(_feature, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_prefix_apply ?= "1"
    my.restrictions.attr_prefix_required ?= "0"

    if my.restrictions.attr_prefix_apply
        echo_trace("     Validate attribute: prefix=\"$(my.features.prefix?)\"", my)
    endif

    if !defined(my.features.prefix) & \
                my.restrictions.attr_prefix_apply & my.restrictions.attr_prefix_required
        echo_fatal_required_attr(my.features, "prefix")
    endif

    my.restrictions.attr_path_apply ?= "1"
    my.restrictions.attr_path_required ?= "1"

    if my.restrictions.attr_path_apply
        echo_trace("     Validate attribute: path=\"$(my.features.path?)\"", my)
    endif

    if !defined(my.features.path) & \
                my.restrictions.attr_path_apply & my.restrictions.attr_path_required
        echo_fatal_required_attr(my.features, "path")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function library_setup_defaults(library, defaults)
    my.library_name = defined(my.library.name) ?? " name=\"$(my.library.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.library))$(my.library_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for allowed entities
    for my.library.feature as _feature
        feature_setup_defaults(_feature)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.library.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.library.name = my.default_value
    endif

    my.default_value = my.defaults.prefix ?
    if defined(my.default_value) & !defined(my.library.prefix)
        echo_trace("       prefix=\"$(my.default_value:)\"", my)
        my.library.prefix = my.default_value
    endif

    my.default_value = my.defaults.path ?
    if defined(my.default_value) & !defined(my.library.path)
        echo_trace("       path=\"$(my.default_value:)\"", my)
        my.library.path = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function library_validate(library, restrictions)
    my.library_name = defined(my.library.name) ?? " name=\"$(my.library.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.library))$(my.library_name)/>", my)

    #    Check allowed entities
    my.feature_count = count(my.library.feature)
    for my.library.feature as _feature
        new restrictions
            feature_validate(_feature, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.library.name?)\"", my)
    endif

    if !defined(my.library.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.library, "name")
    endif

    my.restrictions.attr_prefix_apply ?= "1"
    my.restrictions.attr_prefix_required ?= "0"

    if my.restrictions.attr_prefix_apply
        echo_trace("     Validate attribute: prefix=\"$(my.library.prefix?)\"", my)
    endif

    if !defined(my.library.prefix) & \
                my.restrictions.attr_prefix_apply & my.restrictions.attr_prefix_required
        echo_fatal_required_attr(my.library, "prefix")
    endif

    my.restrictions.attr_path_apply ?= "1"
    my.restrictions.attr_path_required ?= "1"

    if my.restrictions.attr_path_apply
        echo_trace("     Validate attribute: path=\"$(my.library.path?)\"", my)
    endif

    if !defined(my.library.path) & \
                my.restrictions.attr_path_apply & my.restrictions.attr_path_required
        echo_fatal_required_attr(my.library, "path")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function library_validate_resolved(library, restrictions)
    my.library_name = defined(my.library.name) ?? " name=\"$(my.library.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.library))$(my.library_name)/>", my)

    #    Check allowed entities
    for my.library.feature as _feature
        new restrictions
            feature_validate_resolved(_feature, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.library.name?)\"", my)
    endif

    if !defined(my.library.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.library, "name")
    endif

    my.restrictions.attr_prefix_apply ?= "1"
    my.restrictions.attr_prefix_required ?= "0"

    if my.restrictions.attr_prefix_apply
        echo_trace("     Validate attribute: prefix=\"$(my.library.prefix?)\"", my)
    endif

    if !defined(my.library.prefix) & \
                my.restrictions.attr_prefix_apply & my.restrictions.attr_prefix_required
        echo_fatal_required_attr(my.library, "prefix")
    endif

    my.restrictions.attr_path_apply ?= "1"
    my.restrictions.attr_path_required ?= "1"

    if my.restrictions.attr_path_apply
        echo_trace("     Validate attribute: path=\"$(my.library.path?)\"", my)
    endif

    if !defined(my.library.path) & \
                my.restrictions.attr_path_apply & my.restrictions.attr_path_required
        echo_fatal_required_attr(my.library, "path")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function module_setup_defaults(module, defaults)
    my.module_name = defined(my.module.name) ?? " name=\"$(my.module.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.module))$(my.module_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    scope_setup_defaults(my.module, my.defaults)
    component_setup_defaults(my.module, my.defaults)

    #    Setup defaults for allowed entities
    for my.module.require as _require
        require_setup_defaults(_require)
    endfor

    for my.module.constant as _constant
        constant_setup_defaults(_constant)
    endfor

    for my.module.enum as _enum
        enum_setup_defaults(_enum)
    endfor

    for my.module.variable as _variable
        variable_setup_defaults(_variable)
    endfor

    for my.module.struct as _struct
        struct_setup_defaults(_struct)
    endfor

    for my.module.callback as _callback
        callback_setup_defaults(_callback)
    endfor

    for my.module.method as _method
        method_setup_defaults(_method)
    endfor

    for my.module.macros as _macros
        macros_setup_defaults(_macros)
    endfor

    for my.module.macroses as _macroses
        macroses_setup_defaults(_macroses)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.module.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.module.name = my.default_value
    endif

    my.default_value = my.defaults.has_cmakedefine ? "0"
    if defined(my.default_value) & !defined(my.module.has_cmakedefine)
        echo_trace("       has_cmakedefine=\"$(my.default_value:)\"", my)
        my.module.has_cmakedefine = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function module_validate(module, restrictions)
    my.module_name = defined(my.module.name) ?? " name=\"$(my.module.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.module))$(my.module_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scope_validate(my.module, restrictions)
    endnew

    new restrictions
        component_validate(my.module, restrictions)
    endnew

    #    Check allowed entities
    my.require_count = count(my.module.require)
    for my.module.require as _require
        new restrictions
            require_validate(_require, restrictions)
        endnew
    endfor

    my.constant_count = count(my.module.constant)
    for my.module.constant as _constant
        new restrictions
            constant_validate(_constant, restrictions)
        endnew
    endfor

    my.enum_count = count(my.module.enum)
    for my.module.enum as _enum
        new restrictions
            enum_validate(_enum, restrictions)
        endnew
    endfor

    my.variable_count = count(my.module.variable)
    for my.module.variable as _variable
        new restrictions
            variable_validate(_variable, restrictions)
        endnew
    endfor

    my.struct_count = count(my.module.struct)
    for my.module.struct as _struct
        new restrictions
            struct_validate(_struct, restrictions)
        endnew
    endfor

    my.callback_count = count(my.module.callback)
    for my.module.callback as _callback
        new restrictions
            callback_validate(_callback, restrictions)
        endnew
    endfor

    my.method_count = count(my.module.method)
    for my.module.method as _method
        new restrictions
            method_validate(_method, restrictions)
        endnew
    endfor

    my.macros_count = count(my.module.macros)
    for my.module.macros as _macros
        new restrictions
            macros_validate(_macros, restrictions)
        endnew
    endfor

    my.macroses_count = count(my.module.macroses)
    for my.module.macroses as _macroses
        new restrictions
            macroses_validate(_macroses, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.module.name?)\"", my)
    endif

    if !defined(my.module.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.module, "name")
    endif

    my.restrictions.attr_has_cmakedefine_apply ?= "1"
    my.restrictions.attr_has_cmakedefine_required ?= "0"

    if my.restrictions.attr_has_cmakedefine_apply
        echo_trace("     Validate attribute: has_cmakedefine=\"$(my.module.has_cmakedefine?)\"", my)
    endif

    if !defined(my.module.has_cmakedefine) & \
                my.restrictions.attr_has_cmakedefine_apply & my.restrictions.attr_has_cmakedefine_required
        echo_fatal_required_attr(my.module, "has_cmakedefine")
    endif
    if my.restrictions.attr_has_cmakedefine_apply & defined(my.module.has_cmakedefine)
        my.has_cmakedefine_is_valid = "0"
        my.has_cmakedefine_is_valid = my.has_cmakedefine_is_valid | (my.module.has_cmakedefine = "0")
        my.has_cmakedefine_is_valid = my.has_cmakedefine_is_valid | (my.module.has_cmakedefine = "1")
        if !my.has_cmakedefine_is_valid
            echo_fatal_resticted_attr(my.module, "has_cmakedefine", "0, 1")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function module_validate_resolved(module, restrictions)
    my.module_name = defined(my.module.name) ?? " name=\"$(my.module.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.module))$(my.module_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scope_validate_resolved(my.module, restrictions)
    endnew

    new restrictions
        component_validate_resolved(my.module, restrictions)
    endnew

    #    Check allowed entities
    for my.module.require as _require
        new restrictions
            require_validate_resolved(_require, restrictions)
        endnew
    endfor

    for my.module.constant as _constant
        new restrictions
            constant_validate_resolved(_constant, restrictions)
        endnew
    endfor

    for my.module.enum as _enum
        new restrictions
            enum_validate_resolved(_enum, restrictions)
        endnew
    endfor

    for my.module.variable as _variable
        new restrictions
            variable_validate_resolved(_variable, restrictions)
        endnew
    endfor

    for my.module.struct as _struct
        new restrictions
            struct_validate_resolved(_struct, restrictions)
        endnew
    endfor

    for my.module.callback as _callback
        new restrictions
            callback_validate_resolved(_callback, restrictions)
        endnew
    endfor

    for my.module.method as _method
        new restrictions
            method_validate_resolved(_method, restrictions)
        endnew
    endfor

    for my.module.macros as _macros
        new restrictions
            macros_validate_resolved(_macros, restrictions)
        endnew
    endfor

    for my.module.macroses as _macroses
        new restrictions
            macroses_validate_resolved(_macroses, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.module.name?)\"", my)
    endif

    if !defined(my.module.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.module, "name")
    endif

    my.restrictions.attr_has_cmakedefine_apply ?= "1"
    my.restrictions.attr_has_cmakedefine_required ?= "0"

    if my.restrictions.attr_has_cmakedefine_apply
        echo_trace("     Validate attribute: has_cmakedefine=\"$(my.module.has_cmakedefine?)\"", my)
    endif

    if !defined(my.module.has_cmakedefine) & \
                my.restrictions.attr_has_cmakedefine_apply & my.restrictions.attr_has_cmakedefine_required
        echo_fatal_required_attr(my.module, "has_cmakedefine")
    endif
    if my.restrictions.attr_has_cmakedefine_apply & defined(my.module.has_cmakedefine)
        my.has_cmakedefine_is_valid = "0"
        my.has_cmakedefine_is_valid = my.has_cmakedefine_is_valid | (my.module.has_cmakedefine = "0")
        my.has_cmakedefine_is_valid = my.has_cmakedefine_is_valid | (my.module.has_cmakedefine = "1")
        if !my.has_cmakedefine_is_valid
            echo_fatal_resticted_attr(my.module, "has_cmakedefine", "0, 1")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_instance_setup_defaults(c_instance, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.type ?
    if defined(my.default_value) & !defined(my.c_instance.type)
        echo_trace("       type=\"$(my.default_value:)\"", my)
        my.c_instance.type = my.default_value
    endif

    my.default_value = my.defaults.type_is ?
    if defined(my.default_value) & !defined(my.c_instance.type_is)
        echo_trace("       type_is=\"$(my.default_value:)\"", my)
        my.c_instance.type_is = my.default_value
    endif

    my.default_value = my.defaults.accessed_by ? "value"
    if defined(my.default_value) & !defined(my.c_instance.accessed_by)
        echo_trace("       accessed_by=\"$(my.default_value:)\"", my)
        my.c_instance.accessed_by = my.default_value
    endif

    my.default_value = my.defaults.array ?
    if defined(my.default_value) & !defined(my.c_instance.array)
        echo_trace("       array=\"$(my.default_value:)\"", my)
        my.c_instance.array = my.default_value
    endif

    my.default_value = my.defaults.string ?
    if defined(my.default_value) & !defined(my.c_instance.string)
        echo_trace("       string=\"$(my.default_value:)\"", my)
        my.c_instance.string = my.default_value
    endif

    my.default_value = my.defaults.length ?
    if defined(my.default_value) & !defined(my.c_instance.length)
        echo_trace("       length=\"$(my.default_value:)\"", my)
        my.c_instance.length = my.default_value
    endif

    my.default_value = my.defaults.is_const_type ?
    if defined(my.default_value) & !defined(my.c_instance.is_const_type)
        echo_trace("       is_const_type=\"$(my.default_value:)\"", my)
        my.c_instance.is_const_type = my.default_value
    endif

    my.default_value = my.defaults.is_const_pointer ?
    if defined(my.default_value) & !defined(my.c_instance.is_const_pointer)
        echo_trace("       is_const_pointer=\"$(my.default_value:)\"", my)
        my.c_instance.is_const_pointer = my.default_value
    endif

    my.default_value = my.defaults.is_const_array ?
    if defined(my.default_value) & !defined(my.c_instance.is_const_array)
        echo_trace("       is_const_array=\"$(my.default_value:)\"", my)
        my.c_instance.is_const_array = my.default_value
    endif

    my.default_value = my.defaults.is_const_string ?
    if defined(my.default_value) & !defined(my.c_instance.is_const_string)
        echo_trace("       is_const_string=\"$(my.default_value:)\"", my)
        my.c_instance.is_const_string = my.default_value
    endif

    my.default_value = my.defaults.is_const_reference ?
    if defined(my.default_value) & !defined(my.c_instance.is_const_reference)
        echo_trace("       is_const_reference=\"$(my.default_value:)\"", my)
        my.c_instance.is_const_reference = my.default_value
    endif

    my.default_value = my.defaults.require_definition ?
    if defined(my.default_value) & !defined(my.c_instance.require_definition)
        echo_trace("       require_definition=\"$(my.default_value:)\"", my)
        my.c_instance.require_definition = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_instance_validate(c_instance, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_type_apply ?= "1"
    my.restrictions.attr_type_required ?= "1"

    if my.restrictions.attr_type_apply
        echo_trace("     Validate attribute: type=\"$(my.c_instance.type?)\"", my)
    endif

    if !defined(my.c_instance.type) & \
                my.restrictions.attr_type_apply & my.restrictions.attr_type_required
        echo_fatal_required_attr(my.c_instance, "type")
    endif

    my.restrictions.attr_type_is_apply ?= "1"
    my.restrictions.attr_type_is_required ?= "1"

    if my.restrictions.attr_type_is_apply
        echo_trace("     Validate attribute: type_is=\"$(my.c_instance.type_is?)\"", my)
    endif

    if !defined(my.c_instance.type_is) & \
                my.restrictions.attr_type_is_apply & my.restrictions.attr_type_is_required
        echo_fatal_required_attr(my.c_instance, "type_is")
    endif
    if my.restrictions.attr_type_is_apply & defined(my.c_instance.type_is)
        my.type_is_is_valid = "0"
        my.type_is_is_valid = my.type_is_is_valid | (my.c_instance.type_is = "primitive")
        my.type_is_is_valid = my.type_is_is_valid | (my.c_instance.type_is = "class")
        my.type_is_is_valid = my.type_is_is_valid | (my.c_instance.type_is = "callback")
        my.type_is_is_valid = my.type_is_is_valid | (my.c_instance.type_is = "any")
        if !my.type_is_is_valid
            echo_fatal_resticted_attr(my.c_instance, "type_is", "primitive, class, callback, any")
        endif
    endif

    my.restrictions.attr_accessed_by_apply ?= "1"
    my.restrictions.attr_accessed_by_required ?= "0"

    if my.restrictions.attr_accessed_by_apply
        echo_trace("     Validate attribute: accessed_by=\"$(my.c_instance.accessed_by?)\"", my)
    endif

    if !defined(my.c_instance.accessed_by) & \
                my.restrictions.attr_accessed_by_apply & my.restrictions.attr_accessed_by_required
        echo_fatal_required_attr(my.c_instance, "accessed_by")
    endif
    if my.restrictions.attr_accessed_by_apply & defined(my.c_instance.accessed_by)
        my.accessed_by_is_valid = "0"
        my.accessed_by_is_valid = my.accessed_by_is_valid | (my.c_instance.accessed_by = "value")
        my.accessed_by_is_valid = my.accessed_by_is_valid | (my.c_instance.accessed_by = "pointer")
        my.accessed_by_is_valid = my.accessed_by_is_valid | (my.c_instance.accessed_by = "reference")
        if !my.accessed_by_is_valid
            echo_fatal_resticted_attr(my.c_instance, "accessed_by", "value, pointer, reference")
        endif
    endif

    my.restrictions.attr_array_apply ?= "1"
    my.restrictions.attr_array_required ?= "0"

    if my.restrictions.attr_array_apply
        echo_trace("     Validate attribute: array=\"$(my.c_instance.array?)\"", my)
    endif

    if !defined(my.c_instance.array) & \
                my.restrictions.attr_array_apply & my.restrictions.attr_array_required
        echo_fatal_required_attr(my.c_instance, "array")
    endif
    if my.restrictions.attr_array_apply & defined(my.c_instance.array)
        my.array_is_valid = "0"
        my.array_is_valid = my.array_is_valid | (my.c_instance.array = "null_terminated")
        my.array_is_valid = my.array_is_valid | (my.c_instance.array = "given")
        my.array_is_valid = my.array_is_valid | (my.c_instance.array = "fixed")
        my.array_is_valid = my.array_is_valid | (my.c_instance.array = "derived")
        if !my.array_is_valid
            echo_fatal_resticted_attr(my.c_instance, "array", "null_terminated, given, fixed, derived")
        endif
    endif

    my.restrictions.attr_string_apply ?= "1"
    my.restrictions.attr_string_required ?= "0"

    if my.restrictions.attr_string_apply
        echo_trace("     Validate attribute: string=\"$(my.c_instance.string?)\"", my)
    endif

    if !defined(my.c_instance.string) & \
                my.restrictions.attr_string_apply & my.restrictions.attr_string_required
        echo_fatal_required_attr(my.c_instance, "string")
    endif
    if my.restrictions.attr_string_apply & defined(my.c_instance.string)
        my.string_is_valid = "0"
        my.string_is_valid = my.string_is_valid | (my.c_instance.string = "null_terminated")
        my.string_is_valid = my.string_is_valid | (my.c_instance.string = "given")
        my.string_is_valid = my.string_is_valid | (my.c_instance.string = "fixed")
        my.string_is_valid = my.string_is_valid | (my.c_instance.string = "derived")
        if !my.string_is_valid
            echo_fatal_resticted_attr(my.c_instance, "string", "null_terminated, given, fixed, derived")
        endif
    endif

    my.restrictions.attr_length_apply ?= "1"
    my.restrictions.attr_length_required ?= "0"

    if my.restrictions.attr_length_apply
        echo_trace("     Validate attribute: length=\"$(my.c_instance.length?)\"", my)
    endif

    if !defined(my.c_instance.length) & \
                my.restrictions.attr_length_apply & my.restrictions.attr_length_required
        echo_fatal_required_attr(my.c_instance, "length")
    endif

    my.restrictions.attr_is_const_type_apply ?= "1"
    my.restrictions.attr_is_const_type_required ?= "0"

    if my.restrictions.attr_is_const_type_apply
        echo_trace("     Validate attribute: is_const_type=\"$(my.c_instance.is_const_type?)\"", my)
    endif

    if !defined(my.c_instance.is_const_type) & \
                my.restrictions.attr_is_const_type_apply & my.restrictions.attr_is_const_type_required
        echo_fatal_required_attr(my.c_instance, "is_const_type")
    endif

    my.restrictions.attr_is_const_pointer_apply ?= "1"
    my.restrictions.attr_is_const_pointer_required ?= "0"

    if my.restrictions.attr_is_const_pointer_apply
        echo_trace("     Validate attribute: is_const_pointer=\"$(my.c_instance.is_const_pointer?)\"", my)
    endif

    if !defined(my.c_instance.is_const_pointer) & \
                my.restrictions.attr_is_const_pointer_apply & my.restrictions.attr_is_const_pointer_required
        echo_fatal_required_attr(my.c_instance, "is_const_pointer")
    endif

    my.restrictions.attr_is_const_array_apply ?= "1"
    my.restrictions.attr_is_const_array_required ?= "0"

    if my.restrictions.attr_is_const_array_apply
        echo_trace("     Validate attribute: is_const_array=\"$(my.c_instance.is_const_array?)\"", my)
    endif

    if !defined(my.c_instance.is_const_array) & \
                my.restrictions.attr_is_const_array_apply & my.restrictions.attr_is_const_array_required
        echo_fatal_required_attr(my.c_instance, "is_const_array")
    endif

    my.restrictions.attr_is_const_string_apply ?= "1"
    my.restrictions.attr_is_const_string_required ?= "0"

    if my.restrictions.attr_is_const_string_apply
        echo_trace("     Validate attribute: is_const_string=\"$(my.c_instance.is_const_string?)\"", my)
    endif

    if !defined(my.c_instance.is_const_string) & \
                my.restrictions.attr_is_const_string_apply & my.restrictions.attr_is_const_string_required
        echo_fatal_required_attr(my.c_instance, "is_const_string")
    endif

    my.restrictions.attr_is_const_reference_apply ?= "1"
    my.restrictions.attr_is_const_reference_required ?= "0"

    if my.restrictions.attr_is_const_reference_apply
        echo_trace("     Validate attribute: is_const_reference=\"$(my.c_instance.is_const_reference?)\"", my)
    endif

    if !defined(my.c_instance.is_const_reference) & \
                my.restrictions.attr_is_const_reference_apply & my.restrictions.attr_is_const_reference_required
        echo_fatal_required_attr(my.c_instance, "is_const_reference")
    endif

    my.restrictions.attr_require_definition_apply ?= "1"
    my.restrictions.attr_require_definition_required ?= "0"

    if my.restrictions.attr_require_definition_apply
        echo_trace("     Validate attribute: require_definition=\"$(my.c_instance.require_definition?)\"", my)
    endif

    if !defined(my.c_instance.require_definition) & \
                my.restrictions.attr_require_definition_apply & my.restrictions.attr_require_definition_required
        echo_fatal_required_attr(my.c_instance, "require_definition")
    endif
    if my.restrictions.attr_require_definition_apply & defined(my.c_instance.require_definition)
        my.require_definition_is_valid = "0"
        my.require_definition_is_valid = my.require_definition_is_valid | (my.c_instance.require_definition = "public")
        my.require_definition_is_valid = my.require_definition_is_valid | (my.c_instance.require_definition = "private")
        if !my.require_definition_is_valid
            echo_fatal_resticted_attr(my.c_instance, "require_definition", "public, private")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_instance_validate_resolved(c_instance, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_type_apply ?= "1"
    my.restrictions.attr_type_required ?= "1"

    if my.restrictions.attr_type_apply
        echo_trace("     Validate attribute: type=\"$(my.c_instance.type?)\"", my)
    endif

    if !defined(my.c_instance.type) & \
                my.restrictions.attr_type_apply & my.restrictions.attr_type_required
        echo_fatal_required_attr(my.c_instance, "type")
    endif

    my.restrictions.attr_type_is_apply ?= "1"
    my.restrictions.attr_type_is_required ?= "1"

    if my.restrictions.attr_type_is_apply
        echo_trace("     Validate attribute: type_is=\"$(my.c_instance.type_is?)\"", my)
    endif

    if !defined(my.c_instance.type_is) & \
                my.restrictions.attr_type_is_apply & my.restrictions.attr_type_is_required
        echo_fatal_required_attr(my.c_instance, "type_is")
    endif
    if my.restrictions.attr_type_is_apply & defined(my.c_instance.type_is)
        my.type_is_is_valid = "0"
        my.type_is_is_valid = my.type_is_is_valid | (my.c_instance.type_is = "primitive")
        my.type_is_is_valid = my.type_is_is_valid | (my.c_instance.type_is = "class")
        my.type_is_is_valid = my.type_is_is_valid | (my.c_instance.type_is = "callback")
        my.type_is_is_valid = my.type_is_is_valid | (my.c_instance.type_is = "any")
        if !my.type_is_is_valid
            echo_fatal_resticted_attr(my.c_instance, "type_is", "primitive, class, callback, any")
        endif
    endif

    my.restrictions.attr_accessed_by_apply ?= "1"
    my.restrictions.attr_accessed_by_required ?= "0"

    if my.restrictions.attr_accessed_by_apply
        echo_trace("     Validate attribute: accessed_by=\"$(my.c_instance.accessed_by?)\"", my)
    endif

    if !defined(my.c_instance.accessed_by) & \
                my.restrictions.attr_accessed_by_apply & my.restrictions.attr_accessed_by_required
        echo_fatal_required_attr(my.c_instance, "accessed_by")
    endif
    if my.restrictions.attr_accessed_by_apply & defined(my.c_instance.accessed_by)
        my.accessed_by_is_valid = "0"
        my.accessed_by_is_valid = my.accessed_by_is_valid | (my.c_instance.accessed_by = "value")
        my.accessed_by_is_valid = my.accessed_by_is_valid | (my.c_instance.accessed_by = "pointer")
        my.accessed_by_is_valid = my.accessed_by_is_valid | (my.c_instance.accessed_by = "reference")
        if !my.accessed_by_is_valid
            echo_fatal_resticted_attr(my.c_instance, "accessed_by", "value, pointer, reference")
        endif
    endif

    my.restrictions.attr_array_apply ?= "1"
    my.restrictions.attr_array_required ?= "0"

    if my.restrictions.attr_array_apply
        echo_trace("     Validate attribute: array=\"$(my.c_instance.array?)\"", my)
    endif

    if !defined(my.c_instance.array) & \
                my.restrictions.attr_array_apply & my.restrictions.attr_array_required
        echo_fatal_required_attr(my.c_instance, "array")
    endif
    if my.restrictions.attr_array_apply & defined(my.c_instance.array)
        my.array_is_valid = "0"
        my.array_is_valid = my.array_is_valid | (my.c_instance.array = "null_terminated")
        my.array_is_valid = my.array_is_valid | (my.c_instance.array = "given")
        my.array_is_valid = my.array_is_valid | (my.c_instance.array = "fixed")
        my.array_is_valid = my.array_is_valid | (my.c_instance.array = "derived")
        if !my.array_is_valid
            echo_fatal_resticted_attr(my.c_instance, "array", "null_terminated, given, fixed, derived")
        endif
    endif

    my.restrictions.attr_string_apply ?= "1"
    my.restrictions.attr_string_required ?= "0"

    if my.restrictions.attr_string_apply
        echo_trace("     Validate attribute: string=\"$(my.c_instance.string?)\"", my)
    endif

    if !defined(my.c_instance.string) & \
                my.restrictions.attr_string_apply & my.restrictions.attr_string_required
        echo_fatal_required_attr(my.c_instance, "string")
    endif
    if my.restrictions.attr_string_apply & defined(my.c_instance.string)
        my.string_is_valid = "0"
        my.string_is_valid = my.string_is_valid | (my.c_instance.string = "null_terminated")
        my.string_is_valid = my.string_is_valid | (my.c_instance.string = "given")
        my.string_is_valid = my.string_is_valid | (my.c_instance.string = "fixed")
        my.string_is_valid = my.string_is_valid | (my.c_instance.string = "derived")
        if !my.string_is_valid
            echo_fatal_resticted_attr(my.c_instance, "string", "null_terminated, given, fixed, derived")
        endif
    endif

    my.restrictions.attr_length_apply ?= "1"
    my.restrictions.attr_length_required ?= "0"

    if my.restrictions.attr_length_apply
        echo_trace("     Validate attribute: length=\"$(my.c_instance.length?)\"", my)
    endif

    if !defined(my.c_instance.length) & \
                my.restrictions.attr_length_apply & my.restrictions.attr_length_required
        echo_fatal_required_attr(my.c_instance, "length")
    endif

    my.restrictions.attr_is_const_type_apply ?= "1"
    my.restrictions.attr_is_const_type_required ?= "0"

    if my.restrictions.attr_is_const_type_apply
        echo_trace("     Validate attribute: is_const_type=\"$(my.c_instance.is_const_type?)\"", my)
    endif

    if !defined(my.c_instance.is_const_type) & \
                my.restrictions.attr_is_const_type_apply & my.restrictions.attr_is_const_type_required
        echo_fatal_required_attr(my.c_instance, "is_const_type")
    endif

    my.restrictions.attr_is_const_pointer_apply ?= "1"
    my.restrictions.attr_is_const_pointer_required ?= "0"

    if my.restrictions.attr_is_const_pointer_apply
        echo_trace("     Validate attribute: is_const_pointer=\"$(my.c_instance.is_const_pointer?)\"", my)
    endif

    if !defined(my.c_instance.is_const_pointer) & \
                my.restrictions.attr_is_const_pointer_apply & my.restrictions.attr_is_const_pointer_required
        echo_fatal_required_attr(my.c_instance, "is_const_pointer")
    endif

    my.restrictions.attr_is_const_array_apply ?= "1"
    my.restrictions.attr_is_const_array_required ?= "0"

    if my.restrictions.attr_is_const_array_apply
        echo_trace("     Validate attribute: is_const_array=\"$(my.c_instance.is_const_array?)\"", my)
    endif

    if !defined(my.c_instance.is_const_array) & \
                my.restrictions.attr_is_const_array_apply & my.restrictions.attr_is_const_array_required
        echo_fatal_required_attr(my.c_instance, "is_const_array")
    endif

    my.restrictions.attr_is_const_string_apply ?= "1"
    my.restrictions.attr_is_const_string_required ?= "0"

    if my.restrictions.attr_is_const_string_apply
        echo_trace("     Validate attribute: is_const_string=\"$(my.c_instance.is_const_string?)\"", my)
    endif

    if !defined(my.c_instance.is_const_string) & \
                my.restrictions.attr_is_const_string_apply & my.restrictions.attr_is_const_string_required
        echo_fatal_required_attr(my.c_instance, "is_const_string")
    endif

    my.restrictions.attr_is_const_reference_apply ?= "1"
    my.restrictions.attr_is_const_reference_required ?= "0"

    if my.restrictions.attr_is_const_reference_apply
        echo_trace("     Validate attribute: is_const_reference=\"$(my.c_instance.is_const_reference?)\"", my)
    endif

    if !defined(my.c_instance.is_const_reference) & \
                my.restrictions.attr_is_const_reference_apply & my.restrictions.attr_is_const_reference_required
        echo_fatal_required_attr(my.c_instance, "is_const_reference")
    endif

    my.restrictions.attr_require_definition_apply ?= "1"
    my.restrictions.attr_require_definition_required ?= "0"

    if my.restrictions.attr_require_definition_apply
        echo_trace("     Validate attribute: require_definition=\"$(my.c_instance.require_definition?)\"", my)
    endif

    if !defined(my.c_instance.require_definition) & \
                my.restrictions.attr_require_definition_apply & my.restrictions.attr_require_definition_required
        echo_fatal_required_attr(my.c_instance, "require_definition")
    endif
    if my.restrictions.attr_require_definition_apply & defined(my.c_instance.require_definition)
        my.require_definition_is_valid = "0"
        my.require_definition_is_valid = my.require_definition_is_valid | (my.c_instance.require_definition = "public")
        my.require_definition_is_valid = my.require_definition_is_valid | (my.c_instance.require_definition = "private")
        if !my.require_definition_is_valid
            echo_fatal_resticted_attr(my.c_instance, "require_definition", "public, private")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_feature_attr_setup_defaults(c_feature_attr, defaults)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.feature ?
    if defined(my.default_value) & !defined(my.c_feature_attr.feature)
        echo_trace("       feature=\"$(my.default_value:)\"", my)
        my.c_feature_attr.feature = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_feature_attr_validate(c_feature_attr, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_feature_apply ?= "1"
    my.restrictions.attr_feature_required ?= "0"

    if my.restrictions.attr_feature_apply
        echo_trace("     Validate attribute: feature=\"$(my.c_feature_attr.feature?)\"", my)
    endif

    if !defined(my.c_feature_attr.feature) & \
                my.restrictions.attr_feature_apply & my.restrictions.attr_feature_required
        echo_fatal_required_attr(my.c_feature_attr, "feature")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_feature_attr_validate_resolved(c_feature_attr, restrictions)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_feature_apply ?= "1"
    my.restrictions.attr_feature_required ?= "0"

    if my.restrictions.attr_feature_apply
        echo_trace("     Validate attribute: feature=\"$(my.c_feature_attr.feature?)\"", my)
    endif

    if !defined(my.c_feature_attr.feature) & \
                my.restrictions.attr_feature_apply & my.restrictions.attr_feature_required
        echo_fatal_required_attr(my.c_feature_attr, "feature")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_include_setup_defaults(c_include, defaults)
    my.c_include_name = defined(my.c_include.name) ?? " name=\"$(my.c_include.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_include))$(my.c_include_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    c_feature_attr_setup_defaults(my.c_include, my.defaults)
    scope_setup_defaults(my.c_include, my.defaults)

    my.default_value = my.defaults.file ?
    if defined(my.default_value) & !defined(my.c_include.file)
        echo_trace("       file=\"$(my.default_value:)\"", my)
        my.c_include.file = my.default_value
    endif

    my.default_value = my.defaults.is_system ? "0"
    if defined(my.default_value) & !defined(my.c_include.is_system)
        echo_trace("       is_system=\"$(my.default_value:)\"", my)
        my.c_include.is_system = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_include_validate(c_include, restrictions)
    my.c_include_name = defined(my.c_include.name) ?? " name=\"$(my.c_include.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_include))$(my.c_include_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        c_feature_attr_validate(my.c_include, restrictions)
    endnew

    new restrictions
        scope_validate(my.c_include, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_file_apply ?= "1"
    my.restrictions.attr_file_required ?= "1"

    if my.restrictions.attr_file_apply
        echo_trace("     Validate attribute: file=\"$(my.c_include.file?)\"", my)
    endif

    if !defined(my.c_include.file) & \
                my.restrictions.attr_file_apply & my.restrictions.attr_file_required
        echo_fatal_required_attr(my.c_include, "file")
    endif

    my.restrictions.attr_is_system_apply ?= "1"
    my.restrictions.attr_is_system_required ?= "0"

    if my.restrictions.attr_is_system_apply
        echo_trace("     Validate attribute: is_system=\"$(my.c_include.is_system?)\"", my)
    endif

    if !defined(my.c_include.is_system) & \
                my.restrictions.attr_is_system_apply & my.restrictions.attr_is_system_required
        echo_fatal_required_attr(my.c_include, "is_system")
    endif
    if my.restrictions.attr_is_system_apply & defined(my.c_include.is_system)
        my.is_system_is_valid = "0"
        my.is_system_is_valid = my.is_system_is_valid | (my.c_include.is_system = "0")
        my.is_system_is_valid = my.is_system_is_valid | (my.c_include.is_system = "1")
        if !my.is_system_is_valid
            echo_fatal_resticted_attr(my.c_include, "is_system", "0, 1")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_include_validate_resolved(c_include, restrictions)
    my.c_include_name = defined(my.c_include.name) ?? " name=\"$(my.c_include.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_include))$(my.c_include_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        c_feature_attr_validate_resolved(my.c_include, restrictions)
    endnew

    new restrictions
        scope_validate_resolved(my.c_include, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_file_apply ?= "1"
    my.restrictions.attr_file_required ?= "1"

    if my.restrictions.attr_file_apply
        echo_trace("     Validate attribute: file=\"$(my.c_include.file?)\"", my)
    endif

    if !defined(my.c_include.file) & \
                my.restrictions.attr_file_apply & my.restrictions.attr_file_required
        echo_fatal_required_attr(my.c_include, "file")
    endif

    my.restrictions.attr_is_system_apply ?= "1"
    my.restrictions.attr_is_system_required ?= "0"

    if my.restrictions.attr_is_system_apply
        echo_trace("     Validate attribute: is_system=\"$(my.c_include.is_system?)\"", my)
    endif

    if !defined(my.c_include.is_system) & \
                my.restrictions.attr_is_system_apply & my.restrictions.attr_is_system_required
        echo_fatal_required_attr(my.c_include, "is_system")
    endif
    if my.restrictions.attr_is_system_apply & defined(my.c_include.is_system)
        my.is_system_is_valid = "0"
        my.is_system_is_valid = my.is_system_is_valid | (my.c_include.is_system = "0")
        my.is_system_is_valid = my.is_system_is_valid | (my.c_include.is_system = "1")
        if !my.is_system_is_valid
            echo_fatal_resticted_attr(my.c_include, "is_system", "0, 1")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_alias_setup_defaults(c_alias, defaults)
    my.c_alias_name = defined(my.c_alias.name) ?? " name=\"$(my.c_alias.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_alias))$(my.c_alias_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    declaration_setup_defaults(my.c_alias, my.defaults)

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_alias.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_alias.name = my.default_value
    endif

    my.default_value = my.defaults.type ?
    if defined(my.default_value) & !defined(my.c_alias.type)
        echo_trace("       type=\"$(my.default_value:)\"", my)
        my.c_alias.type = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_alias_validate(c_alias, restrictions)
    my.c_alias_name = defined(my.c_alias.name) ?? " name=\"$(my.c_alias.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_alias))$(my.c_alias_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        declaration_validate(my.c_alias, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_alias.name?)\"", my)
    endif

    if !defined(my.c_alias.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_alias, "name")
    endif

    my.restrictions.attr_type_apply ?= "1"
    my.restrictions.attr_type_required ?= "1"

    if my.restrictions.attr_type_apply
        echo_trace("     Validate attribute: type=\"$(my.c_alias.type?)\"", my)
    endif

    if !defined(my.c_alias.type) & \
                my.restrictions.attr_type_apply & my.restrictions.attr_type_required
        echo_fatal_required_attr(my.c_alias, "type")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_alias_validate_resolved(c_alias, restrictions)
    my.c_alias_name = defined(my.c_alias.name) ?? " name=\"$(my.c_alias.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_alias))$(my.c_alias_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        declaration_validate_resolved(my.c_alias, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_alias.name?)\"", my)
    endif

    if !defined(my.c_alias.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_alias, "name")
    endif

    my.restrictions.attr_type_apply ?= "1"
    my.restrictions.attr_type_required ?= "1"

    if my.restrictions.attr_type_apply
        echo_trace("     Validate attribute: type=\"$(my.c_alias.type?)\"", my)
    endif

    if !defined(my.c_alias.type) & \
                my.restrictions.attr_type_apply & my.restrictions.attr_type_required
        echo_fatal_required_attr(my.c_alias, "type")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_constant_setup_defaults(c_constant, defaults)
    my.c_constant_name = defined(my.c_constant.name) ?? " name=\"$(my.c_constant.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_constant))$(my.c_constant_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    definition_setup_defaults(my.c_constant, my.defaults)
    uid_setup_defaults(my.c_constant, my.defaults)
    c_feature_attr_setup_defaults(my.c_constant, my.defaults)

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_constant.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_constant.name = my.default_value
    endif

    my.default_value = my.defaults.value ?
    if defined(my.default_value) & !defined(my.c_constant.value)
        echo_trace("       value=\"$(my.default_value:)\"", my)
        my.c_constant.value = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_constant_validate(c_constant, restrictions)
    my.c_constant_name = defined(my.c_constant.name) ?? " name=\"$(my.c_constant.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_constant))$(my.c_constant_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        definition_validate(my.c_constant, restrictions)
    endnew

    new restrictions
        uid_validate(my.c_constant, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate(my.c_constant, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_constant.name?)\"", my)
    endif

    if !defined(my.c_constant.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_constant, "name")
    endif

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "0"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.c_constant.value?)\"", my)
    endif

    if !defined(my.c_constant.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.c_constant, "value")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_constant_validate_resolved(c_constant, restrictions)
    my.c_constant_name = defined(my.c_constant.name) ?? " name=\"$(my.c_constant.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_constant))$(my.c_constant_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        definition_validate_resolved(my.c_constant, restrictions)
    endnew

    new restrictions
        uid_validate_resolved(my.c_constant, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate_resolved(my.c_constant, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_constant.name?)\"", my)
    endif

    if !defined(my.c_constant.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_constant, "name")
    endif

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "0"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.c_constant.value?)\"", my)
    endif

    if !defined(my.c_constant.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.c_constant, "value")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_enum_setup_defaults(c_enum, defaults)
    my.c_enum_name = defined(my.c_enum.name) ?? " name=\"$(my.c_enum.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_enum))$(my.c_enum_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    visibility_setup_defaults(my.c_enum, my.defaults)
    declaration_setup_defaults(my.c_enum, my.defaults)
    definition_setup_defaults(my.c_enum, my.defaults)
    uid_setup_defaults(my.c_enum, my.defaults)
    c_feature_attr_setup_defaults(my.c_enum, my.defaults)

    #    Setup defaults for allowed entities
    for my.c_enum.c_constant as _c_constant
        c_constant_setup_defaults(_c_constant)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_enum.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_enum.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_enum_validate(c_enum, restrictions)
    my.c_enum_name = defined(my.c_enum.name) ?? " name=\"$(my.c_enum.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_enum))$(my.c_enum_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        visibility_validate(my.c_enum, restrictions)
    endnew

    new restrictions
        declaration_validate(my.c_enum, restrictions)
    endnew

    new restrictions
        definition_validate(my.c_enum, restrictions)
    endnew

    new restrictions
        uid_validate(my.c_enum, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate(my.c_enum, restrictions)
    endnew

    #    Check allowed entities
    my.c_constant_count = count(my.c_enum.c_constant)
    if my.c_constant_count < 1
        my.dump_filename = entity_dump_file(my.c_enum)
        echo_fatal("Expected one or more entities: c_constant.\n" + \
                   "But found $(my.c_constant_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.c_enum.c_constant as _c_constant
        new restrictions
            c_constant_validate(_c_constant, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "0"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_enum.name?)\"", my)
    endif

    if !defined(my.c_enum.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_enum, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_enum_validate_resolved(c_enum, restrictions)
    my.c_enum_name = defined(my.c_enum.name) ?? " name=\"$(my.c_enum.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_enum))$(my.c_enum_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        visibility_validate_resolved(my.c_enum, restrictions)
    endnew

    new restrictions
        declaration_validate_resolved(my.c_enum, restrictions)
    endnew

    new restrictions
        definition_validate_resolved(my.c_enum, restrictions)
    endnew

    new restrictions
        uid_validate_resolved(my.c_enum, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate_resolved(my.c_enum, restrictions)
    endnew

    #    Check allowed entities
    for my.c_enum.c_constant as _c_constant
        new restrictions
            c_constant_validate_resolved(_c_constant, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "0"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_enum.name?)\"", my)
    endif

    if !defined(my.c_enum.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_enum, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_property_setup_defaults(c_property, defaults)
    my.c_property_name = defined(my.c_property.name) ?? " name=\"$(my.c_property.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_property))$(my.c_property_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    uid_setup_defaults(my.c_property, my.defaults)
    c_feature_attr_setup_defaults(my.c_property, my.defaults)
    c_instance_setup_defaults(my.c_property, my.defaults)

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_property.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_property.name = my.default_value
    endif

    my.default_value = my.defaults.bits ?
    if defined(my.default_value) & !defined(my.c_property.bits)
        echo_trace("       bits=\"$(my.default_value:)\"", my)
        my.c_property.bits = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_property_validate(c_property, restrictions)
    my.c_property_name = defined(my.c_property.name) ?? " name=\"$(my.c_property.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_property))$(my.c_property_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate(my.c_property, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate(my.c_property, restrictions)
    endnew

    new restrictions
        c_instance_validate(my.c_property, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_property.name?)\"", my)
    endif

    if !defined(my.c_property.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_property, "name")
    endif

    my.restrictions.attr_bits_apply ?= "1"
    my.restrictions.attr_bits_required ?= "0"

    if my.restrictions.attr_bits_apply
        echo_trace("     Validate attribute: bits=\"$(my.c_property.bits?)\"", my)
    endif

    if !defined(my.c_property.bits) & \
                my.restrictions.attr_bits_apply & my.restrictions.attr_bits_required
        echo_fatal_required_attr(my.c_property, "bits")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_property_validate_resolved(c_property, restrictions)
    my.c_property_name = defined(my.c_property.name) ?? " name=\"$(my.c_property.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_property))$(my.c_property_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate_resolved(my.c_property, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate_resolved(my.c_property, restrictions)
    endnew

    new restrictions
        c_instance_validate_resolved(my.c_property, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_property.name?)\"", my)
    endif

    if !defined(my.c_property.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_property, "name")
    endif

    my.restrictions.attr_bits_apply ?= "1"
    my.restrictions.attr_bits_required ?= "0"

    if my.restrictions.attr_bits_apply
        echo_trace("     Validate attribute: bits=\"$(my.c_property.bits?)\"", my)
    endif

    if !defined(my.c_property.bits) & \
                my.restrictions.attr_bits_apply & my.restrictions.attr_bits_required
        echo_fatal_required_attr(my.c_property, "bits")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_struct_setup_defaults(c_struct, defaults)
    my.c_struct_name = defined(my.c_struct.name) ?? " name=\"$(my.c_struct.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_struct))$(my.c_struct_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    uid_setup_defaults(my.c_struct, my.defaults)
    declaration_setup_defaults(my.c_struct, my.defaults)
    definition_setup_defaults(my.c_struct, my.defaults)
    c_feature_attr_setup_defaults(my.c_struct, my.defaults)

    #    Setup defaults for allowed entities
    for my.c_struct.c_property as _c_property
        c_property_setup_defaults(_c_property)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_struct.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_struct.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_struct_validate(c_struct, restrictions)
    my.c_struct_name = defined(my.c_struct.name) ?? " name=\"$(my.c_struct.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_struct))$(my.c_struct_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate(my.c_struct, restrictions)
    endnew

    new restrictions
        declaration_validate(my.c_struct, restrictions)
    endnew

    new restrictions
        definition_validate(my.c_struct, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate(my.c_struct, restrictions)
    endnew

    #    Check allowed entities
    my.c_property_count = count(my.c_struct.c_property)
    if my.c_property_count < 1
        my.dump_filename = entity_dump_file(my.c_struct)
        echo_fatal("Expected one or more entities: c_property.\n" + \
                   "But found $(my.c_property_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.c_struct.c_property as _c_property
        new restrictions
            c_property_validate(_c_property, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_struct.name?)\"", my)
    endif

    if !defined(my.c_struct.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_struct, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_struct_validate_resolved(c_struct, restrictions)
    my.c_struct_name = defined(my.c_struct.name) ?? " name=\"$(my.c_struct.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_struct))$(my.c_struct_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate_resolved(my.c_struct, restrictions)
    endnew

    new restrictions
        declaration_validate_resolved(my.c_struct, restrictions)
    endnew

    new restrictions
        definition_validate_resolved(my.c_struct, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate_resolved(my.c_struct, restrictions)
    endnew

    #    Check allowed entities
    for my.c_struct.c_property as _c_property
        new restrictions
            c_property_validate_resolved(_c_property, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_struct.name?)\"", my)
    endif

    if !defined(my.c_struct.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_struct, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_modifier_setup_defaults(c_modifier, defaults)
    my.c_modifier_name = defined(my.c_modifier.name) ?? " name=\"$(my.c_modifier.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_modifier))$(my.c_modifier_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.value ?
    if defined(my.default_value) & !defined(my.c_modifier.value)
        echo_trace("       value=\"$(my.default_value:)\"", my)
        my.c_modifier.value = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_modifier_validate(c_modifier, restrictions)
    my.c_modifier_name = defined(my.c_modifier.name) ?? " name=\"$(my.c_modifier.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_modifier))$(my.c_modifier_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "0"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.c_modifier.value?)\"", my)
    endif

    if !defined(my.c_modifier.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.c_modifier, "value")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_modifier_validate_resolved(c_modifier, restrictions)
    my.c_modifier_name = defined(my.c_modifier.name) ?? " name=\"$(my.c_modifier.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_modifier))$(my.c_modifier_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "0"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.c_modifier.value?)\"", my)
    endif

    if !defined(my.c_modifier.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.c_modifier, "value")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_return_setup_defaults(c_return, defaults)
    my.c_return_name = defined(my.c_return.name) ?? " name=\"$(my.c_return.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_return))$(my.c_return_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    c_instance_setup_defaults(my.c_return, my.defaults)

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_return_validate(c_return, restrictions)
    my.c_return_name = defined(my.c_return.name) ?? " name=\"$(my.c_return.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_return))$(my.c_return_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        c_instance_validate(my.c_return, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_return_validate_resolved(c_return, restrictions)
    my.c_return_name = defined(my.c_return.name) ?? " name=\"$(my.c_return.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_return))$(my.c_return_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        c_instance_validate_resolved(my.c_return, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_argument_setup_defaults(c_argument, defaults)
    my.c_argument_name = defined(my.c_argument.name) ?? " name=\"$(my.c_argument.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_argument))$(my.c_argument_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    uid_setup_defaults(my.c_argument, my.defaults)
    c_instance_setup_defaults(my.c_argument, my.defaults)

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_argument.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_argument.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_argument_validate(c_argument, restrictions)
    my.c_argument_name = defined(my.c_argument.name) ?? " name=\"$(my.c_argument.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_argument))$(my.c_argument_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate(my.c_argument, restrictions)
    endnew

    new restrictions
        c_instance_validate(my.c_argument, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_argument.name?)\"", my)
    endif

    if !defined(my.c_argument.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_argument, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_argument_validate_resolved(c_argument, restrictions)
    my.c_argument_name = defined(my.c_argument.name) ?? " name=\"$(my.c_argument.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_argument))$(my.c_argument_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate_resolved(my.c_argument, restrictions)
    endnew

    new restrictions
        c_instance_validate_resolved(my.c_argument, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_argument.name?)\"", my)
    endif

    if !defined(my.c_argument.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_argument, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_precondition_setup_defaults(c_precondition, defaults)
    my.c_precondition_name = defined(my.c_precondition.name) ?? " name=\"$(my.c_precondition.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_precondition))$(my.c_precondition_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.position ? "0"
    if defined(my.default_value) & !defined(my.c_precondition.position)
        echo_trace("       position=\"$(my.default_value:)\"", my)
        my.c_precondition.position = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_precondition_validate(c_precondition, restrictions)
    my.c_precondition_name = defined(my.c_precondition.name) ?? " name=\"$(my.c_precondition.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_precondition))$(my.c_precondition_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_position_apply ?= "1"
    my.restrictions.attr_position_required ?= "0"

    if my.restrictions.attr_position_apply
        echo_trace("     Validate attribute: position=\"$(my.c_precondition.position?)\"", my)
    endif

    if !defined(my.c_precondition.position) & \
                my.restrictions.attr_position_apply & my.restrictions.attr_position_required
        echo_fatal_required_attr(my.c_precondition, "position")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_precondition_validate_resolved(c_precondition, restrictions)
    my.c_precondition_name = defined(my.c_precondition.name) ?? " name=\"$(my.c_precondition.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_precondition))$(my.c_precondition_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_position_apply ?= "1"
    my.restrictions.attr_position_required ?= "0"

    if my.restrictions.attr_position_apply
        echo_trace("     Validate attribute: position=\"$(my.c_precondition.position?)\"", my)
    endif

    if !defined(my.c_precondition.position) & \
                my.restrictions.attr_position_apply & my.restrictions.attr_position_required
        echo_fatal_required_attr(my.c_precondition, "position")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_attribute_setup_defaults(c_attribute, defaults)
    my.c_attribute_name = defined(my.c_attribute.name) ?? " name=\"$(my.c_attribute.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_attribute))$(my.c_attribute_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.value ?
    if defined(my.default_value) & !defined(my.c_attribute.value)
        echo_trace("       value=\"$(my.default_value:)\"", my)
        my.c_attribute.value = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_attribute_validate(c_attribute, restrictions)
    my.c_attribute_name = defined(my.c_attribute.name) ?? " name=\"$(my.c_attribute.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_attribute))$(my.c_attribute_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "0"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.c_attribute.value?)\"", my)
    endif

    if !defined(my.c_attribute.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.c_attribute, "value")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_attribute_validate_resolved(c_attribute, restrictions)
    my.c_attribute_name = defined(my.c_attribute.name) ?? " name=\"$(my.c_attribute.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_attribute))$(my.c_attribute_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "0"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.c_attribute.value?)\"", my)
    endif

    if !defined(my.c_attribute.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.c_attribute, "value")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_method_setup_defaults(c_method, defaults)
    my.c_method_name = defined(my.c_method.name) ?? " name=\"$(my.c_method.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_method))$(my.c_method_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    visibility_setup_defaults(my.c_method, my.defaults)
    declaration_setup_defaults(my.c_method, my.defaults)
    definition_setup_defaults(my.c_method, my.defaults)
    uid_setup_defaults(my.c_method, my.defaults)
    c_feature_attr_setup_defaults(my.c_method, my.defaults)

    #    Setup defaults for allowed entities
    for my.c_method.c_modifier as _c_modifier
        c_modifier_setup_defaults(_c_modifier)
    endfor

    for my.c_method.c_return as _c_return
        c_return_setup_defaults(_c_return)
    endfor

    for my.c_method.c_argument as _c_argument
        c_argument_setup_defaults(_c_argument)
    endfor

    for my.c_method.c_precondition as _c_precondition
        c_precondition_setup_defaults(_c_precondition)
    endfor

    for my.c_method.c_attribute as _c_attribute
        c_attribute_setup_defaults(_c_attribute)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_method.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_method.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_method_validate(c_method, restrictions)
    my.c_method_name = defined(my.c_method.name) ?? " name=\"$(my.c_method.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_method))$(my.c_method_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        visibility_validate(my.c_method, restrictions)
    endnew

    new restrictions
        declaration_validate(my.c_method, restrictions)
    endnew

    new restrictions
        definition_validate(my.c_method, restrictions)
    endnew

    new restrictions
        uid_validate(my.c_method, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate(my.c_method, restrictions)
    endnew

    #    Check allowed entities
    my.c_modifier_count = count(my.c_method.c_modifier)
    for my.c_method.c_modifier as _c_modifier
        new restrictions
            c_modifier_validate(_c_modifier, restrictions)
        endnew
    endfor

    my.c_return_count = count(my.c_method.c_return)
    if my.c_return_count > 1
        my.dump_filename = entity_dump_file(my.c_method)
        echo_fatal("Expected zero one entity: c_return.\n" + \
                   "But found $(my.c_return_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.c_method.c_return as _c_return
        new restrictions
            c_return_validate(_c_return, restrictions)
        endnew
    endfor

    my.c_argument_count = count(my.c_method.c_argument)
    for my.c_method.c_argument as _c_argument
        new restrictions
            c_argument_validate(_c_argument, restrictions)
        endnew
    endfor

    my.c_precondition_count = count(my.c_method.c_precondition)
    for my.c_method.c_precondition as _c_precondition
        new restrictions
            c_precondition_validate(_c_precondition, restrictions)
        endnew
    endfor

    my.c_attribute_count = count(my.c_method.c_attribute)
    for my.c_method.c_attribute as _c_attribute
        new restrictions
            c_attribute_validate(_c_attribute, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_method.name?)\"", my)
    endif

    if !defined(my.c_method.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_method, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_method_validate_resolved(c_method, restrictions)
    my.c_method_name = defined(my.c_method.name) ?? " name=\"$(my.c_method.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_method))$(my.c_method_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        visibility_validate_resolved(my.c_method, restrictions)
    endnew

    new restrictions
        declaration_validate_resolved(my.c_method, restrictions)
    endnew

    new restrictions
        definition_validate_resolved(my.c_method, restrictions)
    endnew

    new restrictions
        uid_validate_resolved(my.c_method, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate_resolved(my.c_method, restrictions)
    endnew

    #    Check allowed entities
    for my.c_method.c_modifier as _c_modifier
        new restrictions
            c_modifier_validate_resolved(_c_modifier, restrictions)
        endnew
    endfor

    for my.c_method.c_return as _c_return
        new restrictions
            c_return_validate_resolved(_c_return, restrictions)
        endnew
    endfor

    for my.c_method.c_argument as _c_argument
        new restrictions
            c_argument_validate_resolved(_c_argument, restrictions)
        endnew
    endfor

    for my.c_method.c_precondition as _c_precondition
        new restrictions
            c_precondition_validate_resolved(_c_precondition, restrictions)
        endnew
    endfor

    for my.c_method.c_attribute as _c_attribute
        new restrictions
            c_attribute_validate_resolved(_c_attribute, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_method.name?)\"", my)
    endif

    if !defined(my.c_method.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_method, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_callback_setup_defaults(c_callback, defaults)
    my.c_callback_name = defined(my.c_callback.name) ?? " name=\"$(my.c_callback.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_callback))$(my.c_callback_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    uid_setup_defaults(my.c_callback, my.defaults)
    declaration_setup_defaults(my.c_callback, my.defaults)

    #    Setup defaults for allowed entities
    for my.c_callback.c_return as _c_return
        c_return_setup_defaults(_c_return)
    endfor

    for my.c_callback.c_argument as _c_argument
        c_argument_setup_defaults(_c_argument)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_callback.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_callback.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_callback_validate(c_callback, restrictions)
    my.c_callback_name = defined(my.c_callback.name) ?? " name=\"$(my.c_callback.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_callback))$(my.c_callback_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate(my.c_callback, restrictions)
    endnew

    new restrictions
        declaration_validate(my.c_callback, restrictions)
    endnew

    #    Check allowed entities
    my.c_return_count = count(my.c_callback.c_return)
    if my.c_return_count > 1
        my.dump_filename = entity_dump_file(my.c_callback)
        echo_fatal("Expected zero one entity: c_return.\n" + \
                   "But found $(my.c_return_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.c_callback.c_return as _c_return
        new restrictions
            c_return_validate(_c_return, restrictions)
        endnew
    endfor

    my.c_argument_count = count(my.c_callback.c_argument)
    for my.c_callback.c_argument as _c_argument
        new restrictions
            c_argument_validate(_c_argument, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_callback.name?)\"", my)
    endif

    if !defined(my.c_callback.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_callback, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_callback_validate_resolved(c_callback, restrictions)
    my.c_callback_name = defined(my.c_callback.name) ?? " name=\"$(my.c_callback.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_callback))$(my.c_callback_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate_resolved(my.c_callback, restrictions)
    endnew

    new restrictions
        declaration_validate_resolved(my.c_callback, restrictions)
    endnew

    #    Check allowed entities
    for my.c_callback.c_return as _c_return
        new restrictions
            c_return_validate_resolved(_c_return, restrictions)
        endnew
    endfor

    for my.c_callback.c_argument as _c_argument
        new restrictions
            c_argument_validate_resolved(_c_argument, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_callback.name?)\"", my)
    endif

    if !defined(my.c_callback.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_callback, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_code_setup_defaults(c_code, defaults)
    my.c_code_name = defined(my.c_code.name) ?? " name=\"$(my.c_code.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_code))$(my.c_code_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_code_validate(c_code, restrictions)
    my.c_code_name = defined(my.c_code.name) ?? " name=\"$(my.c_code.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_code))$(my.c_code_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_code_validate_resolved(c_code, restrictions)
    my.c_code_name = defined(my.c_code.name) ?? " name=\"$(my.c_code.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_code))$(my.c_code_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_macros_setup_defaults(c_macros, defaults)
    my.c_macros_name = defined(my.c_macros.name) ?? " name=\"$(my.c_macros.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_macros))$(my.c_macros_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    uid_setup_defaults(my.c_macros, my.defaults)
    definition_setup_defaults(my.c_macros, my.defaults)
    c_feature_attr_setup_defaults(my.c_macros, my.defaults)

    #    Setup defaults for allowed entities
    for my.c_macros.c_code as _c_code
        c_code_setup_defaults(_c_code)
    endfor

    my.default_value = my.defaults.is_method ? "0"
    if defined(my.default_value) & !defined(my.c_macros.is_method)
        echo_trace("       is_method=\"$(my.default_value:)\"", my)
        my.c_macros.is_method = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_macros_validate(c_macros, restrictions)
    my.c_macros_name = defined(my.c_macros.name) ?? " name=\"$(my.c_macros.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_macros))$(my.c_macros_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate(my.c_macros, restrictions)
    endnew

    new restrictions
        definition_validate(my.c_macros, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate(my.c_macros, restrictions)
    endnew

    #    Check allowed entities
    my.c_code_count = count(my.c_macros.c_code)
    if my.c_code_count > 1
        my.dump_filename = entity_dump_file(my.c_macros)
        echo_fatal("Expected zero one entity: c_code.\n" + \
                   "But found $(my.c_code_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.c_macros.c_code as _c_code
        new restrictions
            c_code_validate(_c_code, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_is_method_apply ?= "1"
    my.restrictions.attr_is_method_required ?= "0"

    if my.restrictions.attr_is_method_apply
        echo_trace("     Validate attribute: is_method=\"$(my.c_macros.is_method?)\"", my)
    endif

    if !defined(my.c_macros.is_method) & \
                my.restrictions.attr_is_method_apply & my.restrictions.attr_is_method_required
        echo_fatal_required_attr(my.c_macros, "is_method")
    endif
    if my.restrictions.attr_is_method_apply & defined(my.c_macros.is_method)
        my.is_method_is_valid = "0"
        my.is_method_is_valid = my.is_method_is_valid | (my.c_macros.is_method = "0")
        my.is_method_is_valid = my.is_method_is_valid | (my.c_macros.is_method = "1")
        if !my.is_method_is_valid
            echo_fatal_resticted_attr(my.c_macros, "is_method", "0, 1")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_macros_validate_resolved(c_macros, restrictions)
    my.c_macros_name = defined(my.c_macros.name) ?? " name=\"$(my.c_macros.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_macros))$(my.c_macros_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate_resolved(my.c_macros, restrictions)
    endnew

    new restrictions
        definition_validate_resolved(my.c_macros, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate_resolved(my.c_macros, restrictions)
    endnew

    #    Check allowed entities
    for my.c_macros.c_code as _c_code
        new restrictions
            c_code_validate_resolved(_c_code, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_is_method_apply ?= "1"
    my.restrictions.attr_is_method_required ?= "0"

    if my.restrictions.attr_is_method_apply
        echo_trace("     Validate attribute: is_method=\"$(my.c_macros.is_method?)\"", my)
    endif

    if !defined(my.c_macros.is_method) & \
                my.restrictions.attr_is_method_apply & my.restrictions.attr_is_method_required
        echo_fatal_required_attr(my.c_macros, "is_method")
    endif
    if my.restrictions.attr_is_method_apply & defined(my.c_macros.is_method)
        my.is_method_is_valid = "0"
        my.is_method_is_valid = my.is_method_is_valid | (my.c_macros.is_method = "0")
        my.is_method_is_valid = my.is_method_is_valid | (my.c_macros.is_method = "1")
        if !my.is_method_is_valid
            echo_fatal_resticted_attr(my.c_macros, "is_method", "0, 1")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_macroses_setup_defaults(c_macroses, defaults)
    my.c_macroses_name = defined(my.c_macroses.name) ?? " name=\"$(my.c_macroses.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_macroses))$(my.c_macroses_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    definition_setup_defaults(my.c_macroses, my.defaults)

    #    Setup defaults for allowed entities
    for my.c_macroses.c_macros as _c_macros
        c_macros_setup_defaults(_c_macros)
    endfor

    for my.c_macroses.c_code as _c_code
        c_code_setup_defaults(_c_code)
    endfor

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_macroses_validate(c_macroses, restrictions)
    my.c_macroses_name = defined(my.c_macroses.name) ?? " name=\"$(my.c_macroses.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_macroses))$(my.c_macroses_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        definition_validate(my.c_macroses, restrictions)
    endnew

    #    Check allowed entities
    my.c_macros_count = count(my.c_macroses.c_macros)
    if my.c_macros_count < 1
        my.dump_filename = entity_dump_file(my.c_macroses)
        echo_fatal("Expected one or more entities: c_macros.\n" + \
                   "But found $(my.c_macros_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.c_macroses.c_macros as _c_macros
        new restrictions
            c_macros_validate(_c_macros, restrictions)
        endnew
    endfor

    my.c_code_count = count(my.c_macroses.c_code)
    if my.c_code_count > 1
        my.dump_filename = entity_dump_file(my.c_macroses)
        echo_fatal("Expected zero one entity: c_code.\n" + \
                   "But found $(my.c_code_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.c_macroses.c_code as _c_code
        new restrictions
            c_code_validate(_c_code, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_macroses_validate_resolved(c_macroses, restrictions)
    my.c_macroses_name = defined(my.c_macroses.name) ?? " name=\"$(my.c_macroses.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_macroses))$(my.c_macroses_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        definition_validate_resolved(my.c_macroses, restrictions)
    endnew

    #    Check allowed entities
    for my.c_macroses.c_macros as _c_macros
        new restrictions
            c_macros_validate_resolved(_c_macros, restrictions)
        endnew
    endfor

    for my.c_macroses.c_code as _c_code
        new restrictions
            c_code_validate_resolved(_c_code, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_cast_setup_defaults(c_cast, defaults)
    my.c_cast_name = defined(my.c_cast.name) ?? " name=\"$(my.c_cast.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_cast))$(my.c_cast_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    c_instance_setup_defaults(my.c_cast, my.defaults)

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_cast_validate(c_cast, restrictions)
    my.c_cast_name = defined(my.c_cast.name) ?? " name=\"$(my.c_cast.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_cast))$(my.c_cast_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        c_instance_validate(my.c_cast, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_cast_validate_resolved(c_cast, restrictions)
    my.c_cast_name = defined(my.c_cast.name) ?? " name=\"$(my.c_cast.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_cast))$(my.c_cast_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        c_instance_validate_resolved(my.c_cast, restrictions)
    endnew

    my.restrictions ?= XML.new("restrictions")

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_value_setup_defaults(c_value, defaults)
    my.c_value_name = defined(my.c_value.name) ?? " name=\"$(my.c_value.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_value))$(my.c_value_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for allowed entities
    for my.c_value.c_cast as _c_cast
        c_cast_setup_defaults(_c_cast)
    endfor

    my.default_value = my.defaults.value ?
    if defined(my.default_value) & !defined(my.c_value.value)
        echo_trace("       value=\"$(my.default_value:)\"", my)
        my.c_value.value = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_value_validate(c_value, restrictions)
    my.c_value_name = defined(my.c_value.name) ?? " name=\"$(my.c_value.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_value))$(my.c_value_name)/>", my)

    #    Check allowed entities
    my.c_cast_count = count(my.c_value.c_cast)
    if my.c_cast_count > 1
        my.dump_filename = entity_dump_file(my.c_value)
        echo_fatal("Expected zero one entity: c_cast.\n" + \
                   "But found $(my.c_cast_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.c_value.c_cast as _c_cast
        new restrictions
            c_cast_validate(_c_cast, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "1"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.c_value.value?)\"", my)
    endif

    if !defined(my.c_value.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.c_value, "value")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_value_validate_resolved(c_value, restrictions)
    my.c_value_name = defined(my.c_value.name) ?? " name=\"$(my.c_value.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_value))$(my.c_value_name)/>", my)

    #    Check allowed entities
    for my.c_value.c_cast as _c_cast
        new restrictions
            c_cast_validate_resolved(_c_cast, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_value_apply ?= "1"
    my.restrictions.attr_value_required ?= "1"

    if my.restrictions.attr_value_apply
        echo_trace("     Validate attribute: value=\"$(my.c_value.value?)\"", my)
    endif

    if !defined(my.c_value.value) & \
                my.restrictions.attr_value_apply & my.restrictions.attr_value_required
        echo_fatal_required_attr(my.c_value, "value")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_variable_setup_defaults(c_variable, defaults)
    my.c_variable_name = defined(my.c_variable.name) ?? " name=\"$(my.c_variable.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_variable))$(my.c_variable_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    uid_setup_defaults(my.c_variable, my.defaults)
    visibility_setup_defaults(my.c_variable, my.defaults)
    declaration_setup_defaults(my.c_variable, my.defaults)
    definition_setup_defaults(my.c_variable, my.defaults)
    c_feature_attr_setup_defaults(my.c_variable, my.defaults)
    c_instance_setup_defaults(my.c_variable, my.defaults)

    #    Setup defaults for allowed entities
    for my.c_variable.c_value as _c_value
        c_value_setup_defaults(_c_value)
    endfor

    for my.c_variable.c_modifier as _c_modifier
        c_modifier_setup_defaults(_c_modifier)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_variable.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_variable.name = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_variable_validate(c_variable, restrictions)
    my.c_variable_name = defined(my.c_variable.name) ?? " name=\"$(my.c_variable.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_variable))$(my.c_variable_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate(my.c_variable, restrictions)
    endnew

    new restrictions
        visibility_validate(my.c_variable, restrictions)
    endnew

    new restrictions
        declaration_validate(my.c_variable, restrictions)
    endnew

    new restrictions
        definition_validate(my.c_variable, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate(my.c_variable, restrictions)
    endnew

    new restrictions
        c_instance_validate(my.c_variable, restrictions)
    endnew

    #    Check allowed entities
    my.c_value_count = count(my.c_variable.c_value)
    if my.c_value_count < 1
        my.dump_filename = entity_dump_file(my.c_variable)
        echo_fatal("Expected one or more entities: c_value.\n" + \
                   "But found $(my.c_value_count).\n" + \
                   "See dump file: $(my.dump_filename:)", my)
    endif
    for my.c_variable.c_value as _c_value
        new restrictions
            c_value_validate(_c_value, restrictions)
        endnew
    endfor

    my.c_modifier_count = count(my.c_variable.c_modifier)
    for my.c_variable.c_modifier as _c_modifier
        new restrictions
            c_modifier_validate(_c_modifier, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_variable.name?)\"", my)
    endif

    if !defined(my.c_variable.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_variable, "name")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_variable_validate_resolved(c_variable, restrictions)
    my.c_variable_name = defined(my.c_variable.name) ?? " name=\"$(my.c_variable.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_variable))$(my.c_variable_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate_resolved(my.c_variable, restrictions)
    endnew

    new restrictions
        visibility_validate_resolved(my.c_variable, restrictions)
    endnew

    new restrictions
        declaration_validate_resolved(my.c_variable, restrictions)
    endnew

    new restrictions
        definition_validate_resolved(my.c_variable, restrictions)
    endnew

    new restrictions
        c_feature_attr_validate_resolved(my.c_variable, restrictions)
    endnew

    new restrictions
        c_instance_validate_resolved(my.c_variable, restrictions)
    endnew

    #    Check allowed entities
    for my.c_variable.c_value as _c_value
        new restrictions
            c_value_validate_resolved(_c_value, restrictions)
        endnew
    endfor

    for my.c_variable.c_modifier as _c_modifier
        new restrictions
            c_modifier_validate_resolved(_c_modifier, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_variable.name?)\"", my)
    endif

    if !defined(my.c_variable.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_variable, "name")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_module_setup_defaults(c_module, defaults)
    my.c_module_name = defined(my.c_module.name) ?? " name=\"$(my.c_module.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_module))$(my.c_module_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    scope_setup_defaults(my.c_module, my.defaults)
    of_class_setup_defaults(my.c_module, my.defaults)

    #    Setup defaults for allowed entities
    for my.c_module.c_include as _c_include
        c_include_setup_defaults(_c_include)
    endfor

    for my.c_module.c_alias as _c_alias
        c_alias_setup_defaults(_c_alias)
    endfor

    for my.c_module.c_enum as _c_enum
        c_enum_setup_defaults(_c_enum)
    endfor

    for my.c_module.c_struct as _c_struct
        c_struct_setup_defaults(_c_struct)
    endfor

    for my.c_module.c_variable as _c_variable
        c_variable_setup_defaults(_c_variable)
    endfor

    for my.c_module.c_method as _c_method
        c_method_setup_defaults(_c_method)
    endfor

    for my.c_module.c_callback as _c_callback
        c_callback_setup_defaults(_c_callback)
    endfor

    for my.c_module.c_macros as _c_macros
        c_macros_setup_defaults(_c_macros)
    endfor

    for my.c_module.c_macroses as _c_macroses
        c_macroses_setup_defaults(_c_macroses)
    endfor

    my.default_value = my.defaults.id ?
    if defined(my.default_value) & !defined(my.c_module.id)
        echo_trace("       id=\"$(my.default_value:)\"", my)
        my.c_module.id = my.default_value
    endif

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_module.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_module.name = my.default_value
    endif

    my.default_value = my.defaults.header_file ?
    if defined(my.default_value) & !defined(my.c_module.header_file)
        echo_trace("       header_file=\"$(my.default_value:)\"", my)
        my.c_module.header_file = my.default_value
    endif

    my.default_value = my.defaults.source_file ?
    if defined(my.default_value) & !defined(my.c_module.source_file)
        echo_trace("       source_file=\"$(my.default_value:)\"", my)
        my.c_module.source_file = my.default_value
    endif

    my.default_value = my.defaults.output_header_file ?
    if defined(my.default_value) & !defined(my.c_module.output_header_file)
        echo_trace("       output_header_file=\"$(my.default_value:)\"", my)
        my.c_module.output_header_file = my.default_value
    endif

    my.default_value = my.defaults.output_source_file ?
    if defined(my.default_value) & !defined(my.c_module.output_source_file)
        echo_trace("       output_source_file=\"$(my.default_value:)\"", my)
        my.c_module.output_source_file = my.default_value
    endif

    my.default_value = my.defaults.once_guard ?
    if defined(my.default_value) & !defined(my.c_module.once_guard)
        echo_trace("       once_guard=\"$(my.default_value:)\"", my)
        my.c_module.once_guard = my.default_value
    endif

    my.default_value = my.defaults.has_cmakedefine ? "0"
    if defined(my.default_value) & !defined(my.c_module.has_cmakedefine)
        echo_trace("       has_cmakedefine=\"$(my.default_value:)\"", my)
        my.c_module.has_cmakedefine = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_module_validate(c_module, restrictions)
    my.c_module_name = defined(my.c_module.name) ?? " name=\"$(my.c_module.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_module))$(my.c_module_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scope_validate(my.c_module, restrictions)
    endnew

    new restrictions
        of_class_validate(my.c_module, restrictions)
    endnew

    #    Check allowed entities
    my.c_include_count = count(my.c_module.c_include)
    for my.c_module.c_include as _c_include
        new restrictions
            c_include_validate(_c_include, restrictions)
        endnew
    endfor

    my.c_alias_count = count(my.c_module.c_alias)
    for my.c_module.c_alias as _c_alias
        new restrictions
            c_alias_validate(_c_alias, restrictions)
        endnew
    endfor

    my.c_enum_count = count(my.c_module.c_enum)
    for my.c_module.c_enum as _c_enum
        new restrictions
            c_enum_validate(_c_enum, restrictions)
        endnew
    endfor

    my.c_struct_count = count(my.c_module.c_struct)
    for my.c_module.c_struct as _c_struct
        new restrictions
            c_struct_validate(_c_struct, restrictions)
        endnew
    endfor

    my.c_variable_count = count(my.c_module.c_variable)
    for my.c_module.c_variable as _c_variable
        new restrictions
            c_variable_validate(_c_variable, restrictions)
        endnew
    endfor

    my.c_method_count = count(my.c_module.c_method)
    for my.c_module.c_method as _c_method
        new restrictions
            c_method_validate(_c_method, restrictions)
        endnew
    endfor

    my.c_callback_count = count(my.c_module.c_callback)
    for my.c_module.c_callback as _c_callback
        new restrictions
            c_callback_validate(_c_callback, restrictions)
        endnew
    endfor

    my.c_macros_count = count(my.c_module.c_macros)
    for my.c_module.c_macros as _c_macros
        new restrictions
            c_macros_validate(_c_macros, restrictions)
        endnew
    endfor

    my.c_macroses_count = count(my.c_module.c_macroses)
    for my.c_module.c_macroses as _c_macroses
        new restrictions
            c_macroses_validate(_c_macroses, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_id_apply ?= "1"
    my.restrictions.attr_id_required ?= "1"

    if my.restrictions.attr_id_apply
        echo_trace("     Validate attribute: id=\"$(my.c_module.id?)\"", my)
    endif

    if !defined(my.c_module.id) & \
                my.restrictions.attr_id_apply & my.restrictions.attr_id_required
        echo_fatal_required_attr(my.c_module, "id")
    endif

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_module.name?)\"", my)
    endif

    if !defined(my.c_module.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_module, "name")
    endif

    my.restrictions.attr_header_file_apply ?= "1"
    my.restrictions.attr_header_file_required ?= "1"

    if my.restrictions.attr_header_file_apply
        echo_trace("     Validate attribute: header_file=\"$(my.c_module.header_file?)\"", my)
    endif

    if !defined(my.c_module.header_file) & \
                my.restrictions.attr_header_file_apply & my.restrictions.attr_header_file_required
        echo_fatal_required_attr(my.c_module, "header_file")
    endif

    my.restrictions.attr_source_file_apply ?= "1"
    my.restrictions.attr_source_file_required ?= "1"

    if my.restrictions.attr_source_file_apply
        echo_trace("     Validate attribute: source_file=\"$(my.c_module.source_file?)\"", my)
    endif

    if !defined(my.c_module.source_file) & \
                my.restrictions.attr_source_file_apply & my.restrictions.attr_source_file_required
        echo_fatal_required_attr(my.c_module, "source_file")
    endif

    my.restrictions.attr_output_header_file_apply ?= "1"
    my.restrictions.attr_output_header_file_required ?= "1"

    if my.restrictions.attr_output_header_file_apply
        echo_trace("     Validate attribute: output_header_file=\"$(my.c_module.output_header_file?)\"", my)
    endif

    if !defined(my.c_module.output_header_file) & \
                my.restrictions.attr_output_header_file_apply & my.restrictions.attr_output_header_file_required
        echo_fatal_required_attr(my.c_module, "output_header_file")
    endif

    my.restrictions.attr_output_source_file_apply ?= "1"
    my.restrictions.attr_output_source_file_required ?= "1"

    if my.restrictions.attr_output_source_file_apply
        echo_trace("     Validate attribute: output_source_file=\"$(my.c_module.output_source_file?)\"", my)
    endif

    if !defined(my.c_module.output_source_file) & \
                my.restrictions.attr_output_source_file_apply & my.restrictions.attr_output_source_file_required
        echo_fatal_required_attr(my.c_module, "output_source_file")
    endif

    my.restrictions.attr_once_guard_apply ?= "1"
    my.restrictions.attr_once_guard_required ?= "1"

    if my.restrictions.attr_once_guard_apply
        echo_trace("     Validate attribute: once_guard=\"$(my.c_module.once_guard?)\"", my)
    endif

    if !defined(my.c_module.once_guard) & \
                my.restrictions.attr_once_guard_apply & my.restrictions.attr_once_guard_required
        echo_fatal_required_attr(my.c_module, "once_guard")
    endif

    my.restrictions.attr_has_cmakedefine_apply ?= "1"
    my.restrictions.attr_has_cmakedefine_required ?= "0"

    if my.restrictions.attr_has_cmakedefine_apply
        echo_trace("     Validate attribute: has_cmakedefine=\"$(my.c_module.has_cmakedefine?)\"", my)
    endif

    if !defined(my.c_module.has_cmakedefine) & \
                my.restrictions.attr_has_cmakedefine_apply & my.restrictions.attr_has_cmakedefine_required
        echo_fatal_required_attr(my.c_module, "has_cmakedefine")
    endif
    if my.restrictions.attr_has_cmakedefine_apply & defined(my.c_module.has_cmakedefine)
        my.has_cmakedefine_is_valid = "0"
        my.has_cmakedefine_is_valid = my.has_cmakedefine_is_valid | (my.c_module.has_cmakedefine = "0")
        my.has_cmakedefine_is_valid = my.has_cmakedefine_is_valid | (my.c_module.has_cmakedefine = "1")
        if !my.has_cmakedefine_is_valid
            echo_fatal_resticted_attr(my.c_module, "has_cmakedefine", "0, 1")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_module_validate_resolved(c_module, restrictions)
    my.c_module_name = defined(my.c_module.name) ?? " name=\"$(my.c_module.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_module))$(my.c_module_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        scope_validate_resolved(my.c_module, restrictions)
    endnew

    new restrictions
        of_class_validate_resolved(my.c_module, restrictions)
    endnew

    #    Check allowed entities
    for my.c_module.c_include as _c_include
        new restrictions
            c_include_validate_resolved(_c_include, restrictions)
        endnew
    endfor

    for my.c_module.c_alias as _c_alias
        new restrictions
            c_alias_validate_resolved(_c_alias, restrictions)
        endnew
    endfor

    for my.c_module.c_enum as _c_enum
        new restrictions
            c_enum_validate_resolved(_c_enum, restrictions)
        endnew
    endfor

    for my.c_module.c_struct as _c_struct
        new restrictions
            c_struct_validate_resolved(_c_struct, restrictions)
        endnew
    endfor

    for my.c_module.c_variable as _c_variable
        new restrictions
            c_variable_validate_resolved(_c_variable, restrictions)
        endnew
    endfor

    for my.c_module.c_method as _c_method
        new restrictions
            c_method_validate_resolved(_c_method, restrictions)
        endnew
    endfor

    for my.c_module.c_callback as _c_callback
        new restrictions
            c_callback_validate_resolved(_c_callback, restrictions)
        endnew
    endfor

    for my.c_module.c_macros as _c_macros
        new restrictions
            c_macros_validate_resolved(_c_macros, restrictions)
        endnew
    endfor

    for my.c_module.c_macroses as _c_macroses
        new restrictions
            c_macroses_validate_resolved(_c_macroses, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_id_apply ?= "1"
    my.restrictions.attr_id_required ?= "1"

    if my.restrictions.attr_id_apply
        echo_trace("     Validate attribute: id=\"$(my.c_module.id?)\"", my)
    endif

    if !defined(my.c_module.id) & \
                my.restrictions.attr_id_apply & my.restrictions.attr_id_required
        echo_fatal_required_attr(my.c_module, "id")
    endif

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_module.name?)\"", my)
    endif

    if !defined(my.c_module.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_module, "name")
    endif

    my.restrictions.attr_header_file_apply ?= "1"
    my.restrictions.attr_header_file_required ?= "1"

    if my.restrictions.attr_header_file_apply
        echo_trace("     Validate attribute: header_file=\"$(my.c_module.header_file?)\"", my)
    endif

    if !defined(my.c_module.header_file) & \
                my.restrictions.attr_header_file_apply & my.restrictions.attr_header_file_required
        echo_fatal_required_attr(my.c_module, "header_file")
    endif

    my.restrictions.attr_source_file_apply ?= "1"
    my.restrictions.attr_source_file_required ?= "1"

    if my.restrictions.attr_source_file_apply
        echo_trace("     Validate attribute: source_file=\"$(my.c_module.source_file?)\"", my)
    endif

    if !defined(my.c_module.source_file) & \
                my.restrictions.attr_source_file_apply & my.restrictions.attr_source_file_required
        echo_fatal_required_attr(my.c_module, "source_file")
    endif

    my.restrictions.attr_output_header_file_apply ?= "1"
    my.restrictions.attr_output_header_file_required ?= "1"

    if my.restrictions.attr_output_header_file_apply
        echo_trace("     Validate attribute: output_header_file=\"$(my.c_module.output_header_file?)\"", my)
    endif

    if !defined(my.c_module.output_header_file) & \
                my.restrictions.attr_output_header_file_apply & my.restrictions.attr_output_header_file_required
        echo_fatal_required_attr(my.c_module, "output_header_file")
    endif

    my.restrictions.attr_output_source_file_apply ?= "1"
    my.restrictions.attr_output_source_file_required ?= "1"

    if my.restrictions.attr_output_source_file_apply
        echo_trace("     Validate attribute: output_source_file=\"$(my.c_module.output_source_file?)\"", my)
    endif

    if !defined(my.c_module.output_source_file) & \
                my.restrictions.attr_output_source_file_apply & my.restrictions.attr_output_source_file_required
        echo_fatal_required_attr(my.c_module, "output_source_file")
    endif

    my.restrictions.attr_once_guard_apply ?= "1"
    my.restrictions.attr_once_guard_required ?= "1"

    if my.restrictions.attr_once_guard_apply
        echo_trace("     Validate attribute: once_guard=\"$(my.c_module.once_guard?)\"", my)
    endif

    if !defined(my.c_module.once_guard) & \
                my.restrictions.attr_once_guard_apply & my.restrictions.attr_once_guard_required
        echo_fatal_required_attr(my.c_module, "once_guard")
    endif

    my.restrictions.attr_has_cmakedefine_apply ?= "1"
    my.restrictions.attr_has_cmakedefine_required ?= "0"

    if my.restrictions.attr_has_cmakedefine_apply
        echo_trace("     Validate attribute: has_cmakedefine=\"$(my.c_module.has_cmakedefine?)\"", my)
    endif

    if !defined(my.c_module.has_cmakedefine) & \
                my.restrictions.attr_has_cmakedefine_apply & my.restrictions.attr_has_cmakedefine_required
        echo_fatal_required_attr(my.c_module, "has_cmakedefine")
    endif
    if my.restrictions.attr_has_cmakedefine_apply & defined(my.c_module.has_cmakedefine)
        my.has_cmakedefine_is_valid = "0"
        my.has_cmakedefine_is_valid = my.has_cmakedefine_is_valid | (my.c_module.has_cmakedefine = "0")
        my.has_cmakedefine_is_valid = my.has_cmakedefine_is_valid | (my.c_module.has_cmakedefine = "1")
        if !my.has_cmakedefine_is_valid
            echo_fatal_resticted_attr(my.c_module, "has_cmakedefine", "0, 1")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_alternative_setup_defaults(c_alternative, defaults)
    my.c_alternative_name = defined(my.c_alternative.name) ?? " name=\"$(my.c_alternative.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_alternative))$(my.c_alternative_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    my.default_value = my.defaults.feature ?
    if defined(my.default_value) & !defined(my.c_alternative.feature)
        echo_trace("       feature=\"$(my.default_value:)\"", my)
        my.c_alternative.feature = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_alternative_validate(c_alternative, restrictions)
    my.c_alternative_name = defined(my.c_alternative.name) ?? " name=\"$(my.c_alternative.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_alternative))$(my.c_alternative_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_feature_apply ?= "1"
    my.restrictions.attr_feature_required ?= "0"

    if my.restrictions.attr_feature_apply
        echo_trace("     Validate attribute: feature=\"$(my.c_alternative.feature?)\"", my)
    endif

    if !defined(my.c_alternative.feature) & \
                my.restrictions.attr_feature_apply & my.restrictions.attr_feature_required
        echo_fatal_required_attr(my.c_alternative, "feature")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_alternative_validate_resolved(c_alternative, restrictions)
    my.c_alternative_name = defined(my.c_alternative.name) ?? " name=\"$(my.c_alternative.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_alternative))$(my.c_alternative_name)/>", my)

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_feature_apply ?= "1"
    my.restrictions.attr_feature_required ?= "0"

    if my.restrictions.attr_feature_apply
        echo_trace("     Validate attribute: feature=\"$(my.c_alternative.feature?)\"", my)
    endif

    if !defined(my.c_alternative.feature) & \
                my.restrictions.attr_feature_apply & my.restrictions.attr_feature_required
        echo_fatal_required_attr(my.c_alternative, "feature")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_require_setup_defaults(c_require, defaults)
    my.c_require_name = defined(my.c_require.name) ?? " name=\"$(my.c_require.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_require))$(my.c_require_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for allowed entities
    for my.c_require.c_alternative as _c_alternative
        c_alternative_setup_defaults(_c_alternative)
    endfor

    my.default_value = my.defaults.feature ?
    if defined(my.default_value) & !defined(my.c_require.feature)
        echo_trace("       feature=\"$(my.default_value:)\"", my)
        my.c_require.feature = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_require_validate(c_require, restrictions)
    my.c_require_name = defined(my.c_require.name) ?? " name=\"$(my.c_require.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_require))$(my.c_require_name)/>", my)

    #    Check allowed entities
    my.c_alternative_count = count(my.c_require.c_alternative)
    for my.c_require.c_alternative as _c_alternative
        new restrictions
            c_alternative_validate(_c_alternative, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_feature_apply ?= "1"
    my.restrictions.attr_feature_required ?= "0"

    if my.restrictions.attr_feature_apply
        echo_trace("     Validate attribute: feature=\"$(my.c_require.feature?)\"", my)
    endif

    if !defined(my.c_require.feature) & \
                my.restrictions.attr_feature_apply & my.restrictions.attr_feature_required
        echo_fatal_required_attr(my.c_require, "feature")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_require_validate_resolved(c_require, restrictions)
    my.c_require_name = defined(my.c_require.name) ?? " name=\"$(my.c_require.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_require))$(my.c_require_name)/>", my)

    #    Check allowed entities
    for my.c_require.c_alternative as _c_alternative
        new restrictions
            c_alternative_validate_resolved(_c_alternative, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_feature_apply ?= "1"
    my.restrictions.attr_feature_required ?= "0"

    if my.restrictions.attr_feature_apply
        echo_trace("     Validate attribute: feature=\"$(my.c_require.feature?)\"", my)
    endif

    if !defined(my.c_require.feature) & \
                my.restrictions.attr_feature_apply & my.restrictions.attr_feature_required
        echo_fatal_required_attr(my.c_require, "feature")
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_feature_setup_defaults(c_feature, defaults)
    my.c_feature_name = defined(my.c_feature.name) ?? " name=\"$(my.c_feature.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_feature))$(my.c_feature_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for inherited attributes and entities
    uid_setup_defaults(my.c_feature, my.defaults)

    #    Setup defaults for allowed entities
    for my.c_feature.c_require as _c_require
        c_require_setup_defaults(_c_require)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_feature.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_feature.name = my.default_value
    endif

    my.default_value = my.defaults.default ? "on"
    if defined(my.default_value) & !defined(my.c_feature.default)
        echo_trace("       default=\"$(my.default_value:)\"", my)
        my.c_feature.default = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_feature_validate(c_feature, restrictions)
    my.c_feature_name = defined(my.c_feature.name) ?? " name=\"$(my.c_feature.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_feature))$(my.c_feature_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate(my.c_feature, restrictions)
    endnew

    #    Check allowed entities
    my.c_require_count = count(my.c_feature.c_require)
    for my.c_feature.c_require as _c_require
        new restrictions
            c_require_validate(_c_require, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "0"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_feature.name?)\"", my)
    endif

    if !defined(my.c_feature.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_feature, "name")
    endif

    my.restrictions.attr_default_apply ?= "1"
    my.restrictions.attr_default_required ?= "0"

    if my.restrictions.attr_default_apply
        echo_trace("     Validate attribute: default=\"$(my.c_feature.default?)\"", my)
    endif

    if !defined(my.c_feature.default) & \
                my.restrictions.attr_default_apply & my.restrictions.attr_default_required
        echo_fatal_required_attr(my.c_feature, "default")
    endif
    if my.restrictions.attr_default_apply & defined(my.c_feature.default)
        my.default_is_valid = "0"
        my.default_is_valid = my.default_is_valid | (my.c_feature.default = "on")
        my.default_is_valid = my.default_is_valid | (my.c_feature.default = "off")
        if !my.default_is_valid
            echo_fatal_resticted_attr(my.c_feature, "default", "on, off")
        endif
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_feature_validate_resolved(c_feature, restrictions)
    my.c_feature_name = defined(my.c_feature.name) ?? " name=\"$(my.c_feature.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_feature))$(my.c_feature_name)/>", my)

    #    Check inherited attributes and entities
    new restrictions
        uid_validate_resolved(my.c_feature, restrictions)
    endnew

    #    Check allowed entities
    for my.c_feature.c_require as _c_require
        new restrictions
            c_require_validate_resolved(_c_require, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "0"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_feature.name?)\"", my)
    endif

    if !defined(my.c_feature.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_feature, "name")
    endif

    my.restrictions.attr_default_apply ?= "1"
    my.restrictions.attr_default_required ?= "0"

    if my.restrictions.attr_default_apply
        echo_trace("     Validate attribute: default=\"$(my.c_feature.default?)\"", my)
    endif

    if !defined(my.c_feature.default) & \
                my.restrictions.attr_default_apply & my.restrictions.attr_default_required
        echo_fatal_required_attr(my.c_feature, "default")
    endif
    if my.restrictions.attr_default_apply & defined(my.c_feature.default)
        my.default_is_valid = "0"
        my.default_is_valid = my.default_is_valid | (my.c_feature.default = "on")
        my.default_is_valid = my.default_is_valid | (my.c_feature.default = "off")
        if !my.default_is_valid
            echo_fatal_resticted_attr(my.c_feature, "default", "on, off")
        endif
    endif

   delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_features_setup_defaults(c_features, defaults)
    my.c_features_name = defined(my.c_features.name) ?? " name=\"$(my.c_features.name)\"" ? ""
    echo_trace("[L1] Setup defaults for entity: <$(name(my.c_features))$(my.c_features_name)/>", my)

    #    Defaults should be also inherited.
    if !defined(my.defaults)
        my.defaults = XML.new("defaults")
        my.is_local_defaults = "1"
    endif

    #    Setup defaults for allowed entities
    for my.c_features.c_feature as _c_feature
        c_feature_setup_defaults(_c_feature)
    endfor

    my.default_value = my.defaults.name ?
    if defined(my.default_value) & !defined(my.c_features.name)
        echo_trace("       name=\"$(my.default_value:)\"", my)
        my.c_features.name = my.default_value
    endif

    my.default_value = my.defaults.source ?
    if defined(my.default_value) & !defined(my.c_features.source)
        echo_trace("       source=\"$(my.default_value:)\"", my)
        my.c_features.source = my.default_value
    endif

    my.default_value = my.defaults.path ?
    if defined(my.default_value) & !defined(my.c_features.path)
        echo_trace("       path=\"$(my.default_value:)\"", my)
        my.c_features.path = my.default_value
    endif

    #   Cleanup
    if is_true(my.is_local_defaults)
        delete my.defaults
    endif
endfunction

# ---------------------------------------------------------------------------
function c_features_validate(c_features, restrictions)
    my.c_features_name = defined(my.c_features.name) ?? " name=\"$(my.c_features.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_features))$(my.c_features_name)/>", my)

    #    Check allowed entities
    my.c_feature_count = count(my.c_features.c_feature)
    for my.c_features.c_feature as _c_feature
        new restrictions
            c_feature_validate(_c_feature, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_features.name?)\"", my)
    endif

    if !defined(my.c_features.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_features, "name")
    endif

    my.restrictions.attr_source_apply ?= "1"
    my.restrictions.attr_source_required ?= "1"

    if my.restrictions.attr_source_apply
        echo_trace("     Validate attribute: source=\"$(my.c_features.source?)\"", my)
    endif

    if !defined(my.c_features.source) & \
                my.restrictions.attr_source_apply & my.restrictions.attr_source_required
        echo_fatal_required_attr(my.c_features, "source")
    endif
    if my.restrictions.attr_source_apply & defined(my.c_features.source)
        my.source_is_valid = "0"
        my.source_is_valid = my.source_is_valid | (my.c_features.source = "project")
        my.source_is_valid = my.source_is_valid | (my.c_features.source = "library")
        if !my.source_is_valid
            echo_fatal_resticted_attr(my.c_features, "source", "project, library")
        endif
    endif

    my.restrictions.attr_path_apply ?= "1"
    my.restrictions.attr_path_required ?= "1"

    if my.restrictions.attr_path_apply
        echo_trace("     Validate attribute: path=\"$(my.c_features.path?)\"", my)
    endif

    if !defined(my.c_features.path) & \
                my.restrictions.attr_path_apply & my.restrictions.attr_path_required
        echo_fatal_required_attr(my.c_features, "path")
    endif

    delete my.restrictions
endfunction

# ---------------------------------------------------------------------------
function c_features_validate_resolved(c_features, restrictions)
    my.c_features_name = defined(my.c_features.name) ?? " name=\"$(my.c_features.name)\"" ? ""
    echo_trace("[L1] Validate entity: <$(name(my.c_features))$(my.c_features_name)/>", my)

    #    Check allowed entities
    for my.c_features.c_feature as _c_feature
        new restrictions
            c_feature_validate_resolved(_c_feature, restrictions)
        endnew
    endfor

    my.restrictions ?= XML.new("restrictions")

    my.restrictions.attr_name_apply ?= "1"
    my.restrictions.attr_name_required ?= "1"

    if my.restrictions.attr_name_apply
        echo_trace("     Validate attribute: name=\"$(my.c_features.name?)\"", my)
    endif

    if !defined(my.c_features.name) & \
                my.restrictions.attr_name_apply & my.restrictions.attr_name_required
        echo_fatal_required_attr(my.c_features, "name")
    endif

    my.restrictions.attr_source_apply ?= "1"
    my.restrictions.attr_source_required ?= "1"

    if my.restrictions.attr_source_apply
        echo_trace("     Validate attribute: source=\"$(my.c_features.source?)\"", my)
    endif

    if !defined(my.c_features.source) & \
                my.restrictions.attr_source_apply & my.restrictions.attr_source_required
        echo_fatal_required_attr(my.c_features, "source")
    endif
    if my.restrictions.attr_source_apply & defined(my.c_features.source)
        my.source_is_valid = "0"
        my.source_is_valid = my.source_is_valid | (my.c_features.source = "project")
        my.source_is_valid = my.source_is_valid | (my.c_features.source = "library")
        if !my.source_is_valid
            echo_fatal_resticted_attr(my.c_features, "source", "project, library")
        endif
    endif

    my.restrictions.attr_path_apply ?= "1"
    my.restrictions.attr_path_required ?= "1"

    if my.restrictions.attr_path_apply
        echo_trace("     Validate attribute: path=\"$(my.c_features.path?)\"", my)
    endif

    if !defined(my.c_features.path) & \
                my.restrictions.attr_path_apply & my.restrictions.attr_path_required
        echo_fatal_required_attr(my.c_features, "path")
    endif

   delete my.restrictions
endfunction
